<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Sentinela STP - Auditoria de Frota</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Leaflet Assets -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet MarkerCluster Assets -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        :root { --sat: env(safe-area-inset-top, 0px); --sab: env(safe-area-inset-bottom, 0px); }
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        
        /* Nav Bar Styles */
        .nav-link.active { color: #1d4ed8; }
        .nav-link.active i { color: #1d4ed8; fill: #dbeafe; }
        main { padding-bottom: calc(5rem + var(--sab)); }

        #map { 
            height: 500px; 
            width: 100%; 
            border-radius: 1.5rem; 
            z-index: 1; 
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .critical-row { background-color: #fff1f2; }
        .breakdown-row { background-color: #fff7ed; }
        .delay-row { background-color: #faf5ff; }
        
        .filter-btn-active {
            background-color: #1d4ed8 !important;
            color: white !important;
            border-color: #1d4ed8 !important;
        }

        /* Customização da Popup do Leaflet */
        .leaflet-popup-content-wrapper {
            border-radius: 1.5rem;
            padding: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .leaflet-popup-tip { background: white; }

        .story-badge { 
            background-color: #fefce8; 
            border: 1px solid #fde047; 
            padding: 8px; 
            border-radius: 12px; 
            font-size: 11px; 
            font-style: italic; 
            color: #854d0e; 
            margin-top: 8px;
            line-height: 1.4;
        }

        /* Estilo Balão de HQ (Comic Bubble) */
        .custom-div-icon { background: transparent; border: none; }
        .comic-container { position: relative; width: 0; height: 0; overflow: visible; }
        .comic-bus { 
            font-size: 24px; 
            position: absolute; 
            left: -12px; 
            top: -12px; 
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
            animation: bounce 2s infinite;
        }
        .comic-bubble {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 2px solid #1e293b;
            border-radius: 12px;
            padding: 6px 10px;
            width: 140px;
            font-size: 10px;
            font-weight: 800;
            color: #1e293b;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.2);
            z-index: 50;
            text-align: center;
            line-height: 1.2;
            text-transform: uppercase;
        }
        .comic-bubble::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 6px 6px 0;
            border-style: solid;
            border-color: #1e293b transparent transparent transparent;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
    </style>
</head>
<body class="min-h-screen pb-12">

    <!-- Header -->
    <header class="bg-blue-700 text-white p-6 shadow-xl sticky top-0 z-[100]">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-white/10 p-2 rounded-xl text-white backdrop-blur-sm">
                    <i data-lucide="activity"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black tracking-tighter uppercase">Sentinela STP</h1>
                    <p class="text-[10px] font-bold opacity-75 uppercase tracking-widest">Painel de Auditoria de Saúde e Mobilidade</p>
                </div>
            </div>
            <div id="sync-status" class="flex items-center gap-2 bg-blue-800/50 px-4 py-2 rounded-full border border-blue-400/30 text-[10px] font-black uppercase tracking-widest">
                <span class="w-2 h-2 rounded-full bg-orange-400 animate-pulse"></span> Sincronizando...
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-8 space-y-6">
        
        <!-- Barra de Filtros -->
        <section class="bg-white p-4 rounded-[2rem] shadow-sm border border-slate-200 flex flex-wrap items-center justify-between gap-4">
            <div class="flex flex-wrap items-center gap-2">
                <span class="text-[10px] font-black text-slate-400 uppercase mr-2 flex items-center gap-1">
                    <i data-lucide="calendar"></i> Filtrar Período:
                </span>
                <button onclick="setPeriodFilter('hoje')" id="filter-hoje" class="px-4 py-2 rounded-xl text-[10px] font-black uppercase border border-slate-100 bg-slate-50 hover:bg-slate-100 transition-all">Hoje</button>
                <button onclick="setPeriodFilter('semana')" id="filter-semana" class="px-4 py-2 rounded-xl text-[10px] font-black uppercase border border-slate-100 bg-slate-50 hover:bg-slate-100 transition-all">Semana</button>
                <button onclick="setPeriodFilter('mes')" id="filter-mes" class="px-4 py-2 rounded-xl text-[10px] font-black uppercase border border-slate-100 bg-slate-50 hover:bg-slate-100 transition-all">Mês</button>
                <button onclick="setPeriodFilter('todos')" id="filter-todos" class="filter-btn-active px-4 py-2 rounded-xl text-[10px] font-black uppercase border border-slate-100 bg-slate-50 hover:bg-slate-100 transition-all">Todo o Período</button>
            </div>
        </section>

        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-200">
                <p class="text-[10px] font-black text-slate-400 uppercase">Total</p>
                <h3 id="stat-total" class="text-3xl font-black text-slate-800">0</h3>
            </div>
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-l-4 border-l-orange-500">
                <p class="text-[10px] font-black text-slate-400 uppercase">Quebras</p>
                <h3 id="stat-breakdowns" class="text-3xl font-black text-orange-600">0</h3>
            </div>
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-l-4 border-l-purple-500">
                <p class="text-[10px] font-black text-slate-400 uppercase">Atrasos</p>
                <h3 id="stat-delays" class="text-3xl font-black text-purple-600">0</h3>
            </div>
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-l-4 border-l-yellow-500">
                <p class="text-[10px] font-black text-slate-400 uppercase">Lotação</p>
                <h3 id="stat-crowd" class="text-3xl font-black text-yellow-600">0</h3>
            </div>
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-l-4 border-l-red-500">
                <p class="text-[10px] font-black text-slate-400 uppercase">Ruído Crítico</p>
                <h3 id="stat-critical" class="text-3xl font-black text-red-600">0</h3>
            </div>
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-l-4 border-l-blue-500">
                <p class="text-[10px] font-black text-slate-400 uppercase">Frota</p>
                <h3 id="stat-buses" class="text-3xl font-black text-blue-700">0</h3>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-4">
                <div class="bg-white p-4 rounded-[2rem] shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center px-2 pb-3">
                        <h2 class="text-sm font-black text-slate-800 uppercase flex items-center gap-2">
                            <i data-lucide="map-pinned" class="text-blue-600"></i> Mapa de Incidências Sanitárias
                        </h2>
                    </div>
                    <div id="map"></div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-200 flex flex-col max-h-[580px]">
                <h2 class="text-sm font-black text-slate-800 uppercase flex items-center gap-2 mb-4">
                    <i data-lucide="alert-octagon" class="text-red-600"></i> Hall da Vergonha
                </h2>
                <div id="ranking-list" class="space-y-3 flex-1 overflow-y-auto pr-2 no-scrollbar text-left">
                </div>
            </div>
        </div>

        <!-- Tabela -->
        <div class="bg-white rounded-[2rem] shadow-sm border border-slate-200 overflow-hidden text-left">
            <div class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-50/50">
                <h2 class="text-sm font-black text-slate-800 uppercase">Logs de Auditoria Cidadã</h2>
                <input type="text" id="table-search" placeholder="Buscar por linha ou veículo..." 
                    class="text-xs border border-slate-200 rounded-xl px-4 py-2 md:w-80 outline-none focus:ring-2 focus:ring-blue-600">
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-xs">
                    <thead class="bg-slate-50 text-[10px] font-black uppercase text-slate-400 border-b">
                        <tr>
                            <th class="px-6 py-4">Data/Hora</th>
                            <th class="px-6 py-4">Evento</th>
                            <th class="px-6 py-4">Veículo/Linha</th>
                            <th class="px-6 py-4">Métricas</th>
                            <th class="px-6 py-4">Relato de Impacto</th>
                            <th class="px-6 py-4 text-right">Auditoria</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100 font-medium text-slate-700">
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Image Preview Modal -->
    <div id="image-modal" class="fixed inset-0 z-[9999] hidden bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeImageModal()">
        <div class="relative max-w-4xl w-full max-h-[90vh] flex flex-col items-center">
            <button onclick="closeImageModal()" class="absolute -top-12 right-0 text-white hover:text-slate-300 transition-colors p-2">
                <i data-lucide="x" size="32"></i>
            </button>
            <img id="modal-img" src="" alt="Evidência em tela cheia" class="max-w-full max-h-[85vh] object-contain rounded-lg shadow-2xl border border-white/10">
            <p class="text-white/50 text-xs mt-4 font-mono uppercase tracking-widest">Toque em qualquer lugar para fechar</p>
        </div>
    </div>

    <!-- Nav Bar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 py-2 px-2 pb-[calc(0.5rem+var(--sab))] z-50">
        <div class="flex justify-between items-center w-full max-w-md mx-auto">
            <a href="index.html" class="nav-link flex flex-col items-center gap-1 text-slate-300 hover:text-slate-500 transition-colors p-2">
                <i data-lucide="home" size="20"></i>
                <span class="text-[9px] font-black uppercase">Início</span>
            </a>
            <a href="feed.html" class="nav-link flex flex-col items-center gap-1 text-slate-300 hover:text-slate-500 transition-colors p-2">
                <i data-lucide="message-square" size="20"></i>
                <span class="text-[9px] font-black uppercase">Feed</span>
            </a>
            <a href="painel.html" class="nav-link active flex flex-col items-center gap-1 text-blue-600 transition-colors p-2 rounded-xl bg-blue-50">
                <i data-lucide="bar-chart" size="20" class="fill-current"></i>
                <span class="text-[9px] font-black uppercase">Painel</span>
            </a>
            <a href="ferramentas.html" class="nav-link flex flex-col items-center gap-1 text-slate-300 hover:text-slate-500 transition-colors p-2">
                <i data-lucide="calculator" size="20"></i>
                <span class="text-[9px] font-black uppercase">Ferramentas</span>
            </a>
            <a href="dossie.html" class="nav-link flex flex-col items-center gap-1 text-slate-300 hover:text-slate-500 transition-colors p-2">
                <i data-lucide="book-open" size="20"></i>
                <span class="text-[9px] font-black uppercase">Dossiê</span>
            </a>
            <a href="landpage.html" class="nav-link flex flex-col items-center gap-1 text-slate-300 hover:text-slate-500 transition-colors p-2">
                <i data-lucide="info" size="20"></i>
                <span class="text-[9px] font-black uppercase">Sobre</span>
            </a>
        </div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, limit, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose functions to global scope
        window.openImageModal = (src) => {
            const modal = document.getElementById('image-modal');
            const img = document.getElementById('modal-img');
            img.src = src;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden';
        };

        window.closeImageModal = () => {
            const modal = document.getElementById('image-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = '';
            setTimeout(() => { document.getElementById('modal-img').src = ''; }, 200);
        };

        const firebaseConfig = {
          apiKey: "AIzaSyBwXw-f03A0mEfw3-RHc5A-1paido_ZDhM",
          authDomain: "sentinela-stp.firebaseapp.com",
          projectId: "sentinela-stp",
          storageBucket: "sentinela-stp.firebasestorage.app",
          messagingSenderId: "845865605498",
          appId: "1:845865605498:web:f4823825b7114d08dcdec3",
          measurementId: "G-6DT4QG0RVT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'sentinela-stp';

        const map = L.map('map').setView([-27.5945, -48.5477], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        const markersGroup = L.markerClusterGroup({
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
            maxClusterRadius: 40
        });
        map.addLayer(markersGroup);

        // Spiderfy on hover
        markersGroup.on('clustermouseover', a => a.layer.spiderfy());

        let allLogs = [];
        let currentPeriod = 'todos';

        signInAnonymously(auth).then(() => {
            const syncStatus = document.getElementById('sync-status');
            syncStatus.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Online';
            
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'evidencias'), limit(1000));
            onSnapshot(q, (snapshot) => {
                allLogs = [];
                snapshot.forEach(doc => allLogs.push({ id: doc.id, ...doc.data() }));
                renderDashboard();
            });
        });

        window.setPeriodFilter = (period) => {
            currentPeriod = period;
            document.querySelectorAll('button[id^="filter-"]').forEach(btn => btn.classList.remove('filter-btn-active'));
            document.getElementById(`filter-${period}`).classList.add('filter-btn-active');
            renderDashboard();
        };

        function renderDashboard() {
            const tableBody = document.getElementById('table-body');
            const rankingList = document.getElementById('ranking-list');
            
            markersGroup.clearLayers();
            tableBody.innerHTML = '';
            rankingList.innerHTML = '';

            const busRegistry = {};
            let totals = { total: 0, breakdowns: 0, delays: 0, crowd: 0, criticalNoise: 0 };

            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const startOfWeek = new Date(now); startOfWeek.setDate(now.getDate() - 7);
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            const filteredLogs = allLogs.filter(log => {
                const logDate = new Date(log.data.split('/').reverse().join('-') + 'T00:00:00');
                if (currentPeriod === 'hoje') return logDate >= startOfDay;
                if (currentPeriod === 'semana') return logDate >= startOfWeek;
                if (currentPeriod === 'mes') return logDate >= startOfMonth;
                return true;
            }).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

            filteredLogs.forEach(log => {
                totals.total++;
                const dbValue = parseInt(log.ruido_db) || 0;
                const type = log.tipo_evento || "Ruído Elevado";
                const prefixo = log.prefixo || "S/N";

                if (type === "Quebra de Veículo") totals.breakdowns++;
                if (type === "Atraso Crítico") totals.delays++;
                if (type === "Lotação Excessiva") totals.crowd++;
                if (dbValue >= 85) totals.criticalNoise++;

                if (!busRegistry[prefixo]) {
                    busRegistry[prefixo] = { count: 0, noiseSum: 0, breakCount: 0, delaySum: 0, line: log.linha };
                }
                busRegistry[prefixo].count++;
                busRegistry[prefixo].noiseSum += dbValue;
                if (type === "Quebra de Veículo") busRegistry[prefixo].breakCount++;
                if (type === "Atraso Crítico") busRegistry[prefixo].delaySum++;

                // Lógica de Marcador e DETALHAMENTO (Popup)
                if (log.coordenadas && log.coordenadas.includes(',')) {
                    const coords = log.coordenadas.split(',').map(c => parseFloat(c.trim()));
                    if (!isNaN(coords[0])) {
                        let marker;
                        
                        // Helper para gerar SVG de ícones Lucide
                        const getIcon = (name, attrs) => {
                            if (lucide.icons[name]) {
                                return lucide.createElement(lucide.icons[name], attrs).outerHTML;
                            }
                            return '';
                        };

                        let iconSvg = "";
                        let bgColor = "bg-blue-500";
                        
                        // Determinar Ícone e Cor baseados no Tipo
                        if (type === "Quebra de Veículo") {
                            bgColor = "bg-orange-500";
                            iconSvg = getIcon("Bus", { class: "w-4 h-4 text-white", "stroke-width": 3 });
                            iconSvg += `<div class="absolute -bottom-1 -right-1 bg-white rounded-full p-[1px]">${getIcon("Wrench", { class: "w-2 h-2 text-orange-600", "stroke-width": 3 })}</div>`;
                        } 
                        else if (type === "Atraso Crítico") {
                            bgColor = "bg-purple-600";
                            iconSvg = getIcon("Clock", { class: "w-4 h-4 text-white", "stroke-width": 3 });
                            iconSvg += `<div class="absolute -bottom-1 -right-1 bg-white rounded-full p-[1px]">${getIcon("AlertCircle", { class: "w-2 h-2 text-purple-600", "stroke-width": 3 })}</div>`;
                        } 
                        else if (type === "Lotação Excessiva") {
                            bgColor = "bg-yellow-500";
                            iconSvg = getIcon("Users", { class: "w-4 h-4 text-slate-900", "stroke-width": 3 });
                        } 
                        else if (dbValue >= 85) { // Ruído Elevado
                            bgColor = "bg-red-600 animate-pulse";
                            iconSvg = getIcon("Volume2", { class: "w-4 h-4 text-white", "stroke-width": 3 });
                        }
                        else {
                            // Fallback Normal ou Relato genérico
                            if (log.relato_pessoal) {
                                // Se for apenas um relato sem tipo crítico, usa ícone de mensagem
                                bgColor = "bg-blue-500";
                                iconSvg = getIcon("MessageCircle", { class: "w-4 h-4 text-white", "stroke-width": 3 });
                            } else {
                                iconSvg = getIcon("Info", { class: "w-4 h-4 text-white", "stroke-width": 3 });
                            }
                        }

                        // Construção do HTML do Marcador
                        // Se tiver relato, adiciona o balão de HQ sobre o ícone
                        let markerHtml = "";
                        
                        if (log.relato_pessoal) {
                            const shortText = log.relato_pessoal.length > 20 ? log.relato_pessoal.substring(0, 20) + '...' : log.relato_pessoal;
                            markerHtml = `
                                <div class="relative w-0 h-0 overflow-visible">
                                    <div class="comic-bubble" style="bottom: 36px; white-space: nowrap; width: auto; min-width: 100px; max-width: 160px;">${shortText}</div>
                                    <div class="${bgColor} w-8 h-8 rounded-full flex items-center justify-center shadow-md border-2 border-white absolute -left-4 -top-4 transition-transform hover:scale-110 z-10">
                                        ${iconSvg}
                                    </div>
                                </div>
                            `;
                        } else {
                            markerHtml = `
                                <div class="${bgColor} w-8 h-8 rounded-full flex items-center justify-center shadow-md border-2 border-white relative transition-transform hover:scale-110">
                                    ${iconSvg}
                                </div>
                            `;
                        }

                        const customMarker = L.divIcon({
                            className: 'custom-marker-icon',
                            html: markerHtml,
                            iconSize: [32, 32],
                            iconAnchor: [16, 16]
                        });

                        marker = L.marker([coords[0], coords[1]], { icon: customMarker });

                        // CONTEÚDO DO DETALHAMENTO AO CLICAR
                        const popupContent = `
                            <div class="p-2 min-w-[200px]">
                                <p class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-1">${type}</p>
                                <h4 class="text-sm font-black text-slate-800 mb-2">#${prefixo} - ${log.linha}</h4>
                                <div class="grid grid-cols-2 gap-2 mb-3">
                                    <div class="bg-slate-50 p-2 rounded-lg text-center">
                                        <p class="text-[9px] font-bold text-slate-400 uppercase">Ruído</p>
                                        <p class="text-sm font-black ${dbValue >= 85 ? 'text-red-600' : 'text-slate-700'}">${dbValue}dB</p>
                                    </div>
                                    <div class="bg-slate-50 p-2 rounded-lg text-center">
                                        <p class="text-[9px] font-bold text-slate-400 uppercase">Temp.</p>
                                        <p class="text-sm font-black text-blue-600">${log.temp_interna}°C</p>
                                    </div>
                                </div>
                                ${log.sintomas ? `
                                    <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Sintomas:</p>
                                    <p class="text-[10px] font-bold text-blue-700 bg-blue-50 px-2 py-1 rounded-md mb-2 inline-block">${log.sintomas}</p>
                                ` : ''}
                                ${log.relato_pessoal ? `
                                    <div class="story-badge">
                                        <i data-lucide="quote" class="inline-block w-3 h-3 mb-1"></i>
                                        "${log.relato_pessoal}"
                                    </div>
                                ` : ''}
                                ${log.foto_evidencia ? `
                                    <div class="mt-2 rounded-lg overflow-hidden border border-slate-200 relative group cursor-pointer" onclick="openImageModal('${log.foto_evidencia}')">
                                        <img src="${log.foto_evidencia}" class="w-full h-32 object-cover transition-transform group-hover:scale-105" alt="Evidência">
                                        <div class="absolute inset-0 bg-black/20 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                            <i data-lucide="maximize-2" class="text-white w-6 h-6 drop-shadow-md"></i>
                                        </div>
                                    </div>
                                ` : ''}
                                <p class="text-[9px] text-slate-300 mt-3 text-right">${log.data} às ${log.hora}</p>
                            </div>
                        `;

                        marker.bindPopup(popupContent);
                        markersGroup.addLayer(marker);
                    }
                }

                // Linha da Tabela
                const row = document.createElement('tr');
                let rowClass = dbValue >= 85 ? "critical-row" : (type === "Quebra de Veículo" ? "breakdown-row" : (type === "Atraso Crítico" ? "delay-row" : ""));
                row.className = rowClass;
                row.innerHTML = `
                    <td class="px-6 py-4 text-slate-400">${log.data}<br><span class="text-[10px] font-bold">${log.hora}</span></td>
                    <td class="px-6 py-4 font-black uppercase text-[10px] tracking-tighter text-slate-600">${type}</td>
                    <td class="px-6 py-4"><span class="font-black text-slate-800">#${prefixo}</span><br><span class="opacity-50">${log.linha}</span></td>
                    <td class="px-6 py-4"><span class="${dbValue >= 85 ? 'text-red-600 font-bold' : ''}">${dbValue}dB</span> | ${log.temp_interna}°C</td>
                    <td class="px-6 py-4">
                        ${log.relato_pessoal ? `<div class="story-badge">${log.relato_pessoal}</div>` : `<span class="opacity-20 italic">Sem relato</span>`}
                        <div class="text-[9px] mt-1 text-blue-600 font-black uppercase">${log.sintomas || ''}</div>
                    </td>
                    <td class="px-6 py-4 text-right opacity-30 font-mono">${log.audit?.deviceId?.substring(0,6) || '---'}</td>
                `;
                tableBody.appendChild(row);
            });

            // Ranking
            Object.entries(busRegistry)
                .map(([id, stats]) => ({ id, ...stats, score: (stats.count) + (stats.breakCount * 5) + (stats.delaySum * 2) }))
                .sort((a, b) => b.score - a.score)
                .slice(0, 8).forEach((bus, index) => {
                    const item = document.createElement('div');
                    item.className = "bg-slate-50 p-4 rounded-2xl border border-slate-100 flex justify-between items-center";
                    item.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="text-xs font-black text-slate-300">#${index+1}</span>
                            <div class="text-left">
                                <p class="text-sm font-black text-slate-800">V: ${bus.id}</p>
                                <p class="text-[9px] font-bold text-slate-400 uppercase truncate max-w-[120px]">${bus.line}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-xs font-black text-red-600">${bus.score} pts</span>
                        </div>
                    `;
                    rankingList.appendChild(item);
                });

            document.getElementById('stat-total').innerText = totals.total;
            document.getElementById('stat-breakdowns').innerText = totals.breakdowns;
            document.getElementById('stat-delays').innerText = totals.delays;
            document.getElementById('stat-crowd').innerText = totals.crowd;
            document.getElementById('stat-critical').innerText = totals.criticalNoise;
            document.getElementById('stat-buses').innerText = Object.keys(busRegistry).length;

            lucide.createIcons();
        }

        document.getElementById('table-search').oninput = function(e) {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('#table-body tr').forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none';
            });
        };
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });
    </script>
    <script src="version-display.js"></script>
</body>
</html>