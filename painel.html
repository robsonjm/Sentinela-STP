<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Sentinela STP - Mapa do Adoecimento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        #map { height: 500px; width: 100%; border-radius: 1.5rem; z-index: 1; }
        .custom-popup .leaflet-popup-content-wrapper {
            border-radius: 1rem;
            padding: 0.5rem;
        }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <!-- Navbar -->
    <nav class="bg-blue-700 text-white p-6 shadow-xl">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-white p-2 rounded-lg text-blue-700">
                    <i data-lucide="layout-dashboard"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-black tracking-tighter">SENTINELA STP</h1>
                    <p class="text-[10px] font-bold opacity-75 uppercase tracking-widest">Painel de Monitoramento de Sa√∫de P√∫blica</p>
                </div>
            </div>
            <div class="flex gap-4 items-center">
                <div id="sync-status" class="flex items-center gap-2 bg-blue-800 px-4 py-2 rounded-full border border-blue-400 text-[10px] font-bold uppercase tracking-widest">
                    <span class="w-2 h-2 rounded-full bg-slate-400 animate-pulse"></span> Sincronizando Dados
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 md:p-8 space-y-8">

        <!-- Resumo de Estat√≠sticas -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="stat-card bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Total de Den√∫ncias</p>
                <h3 id="stat-total" class="text-4xl font-black text-slate-800">0</h3>
            </div>
            <div class="stat-card bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">M√©dia de Ru√≠do</p>
                <h3 id="stat-avg-db" class="text-4xl font-black text-orange-600">0 <span class="text-sm font-bold text-slate-300">dB</span></h3>
            </div>
            <div class="stat-card bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Temp. M√©dia</p>
                <h3 id="stat-avg-temp" class="text-4xl font-black text-blue-600">0 <span class="text-sm font-bold text-slate-300">¬∞C</span></h3>
            </div>
            <div class="stat-card bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Agress√µes Cr√≠ticas</p>
                <h3 id="stat-critical" class="text-4xl font-black text-red-600">0</h3>
            </div>
        </div>

        <!-- √Årea do Mapa -->
        <div class="bg-white p-4 md:p-6 rounded-[2.5rem] shadow-sm border border-slate-200 space-y-4">
            <div class="flex justify-between items-center px-2">
                <h2 class="text-xl font-black text-slate-800 flex items-center gap-2">
                    <i data-lucide="map" class="text-blue-600"></i> Mapa do Adoecimento
                </h2>
                <div class="flex gap-4 text-[10px] font-bold uppercase text-slate-500">
                    <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-green-500"></span> Aceit√°vel</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-orange-500"></span> Elevado</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-red-600"></span> Cr√≠tico</span>
                </div>
            </div>
            <div id="map" class="border border-slate-100"></div>
        </div>

        <!-- Tabela de Ocorr√™ncias Recentes -->
        <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h2 class="text-lg font-black text-slate-800 uppercase tracking-tight">Fluxo de Dados em Tempo Real</h2>
                <button onclick="window.print()" class="text-[10px] font-bold bg-slate-900 text-white px-4 py-2 rounded-xl flex items-center gap-2">
                    <i data-lucide="printer" size="14"></i> GERAR RELAT√ìRIO
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-[10px] font-black uppercase text-slate-400">
                        <tr>
                            <th class="px-6 py-4">Data/Hora</th>
                            <th class="px-6 py-4">Linha</th>
                            <th class="px-6 py-4">Posi√ß√£o</th>
                            <th class="px-6 py-4 text-center">Ru√≠do</th>
                            <th class="px-6 py-4 text-center">Temp.</th>
                            <th class="px-6 py-4">Status</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100 font-medium">
                        <!-- Conte√∫do carregado via JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <footer class="max-w-7xl mx-auto p-8 text-center text-slate-400 text-xs font-medium space-y-2">
        <p>SENTINELA STP - Vigil√¢ncia Popular da Mobilidade Urbana</p>
        <p class="uppercase tracking-widest text-[10px]">Base Legal: CF Art. 196 e Lei Federal 8.080/1990</p>
    </footer>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Firebase Integration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configura√ß√£o do seu projeto
        const firebaseConfig = {
            apiKey: "AIzaSyBwXw-f03A0mEfw3-RHc5A-1paido_ZDhM",
            authDomain: "sentinela-stp.firebaseapp.com",
            projectId: "sentinela-stp",
            storageBucket: "sentinela-stp.firebasestorage.app",
            messagingSenderId: "845865605498",
            appId: "1:845865605498:web:f4823825b7114d08dcdec3",
            measurementId: "G-6DT4QG0RVT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'sentinela-stp';

        // Inicializa√ß√£o do Mapa
        const map = L.map('map').setView([-27.5945, -48.5477], 13); // Coordenadas de Florian√≥polis
        L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const markersGroup = L.layerGroup().addTo(map);

        // Autentica√ß√£o e Sincroniza√ß√£o
        signInAnonymously(auth).then(() => {
            const syncStatus = document.getElementById('sync-status');
            syncStatus.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Conectado √† Base STP';
            
            // Query: Buscar √∫ltimas 100 evid√™ncias
            const q = query(
                collection(db, 'artifacts', appId, 'public', 'data', 'evidencias'),
                limit(100)
            );

            onSnapshot(q, (snapshot) => {
                const data = [];
                snapshot.forEach(doc => data.push(doc.data()));
                updateDashboard(data);
            }, (error) => {
                console.error("Erro na sincroniza√ß√£o:", error);
                syncStatus.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span> Erro de Conex√£o';
            });
        });

        function updateDashboard(data) {
            markersGroup.clearLayers();
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';

            let totalDb = 0;
            let totalTemp = 0;
            let criticalCount = 0;

            // Ordenar por data (em mem√≥ria para respeitar Regra 2)
            const sortedData = [...data].sort((a, b) => {
                const dateA = new Date(a.data.split('/').reverse().join('-') + ' ' + a.hora);
                const dateB = new Date(b.data.split('/').reverse().join('-') + ' ' + b.hora);
                return dateB - dateA;
            });

            sortedData.forEach(item => {
                const db = parseInt(item.ruido_db);
                const temp = parseInt(item.temp_interna);
                totalDb += db;
                totalTemp += temp;
                if (db >= 85) criticalCount++;

                // Processar Coordenadas (Ex: "-27.59, -48.54")
                const coordsArr = item.coordenadas.split(',');
                if (coordsArr.length === 2) {
                    const lat = parseFloat(coordsArr[0].trim());
                    const lng = parseFloat(coordsArr[1].trim());

                    if (!isNaN(lat) && !isNaN(lng)) {
                        const color = db >= 85 ? '#dc2626' : (db >= 75 ? '#f97316' : '#22c55e');
                        
                        const circle = L.circleMarker([lat, lng], {
                            radius: 8,
                            fillColor: color,
                            color: "#fff",
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.8
                        }).addTo(markersGroup);

                        circle.bindPopup(`
                            <div class="custom-popup space-y-1">
                                <p class="text-[10px] font-black uppercase text-slate-400">Evid√™ncia Registrada</p>
                                <p class="text-sm font-black text-slate-800">${item.linha}</p>
                                <div class="flex gap-2 mt-2">
                                    <span class="bg-slate-100 px-2 py-0.5 rounded text-[10px] font-bold">üîä ${db}dB</span>
                                    <span class="bg-slate-100 px-2 py-0.5 rounded text-[10px] font-bold">üå°Ô∏è ${temp}¬∞C</span>
                                </div>
                                <p class="text-[9px] text-slate-400 mt-1">${item.data} √†s ${item.hora}</p>
                            </div>
                        `);
                    }
                }

                // Adicionar na Tabela
                const row = document.createElement('tr');
                const dbClass = db >= 85 ? 'text-red-600 font-black' : (db >= 75 ? 'text-orange-600' : 'text-slate-600');
                
                row.innerHTML = `
                    <td class="px-6 py-4 text-slate-400 text-[11px]">${item.data} <br> ${item.hora}</td>
                    <td class="px-6 py-4 font-black text-slate-800">${item.linha} <span class="text-[9px] text-slate-300 ml-1">#${item.prefixo}</span></td>
                    <td class="px-6 py-4 text-xs uppercase font-bold text-slate-500">${item.zona_interna}</td>
                    <td class="px-6 py-4 text-center ${dbClass}">${db} dB</td>
                    <td class="px-6 py-4 text-center font-bold text-blue-600">${temp}¬∞C</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-full text-[8px] font-black uppercase tracking-tighter ${db >= 85 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}">
                            ${db >= 85 ? 'Agress√£o' : 'Normal'}
                        </span>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Atualizar Estat√≠sticas
            const count = data.length || 1;
            document.getElementById('stat-total').innerText = data.length;
            document.getElementById('stat-avg-db').innerHTML = `${Math.round(totalDb / count)} <span class="text-sm font-bold text-slate-300 uppercase">dB</span>`;
            document.getElementById('stat-avg-temp').innerHTML = `${Math.round(totalTemp / count)} <span class="text-sm font-bold text-slate-300 uppercase">¬∞C</span>`;
            document.getElementById('stat-critical').innerText = criticalCount;

            lucide.createIcons();
        }
    </script>
</body>
</html>