<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Sentinela STP - Auditoria de Frota</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Leaflet Assets -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet MarkerCluster Assets -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        
        #map { 
            height: 500px; 
            width: 100%; 
            border-radius: 1.5rem; 
            z-index: 1; 
        }

        .marker-cluster-small { background-color: rgba(181, 226, 191, 0.6); }
        .marker-cluster-small div { background-color: rgba(110, 204, 57, 0.6); color: white; font-weight: bold; }
        .marker-cluster-medium { background-color: rgba(241, 211, 87, 0.6); }
        .marker-cluster-medium div { background-color: rgba(240, 194, 12, 0.6); color: white; font-weight: bold; }
        .marker-cluster-large { background-color: rgba(253, 156, 115, 0.6); }
        .marker-cluster-large div { background-color: rgba(241, 128, 23, 0.6); color: white; font-weight: bold; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .critical-row { background-color: #fff1f2; }
        .breakdown-row { background-color: #fff7ed; }
        .delay-row { background-color: #faf5ff; }
        
        .stat-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }

        .filter-btn-active {
            background-color: #1d4ed8 !important;
            color: white !important;
            border-color: #1d4ed8 !important;
        }
    </style>
</head>
<body class="min-h-screen pb-12">

    <!-- Header -->
    <nav class="bg-blue-700 text-white p-6 shadow-xl sticky top-0 z-[100]">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-white p-2 rounded-xl text-blue-700">
                    <i data-lucide="activity"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black tracking-tighter uppercase">Sentinela STP</h1>
                    <p class="text-[10px] font-bold opacity-75 uppercase tracking-widest">Painel de Auditoria de Sa√∫de e Mobilidade</p>
                </div>
            </div>
            <div id="sync-status" class="flex items-center gap-2 bg-blue-800/50 px-4 py-2 rounded-full border border-blue-400/30 text-[10px] font-black uppercase tracking-widest">
                <span class="w-2 h-2 rounded-full bg-orange-400 animate-pulse"></span> Sincronizando...
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 md:p-8 space-y-6">
        
        <!-- Barra de Filtros Temporais -->
        <section class="bg-white p-4 rounded-[2rem] shadow-sm border border-slate-200 flex flex-wrap items-center justify-between gap-4">
            <div class="flex flex-wrap items-center gap-2">
                <span class="text-[10px] font-black text-slate-400 uppercase mr-2 flex items-center gap-1">
                    <i data-lucide="calendar"></i> Per√≠odo:
                </span>
                <button onclick="setPeriodFilter('hoje')" id="filter-hoje" class="px-4 py-2 rounded-xl text-[10px] font-black uppercase border border-slate-100 bg-slate-50 hover:bg-slate-100 transition-all">Hoje</button>
                <button onclick="setPeriodFilter('semana')" id="filter-semana" class="px-4 py-2 rounded-xl text-[10px] font-black uppercase border border-slate-100 bg-slate-50 hover:bg-slate-100 transition-all">Semana</button>
                <button onclick="setPeriodFilter('mes')" id="filter-mes" class="px-4 py-2 rounded-xl text-[10px] font-black uppercase border border-slate-100 bg-slate-50 hover:bg-slate-100 transition-all">M√™s</button>
                <button onclick="setPeriodFilter('ano')" id="filter-ano" class="px-4 py-2 rounded-xl text-[10px] font-black uppercase border border-slate-100 bg-slate-50 hover:bg-slate-100 transition-all">Ano</button>
                <button onclick="setPeriodFilter('todos')" id="filter-todos" class="filter-btn-active px-4 py-2 rounded-xl text-[10px] font-black uppercase border border-slate-100 bg-slate-50 hover:bg-slate-100 transition-all">Todo o Per√≠odo</button>
            </div>
            
            <div class="flex items-center gap-2 border-l pl-4 border-slate-100">
                <span class="text-[10px] font-black text-slate-400 uppercase flex items-center gap-1">
                    <i data-lucide="calendar-search"></i> Dia Espec√≠fico:
                </span>
                <input type="date" id="filter-date-picker" onchange="setPeriodFilter('data_especifica')" 
                    class="bg-slate-50 border border-slate-100 rounded-xl px-3 py-1.5 text-[10px] font-bold outline-none focus:ring-2 focus:ring-blue-600 transition-all">
            </div>
        </section>

        <!-- Grid de Estat√≠sticas -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
            <div class="stat-card bg-white p-5 rounded-3xl shadow-sm border border-slate-200">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Total Filtrado</p>
                <h3 id="stat-total" class="text-3xl font-black text-slate-800">0</h3>
            </div>
            <div class="stat-card bg-white p-5 rounded-3xl shadow-sm border border-slate-200 border-l-4 border-l-orange-500">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Ve√≠culos Quebrados</p>
                <h3 id="stat-breakdowns" class="text-3xl font-black text-orange-600">0</h3>
            </div>
            <div class="stat-card bg-white p-5 rounded-3xl shadow-sm border border-slate-200 border-l-4 border-l-purple-500">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Atrasos Cr√≠ticos</p>
                <h3 id="stat-delays" class="text-3xl font-black text-purple-600">0</h3>
            </div>
            <div class="stat-card bg-white p-5 rounded-3xl shadow-sm border border-slate-200 border-l-4 border-l-red-500">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Ru√≠do Cr√≠tico</p>
                <h3 id="stat-critical" class="text-3xl font-black text-red-600">0</h3>
            </div>
            <div class="stat-card bg-white p-5 rounded-3xl shadow-sm border border-slate-200 border-l-4 border-l-blue-500">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">√înibus √önicos</p>
                <h3 id="stat-buses" class="text-3xl font-black text-blue-700">0</h3>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-4">
                <div class="bg-white p-4 rounded-[2rem] shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center px-2 pb-3">
                        <h2 class="text-sm font-black text-slate-800 uppercase flex items-center gap-2">
                            <i data-lucide="map-pinned" class="text-blue-600"></i> Mapa de Incid√™ncias
                        </h2>
                        <p class="text-[9px] font-bold text-slate-400 uppercase">Grupos expandem ao passar o mouse</p>
                    </div>
                    <div id="map"></div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-200 flex flex-col max-h-[580px]">
                <div class="mb-4 text-center">
                    <h2 class="text-sm font-black text-slate-800 uppercase flex items-center justify-center gap-2">
                        <i data-lucide="alert-octagon" class="text-red-600"></i> Hall da Vergonha
                    </h2>
                    <p class="text-[9px] text-slate-400 font-bold uppercase tracking-tighter mt-1">Ranking de reincid√™ncia no per√≠odo</p>
                </div>
                <div id="ranking-list" class="space-y-3 flex-1 overflow-y-auto pr-2 no-scrollbar">
                </div>
                <button onclick="window.print()" class="mt-4 w-full bg-slate-900 text-white text-[10px] font-black uppercase py-3 rounded-xl flex items-center justify-center gap-2 active:scale-95 transition-all">
                    <i data-lucide="file-text" size="14"></i> Exportar Dados do Per√≠odo
                </button>
            </div>
        </div>

        <!-- Tabela -->
        <div class="bg-white rounded-[2rem] shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-50/50">
                <div>
                    <h2 class="text-sm font-black text-slate-800 uppercase">Logs de Auditoria Filtrados</h2>
                </div>
                <div class="relative flex-1 md:w-80">
                    <i data-lucide="search" size="14" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="table-search" placeholder="Filtrar √¥nibus, linha ou sintoma..." 
                        class="w-full text-xs bg-white border border-slate-200 rounded-xl pl-9 pr-4 py-2.5 outline-none focus:ring-2 focus:ring-blue-600 transition-all">
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-xs">
                    <thead class="bg-slate-50 text-[10px] font-black uppercase text-slate-400 border-b border-slate-100">
                        <tr>
                            <th class="px-6 py-4">Data / Hora</th>
                            <th class="px-6 py-4">Evento</th>
                            <th class="px-6 py-4">Prefixo / Linha</th>
                            <th class="px-6 py-4">Ru√≠do / Temp</th>
                            <th class="px-6 py-4">Sintomas</th>
                            <th class="px-6 py-4 text-right">Auditoria</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100 font-medium text-slate-700">
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBwXw-f03A0mEfw3-RHc5A-1paido_ZDhM",
          authDomain: "sentinela-stp.firebaseapp.com",
          projectId: "sentinela-stp",
          storageBucket: "sentinela-stp.firebasestorage.app",
          messagingSenderId: "845865605498",
          appId: "1:845865605498:web:f4823825b7114d08dcdec3",
          measurementId: "G-6DT4QG0RVT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'sentinela-stp';

        const map = L.map('map').setView([-27.5945, -48.5477], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        const markersGroup = L.markerClusterGroup({
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
            maxClusterRadius: 40
        });
        map.addLayer(markersGroup);
        markersGroup.on('clustermouseover', a => a.layer.spiderfy());

        let allLogs = [];
        let currentPeriod = 'todos';

        signInAnonymously(auth).then(() => {
            const syncStatus = document.getElementById('sync-status');
            syncStatus.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Online';
            
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'evidencias'), limit(1000));
            onSnapshot(q, (snapshot) => {
                allLogs = [];
                snapshot.forEach(doc => allLogs.push({ id: doc.id, ...doc.data() }));
                renderDashboard();
            });
        });

        // Fun√ß√£o de filtro temporal (Regra 2: Em mem√≥ria)
        window.setPeriodFilter = (period) => {
            currentPeriod = period;
            document.querySelectorAll('button[id^="filter-"]').forEach(btn => btn.classList.remove('filter-btn-active'));
            if(period !== 'data_especifica') {
                document.getElementById(`filter-${period}`).classList.add('filter-btn-active');
            }
            renderDashboard();
        };

        function renderDashboard() {
            const tableBody = document.getElementById('table-body');
            const rankingList = document.getElementById('ranking-list');
            const datePicker = document.getElementById('filter-date-picker');
            
            markersGroup.clearLayers();
            tableBody.innerHTML = '';
            rankingList.innerHTML = '';

            const busRegistry = {};
            let totals = { total: 0, breakdowns: 0, delays: 0, criticalNoise: 0 };

            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const startOfWeek = new Date(now); startOfWeek.setDate(now.getDate() - 7);
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const startOfYear = new Date(now.getFullYear(), 0, 1);

            // Filtragem
            const filteredLogs = allLogs.filter(log => {
                const logDateStr = log.data.split('/').reverse().join('-'); // "DD/MM/YYYY" -> "YYYY-MM-DD"
                const logDate = new Date(logDateStr + 'T00:00:00');

                if (currentPeriod === 'hoje') return logDate >= startOfDay;
                if (currentPeriod === 'semana') return logDate >= startOfWeek;
                if (currentPeriod === 'mes') return logDate >= startOfMonth;
                if (currentPeriod === 'ano') return logDate >= startOfYear;
                if (currentPeriod === 'data_especifica' && datePicker.value) {
                    return logDateStr === datePicker.value;
                }
                return true; // todos
            }).sort((a, b) => {
                const dateA = a.timestamp?.seconds || 0;
                const dateB = b.timestamp?.seconds || 0;
                return dateB - dateA;
            });

            filteredLogs.forEach(log => {
                totals.total++;
                const dbValue = parseInt(log.ruido_db) || 0;
                const type = log.tipo_evento || "Ru√≠do Elevado";
                const prefixo = log.prefixo || "S/N";

                if (type === "Quebra de Ve√≠culo") totals.breakdowns++;
                if (type === "Atraso Cr√≠tico") totals.delays++;
                if (dbValue >= 85) totals.criticalNoise++;

                if (!busRegistry[prefixo]) {
                    busRegistry[prefixo] = { count: 0, noiseSum: 0, breakCount: 0, delaySum: 0, line: log.linha };
                }
                busRegistry[prefixo].count++;
                busRegistry[prefixo].noiseSum += dbValue;
                if (type === "Quebra de Ve√≠culo") busRegistry[prefixo].breakCount++;
                if (type === "Atraso Cr√≠tico") busRegistry[prefixo].delaySum++;

                if (log.coordenadas) {
                    const coords = log.coordenadas.split(',').map(c => parseFloat(c.trim()));
                    if (!isNaN(coords[0])) {
                        let color = "#3b82f6";
                        if (dbValue >= 85) color = "#dc2626";
                        if (type === "Quebra de Ve√≠culo") color = "#f97316";
                        if (type === "Atraso Cr√≠tico") color = "#a855f7";

                        const marker = L.circleMarker([coords[0], coords[1]], {
                            radius: 8, fillColor: color, color: "#fff", weight: 1.5, fillOpacity: 0.9
                        }).bindPopup(`
                            <div class="text-[11px] font-bold p-1">
                                <p class="text-slate-400 uppercase text-[9px] mb-1 font-black">${type}</p>
                                <p class="text-slate-800 text-sm mb-1">V: ${prefixo} - ${log.linha}</p>
                                <div class="flex gap-2 border-t pt-1 mt-1">
                                    <span class="text-red-600 font-black">üîä ${dbValue}dB</span>
                                    <span class="text-blue-600 font-black">üå°Ô∏è ${log.temp_interna}¬∞C</span>
                                </div>
                            </div>
                        `);
                        markersGroup.addLayer(marker);
                    }
                }

                const row = document.createElement('tr');
                let rowClass = "";
                let typeIcon = "volume-2";
                if (dbValue >= 85) rowClass = "critical-row";
                if (type === "Quebra de Ve√≠culo") { rowClass = "breakdown-row"; typeIcon = "wrench"; }
                if (type === "Atraso Cr√≠tico") { rowClass = "delay-row"; typeIcon = "clock"; }

                row.className = `${rowClass} transition-colors hover:bg-slate-50`;
                row.innerHTML = `
                    <td class="px-6 py-4 text-slate-400 whitespace-nowrap">${log.data}<br><span class="text-[10px] font-bold">${log.hora}</span></td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <i data-lucide="${typeIcon}" size="14" class="opacity-40"></i>
                            <span class="font-black text-[9px] uppercase tracking-tighter">${type}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="font-black text-slate-800">#${prefixo}</span><br>
                        <span class="text-[9px] text-slate-400 font-bold uppercase truncate max-w-[120px] block">${log.linha}</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <span class="${dbValue >= 85 ? 'text-red-600 font-black' : 'text-slate-600'}">${dbValue}dB</span>
                            <span class="text-blue-600 font-bold">${log.temp_interna}¬∞C</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-[10px] italic text-slate-500 leading-tight">${log.sintomas || '--'}</span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <span class="text-[8px] bg-white border border-slate-200 px-2 py-1 rounded-md text-slate-400 font-mono">
                            ${log.audit?.deviceId?.substring(0,8) || 'Anon'}
                        </span>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Ranking Reincid√™ncia
            const sortedRanking = Object.entries(busRegistry)
                .map(([id, stats]) => ({ id, ...stats, score: (stats.count) + (stats.breakCount * 5) + (stats.delaySum * 2) }))
                .sort((a, b) => b.score - a.score);

            sortedRanking.slice(0, 10).forEach((bus, index) => {
                const rankCard = document.createElement('div');
                rankCard.className = "bg-slate-50 p-4 rounded-2xl border border-slate-100 flex justify-between items-center hover:border-blue-200 transition-all";
                rankCard.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-black text-slate-300">#${index + 1}</span>
                        <div>
                            <h4 class="text-sm font-black text-slate-800">V: ${bus.id}</h4>
                            <p class="text-[9px] font-bold text-slate-400 uppercase truncate max-w-[150px]">${bus.line}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="flex gap-2 justify-end mb-1">
                            ${bus.breakCount > 0 ? `<span class="bg-orange-100 text-orange-600 text-[8px] font-black px-1.5 rounded-md">üîß ${bus.breakCount}</span>` : ''}
                            <span class="bg-blue-100 text-blue-600 text-[8px] font-black px-1.5 rounded-md">Œ£ ${bus.count}</span>
                        </div>
                        <p class="text-[10px] font-black text-slate-600">√ò ${Math.round(bus.noiseSum / bus.count)}dB</p>
                    </div>
                `;
                rankingList.appendChild(rankCard);
            });

            document.getElementById('stat-total').innerText = totals.total;
            document.getElementById('stat-breakdowns').innerText = totals.breakdowns;
            document.getElementById('stat-delays').innerText = totals.delays;
            document.getElementById('stat-critical').innerText = totals.criticalNoise;
            document.getElementById('stat-buses').innerText = Object.keys(busRegistry).length;

            lucide.createIcons();
        }

        document.getElementById('table-search').oninput = function(e) {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('#table-body tr').forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none';
            });
        };
    </script>
</body>
</html>