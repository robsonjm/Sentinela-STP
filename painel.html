<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Sentinela STP - Auditoria de Frota</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        #map { height: 500px; width: 100%; border-radius: 1.5rem; z-index: 1; }
        .story-badge { background-color: #fefce8; border: 1px solid #fde047; padding: 4px 8px; border-radius: 8px; font-size: 10px; font-style: italic; color: #854d0e; }
        .filter-btn-active { background-color: #1d4ed8 !important; color: white !important; }
    </style>
</head>
<body class="min-h-screen pb-12">

    <nav class="bg-blue-700 text-white p-6 shadow-xl sticky top-0 z-[100]">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i data-lucide="activity" class="bg-white text-blue-700 p-1.5 rounded-lg"></i>
                <h1 class="text-xl font-black uppercase tracking-tighter">Sentinela STP</h1>
            </div>
            <div id="sync-status" class="text-[10px] font-black uppercase bg-blue-800/50 px-4 py-2 rounded-full border border-blue-400/30">
                Sincronizando...
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 md:p-8 space-y-6">
        
        <!-- Filtros -->
        <section class="bg-white p-4 rounded-[2rem] shadow-sm border border-slate-200 flex flex-wrap gap-2 items-center">
            <span class="text-[10px] font-black text-slate-400 uppercase mr-2">Filtro Temporal:</span>
            <button onclick="setPeriodFilter('hoje')" id="filter-hoje" class="px-4 py-2 rounded-xl text-[10px] font-black uppercase border border-slate-100 hover:bg-slate-50">Hoje</button>
            <button onclick="setPeriodFilter('semana')" id="filter-semana" class="px-4 py-2 rounded-xl text-[10px] font-black uppercase border border-slate-100 hover:bg-slate-50">Semana</button>
            <button onclick="setPeriodFilter('mes')" id="filter-mes" class="px-4 py-2 rounded-xl text-[10px] font-black uppercase border border-slate-100 hover:bg-slate-50">Mês</button>
            <button onclick="setPeriodFilter('todos')" id="filter-todos" class="filter-btn-active px-4 py-2 rounded-xl text-[10px] font-black uppercase border border-slate-100">Tudo</button>
        </section>

        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-200">
                <p class="text-[10px] font-black text-slate-400 uppercase">Total</p>
                <h3 id="stat-total" class="text-3xl font-black">0</h3>
            </div>
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-orange-200 border-l-4 border-l-orange-500">
                <p class="text-[10px] font-black text-slate-400 uppercase">Quebras</p>
                <h3 id="stat-breakdowns" class="text-3xl font-black text-orange-600">0</h3>
            </div>
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-purple-200 border-l-4 border-l-purple-500">
                <p class="text-[10px] font-black text-slate-400 uppercase">Atrasos</p>
                <h3 id="stat-delays" class="text-3xl font-black text-purple-600">0</h3>
            </div>
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-red-200 border-l-4 border-l-red-500">
                <p class="text-[10px] font-black text-slate-400 uppercase">Ruído Crítico</p>
                <h3 id="stat-critical" class="text-3xl font-black text-red-600">0</h3>
            </div>
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-blue-200 border-l-4 border-l-blue-500 hidden lg:block">
                <p class="text-[10px] font-black text-slate-400 uppercase">Ônibus Únicos</p>
                <h3 id="stat-buses" class="text-3xl font-black text-blue-700">0</h3>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 bg-white p-4 rounded-[2rem] shadow-sm border border-slate-200">
                <div id="map"></div>
            </div>

            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-200 flex flex-col">
                <h2 class="text-sm font-black uppercase flex items-center gap-2 mb-4">
                    <i data-lucide="alert-octagon" class="text-red-600"></i> Hall da Vergonha
                </h2>
                <div id="ranking-list" class="space-y-3 flex-1 overflow-y-auto no-scrollbar"></div>
            </div>
        </div>

        <!-- Tabela com Relatos -->
        <div class="bg-white rounded-[2rem] shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-6 border-b bg-slate-50/50 flex justify-between items-center">
                <h2 class="text-sm font-black uppercase">Auditoria Cidadã Detalhada</h2>
                <input type="text" id="table-search" placeholder="Filtrar..." class="text-xs bg-white border rounded-xl px-4 py-2 md:w-64">
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-xs">
                    <thead class="bg-slate-50 text-[10px] font-black uppercase text-slate-400 border-b">
                        <tr>
                            <th class="px-6 py-4">Data</th>
                            <th class="px-6 py-4">Prefixo / Linha</th>
                            <th class="px-6 py-4">Métricas</th>
                            <th class="px-6 py-4">Relato de Impacto</th>
                            <th class="px-6 py-4 text-right">ID</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100 font-medium"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBwXw-f03A0mEfw3-RHc5A-1paido_ZDhM",
          authDomain: "sentinela-stp.firebaseapp.com",
          projectId: "sentinela-stp",
          storageBucket: "sentinela-stp.firebasestorage.app",
          messagingSenderId: "845865605498",
          appId: "1:845865605498:web:f4823825b7114d08dcdec3",
          measurementId: "G-6DT4QG0RVT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const map = L.map('map').setView([-27.5945, -48.5477], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
        const markersGroup = L.markerClusterGroup({ spiderfyOnMaxZoom: true });
        map.addLayer(markersGroup);

        let allLogs = [], currentPeriod = 'todos';

        signInAnonymously(auth).then(() => {
            document.getElementById('sync-status').innerText = "CONECTADO";
            onSnapshot(query(collection(db, 'artifacts', 'sentinela-stp', 'public', 'data', 'evidencias'), limit(1000)), snap => {
                allLogs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderDashboard();
            });
        });

        window.setPeriodFilter = p => {
            currentPeriod = p;
            document.querySelectorAll('button[id^="filter-"]').forEach(b => b.classList.remove('filter-btn-active'));
            document.getElementById(`filter-${p}`).classList.add('filter-btn-active');
            renderDashboard();
        };

        function renderDashboard() {
            const tableBody = document.getElementById('table-body');
            const rankingList = document.getElementById('ranking-list');
            markersGroup.clearLayers(); tableBody.innerHTML = ''; rankingList.innerHTML = '';

            const busStats = {}; let stats = { total:0, break:0, delay:0, crit:0 };
            
            const filtered = allLogs.filter(log => {
                if(currentPeriod === 'todos') return true;
                const d = new Date(log.data.split('/').reverse().join('-'));
                const today = new Date(); today.setHours(0,0,0,0);
                if(currentPeriod === 'hoje') return d >= today;
                if(currentPeriod === 'semana') return d >= new Date(today - 7*24*60*60*1000);
                if(currentPeriod === 'mes') return d >= new Date(today.getFullYear(), today.getMonth(), 1);
                return true;
            }).sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

            filtered.forEach(log => {
                stats.total++;
                const dbVal = parseInt(log.ruido_db) || 0;
                if(log.tipo_evento === "Quebra de Veículo") stats.break++;
                if(log.tipo_evento === "Atraso Crítico") stats.delay++;
                if(dbVal >= 85) stats.crit++;

                if(!busStats[log.prefixo]) busStats[log.prefixo] = { score:0, line: log.linha };
                busStats[log.prefixo].score += (log.tipo_evento !== "Ruído Elevado" ? 5 : 1);

                // Mapa
                if(log.coordenadas && log.coordenadas !== "Calculando...") {
                    const c = log.coordenadas.split(',').map(parseFloat);
                    const color = log.tipo_evento === "Quebra de Veículo" ? "#f97316" : (dbVal >= 85 ? "#dc2626" : "#3b82f6");
                    markersGroup.addLayer(L.circleMarker(c, { radius:8, fillColor:color, color:"#fff", weight:1.5, fillOpacity:0.9 }));
                }

                // Tabela
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 text-slate-400">${log.hora}</td>
                    <td class="px-6 py-4"><span class="font-black">#${log.prefixo}</span><br>${log.linha}</td>
                    <td class="px-6 py-4"><span class="${dbVal >= 85 ? 'text-red-600 font-bold' : ''}">${dbVal}dB</span> | ${log.temp_interna}°C</td>
                    <td class="px-6 py-4">
                        ${log.relato_pessoal ? `<div class="story-badge">${log.relato_pessoal}</div>` : `<span class="opacity-20 italic">Sem relato</span>`}
                        <div class="text-[9px] mt-1 text-blue-600 uppercase font-black">${log.sintomas || ''}</div>
                    </td>
                    <td class="px-6 py-4 text-right opacity-30 font-mono">${log.audit?.deviceId?.substring(0,6) || '---'}</td>
                `;
                tableBody.appendChild(row);
            });

            // Ranking
            Object.entries(busStats).sort((a,b) => b[1].score - a[1].score).slice(0,8).forEach(([id, s]) => {
                const item = document.createElement('div');
                item.className = "bg-slate-50 p-3 rounded-2xl border border-slate-100 flex justify-between";
                item.innerHTML = `<div class="text-[10px] font-black">#${id}<br><span class="opacity-40 uppercase">${s.line}</span></div><div class="text-xs font-black text-red-600">${s.score} pts</div>`;
                rankingList.appendChild(item);
            });

            document.getElementById('stat-total').innerText = stats.total;
            document.getElementById('stat-breakdowns').innerText = stats.break;
            document.getElementById('stat-delays').innerText = stats.delay;
            document.getElementById('stat-critical').innerText = stats.crit;
            document.getElementById('stat-buses').innerText = Object.keys(busStats).length;
            lucide.createIcons();
        }
    </script>
</body>
</html>