<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Sentinela STP - Auditoria de Frota</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        #map { height: 450px; width: 100%; border-radius: 1.5rem; z-index: 1; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .critical-row { background-color: #fef2f2; }
    </style>
</head>
<body class="min-h-screen pb-12">

    <!-- Header -->
    <nav class="bg-blue-700 text-white p-6 shadow-xl sticky top-0 z-[100]">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-white p-2 rounded-xl text-blue-700">
                    <i data-lucide="bar-chart-3"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black tracking-tighter uppercase">Sentinela STP</h1>
                    <p class="text-[10px] font-bold opacity-75 uppercase tracking-widest">Auditoria de Salubridade Urbana</p>
                </div>
            </div>
            <div id="sync-status" class="flex items-center gap-2 bg-blue-800/50 px-4 py-2 rounded-full border border-blue-400/30 text-[10px] font-black uppercase tracking-widest">
                <span class="w-2 h-2 rounded-full bg-orange-400 animate-pulse"></span> Sincronizando Frota...
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 md:p-8 space-y-6">
        
        <!-- Stats Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Evidências Totais</p>
                <h3 id="stat-total" class="text-3xl font-black text-slate-800">0</h3>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 border-l-4 border-l-blue-600">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Ônibus Auditados</p>
                <h3 id="stat-buses" class="text-3xl font-black text-blue-700">0</h3>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Média de Ruído</p>
                <h3 id="stat-db" class="text-3xl font-black text-orange-600">0 <span class="text-sm font-bold opacity-30">dB</span></h3>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 border-l-4 border-l-red-600">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Agressões Graves</p>
                <h3 id="stat-critical" class="text-3xl font-black text-red-700">0</h3>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Mapa -->
            <div class="lg:col-span-2 bg-white p-4 rounded-[2rem] shadow-sm border border-slate-200 space-y-4">
                <div class="flex justify-between items-center px-2 pt-2">
                    <h2 class="text-sm font-black text-slate-800 uppercase flex items-center gap-2">
                        <i data-lucide="map-pinned" class="text-blue-600" size="18"></i> Pontos de Incidência
                    </h2>
                </div>
                <div id="map"></div>
            </div>

            <!-- Ranking dos Piores Ônibus -->
            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-200 flex flex-col">
                <h2 class="text-sm font-black text-slate-800 uppercase mb-4 flex items-center gap-2">
                    <i data-lucide="alert-triangle" class="text-red-600" size="18"></i> Hall da Vergonha
                </h2>
                <div id="ranking-list" class="space-y-3 flex-1 overflow-y-auto pr-2 no-scrollbar">
                    <!-- Gerado por JS -->
                    <p class="text-center text-slate-400 text-xs py-12">Processando dados da frota...</p>
                </div>
                <p class="text-[9px] font-bold text-slate-400 uppercase mt-4 border-t pt-4 italic">
                    * Veículos com maior média de agressão sonora registrada.
                </p>
            </div>
        </div>

        <!-- Tabela Completa -->
        <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                <h2 class="text-sm font-black text-slate-800 uppercase">Log de Auditoria em Tempo Real</h2>
                <div class="flex gap-2">
                    <input type="text" id="table-search" placeholder="Filtrar por Ônibus ou Linha..." 
                        class="text-xs bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 outline-none focus:ring-2 focus:ring-blue-600 w-64">
                    <button onclick="window.print()" class="bg-slate-900 text-white p-2 rounded-xl active:scale-95 transition-all">
                        <i data-lucide="printer" size="16"></i>
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-xs">
                    <thead class="bg-slate-50 text-[10px] font-black uppercase text-slate-400">
                        <tr>
                            <th class="px-6 py-4">Instante</th>
                            <th class="px-6 py-4">Prefixo / Linha</th>
                            <th class="px-6 py-4">Medição</th>
                            <th class="px-6 py-4">Sintomas Relatados</th>
                            <th class="px-6 py-4 text-right">Auditoria (Device)</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100 font-medium">
                        <!-- Gerado por JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBwXw-f03A0mEfw3-RHc5A-1paido_ZDhM",
          authDomain: "sentinela-stp.firebaseapp.com",
          projectId: "sentinela-stp",
          storageBucket: "sentinela-stp.firebasestorage.app",
          messagingSenderId: "845865605498",
          appId: "1:845865605498:web:f4823825b7114d08dcdec3",
          measurementId: "G-6DT4QG0RVT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'sentinela-stp';

        // Mapa
        const map = L.map('map').setView([-27.5945, -48.5477], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
        const markersGroup = L.layerGroup().addTo(map);

        // State Global
        let allLogs = [];

        signInAnonymously(auth).then(() => {
            const syncStatus = document.getElementById('sync-status');
            syncStatus.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Frota Conectada';
            
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'evidencias'), limit(200));
            onSnapshot(q, (snapshot) => {
                allLogs = [];
                snapshot.forEach(doc => allLogs.push({ id: doc.id, ...doc.data() }));
                renderAll();
            });
        });

        function renderAll() {
            const tableBody = document.getElementById('table-body');
            const rankingList = document.getElementById('ranking-list');
            markersGroup.clearLayers();
            tableBody.innerHTML = '';
            rankingList.innerHTML = '';

            // 1. Agrupamento por Ônibus (Prefixo)
            const busStats = {};
            let totalDb = 0;
            let criticalCount = 0;

            allLogs.forEach(log => {
                const db = parseInt(log.ruido_db);
                totalDb += db;
                if (db >= 85) criticalCount++;

                const prefixo = log.prefixo || "S/N";
                if (!busStats[prefixo]) {
                    busStats[prefixo] = { count: 0, sumDb: 0, linha: log.linha, records: [] };
                }
                busStats[prefixo].count++;
                busStats[prefixo].sumDb += db;
                busStats[prefixo].records.push(log);

                // Marcador no Mapa
                if (log.coordenadas) {
                    const [lat, lng] = log.coordenadas.split(',').map(c => parseFloat(c.trim()));
                    if (!isNaN(lat)) {
                        const color = db >= 85 ? '#dc2626' : (db >= 75 ? '#f97316' : '#3b82f6');
                        L.circleMarker([lat, lng], { radius: 6, fillColor: color, color: '#fff', weight: 1, fillOpacity: 0.8 }).addTo(markersGroup)
                         .bindPopup(`<b>Ônibus: ${prefixo}</b><br>Linha: ${log.linha}<br>Ruído: ${db}dB`);
                    }
                }
            });

            // 2. Renderizar Ranking (Ordenado pela média de dB dos ônibus)
            const sortedBuses = Object.entries(busStats)
                .map(([id, data]) => ({ id, avgDb: Math.round(data.sumDb / data.count), ...data }))
                .sort((a, b) => b.avgDb - a.avgDb);

            sortedBuses.slice(0, 8).forEach(bus => {
                const card = document.createElement('div');
                card.className = "bg-slate-50 p-3 rounded-2xl border border-slate-100 flex justify-between items-center";
                card.innerHTML = `
                    <div class="text-left">
                        <p class="text-[10px] font-black text-slate-400 uppercase leading-none">Veículo</p>
                        <h4 class="text-sm font-black text-slate-800">#${bus.id} <span class="text-[10px] font-bold text-slate-400">L:${bus.linha}</span></h4>
                    </div>
                    <div class="text-right">
                        <span class="text-lg font-black ${bus.avgDb >= 85 ? 'text-red-600' : 'text-orange-600'}">${bus.avgDb} <small class="text-[10px]">dB</small></span>
                        <p class="text-[8px] font-bold text-slate-400 uppercase leading-none">${bus.count} denúncias</p>
                    </div>
                `;
                rankingList.appendChild(card);
            });

            // 3. Renderizar Tabela
            const sortedLogs = [...allLogs].sort((a, b) => {
                const timeA = a.timestamp?.seconds || 0;
                const timeB = b.timestamp?.seconds || 0;
                return timeB - timeA;
            });

            sortedLogs.forEach(log => {
                const row = document.createElement('tr');
                if (parseInt(log.ruido_db) >= 85) row.className = "critical-row";
                row.innerHTML = `
                    <td class="px-6 py-4 text-slate-400 text-[10px]">${log.data}<br>${log.hora}</td>
                    <td class="px-6 py-4">
                        <span class="font-black text-slate-800">#${log.prefixo}</span><br>
                        <span class="text-[10px] text-slate-500 uppercase font-bold">${log.linha}</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <span class="font-black ${parseInt(log.ruido_db) >= 85 ? 'text-red-600' : 'text-slate-600'}">${log.ruido_db}dB</span>
                            <span class="text-blue-600 font-bold">${log.temp_interna}°C</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 italic text-slate-500 text-[10px]">${log.sintomas || '--'}</td>
                    <td class="px-6 py-4 text-right">
                        <span class="text-[8px] bg-slate-100 px-2 py-1 rounded-md text-slate-400 font-mono">${log.audit?.deviceId?.substring(0,8) || 'Anon'}</span>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // 4. Update Stats
            document.getElementById('stat-total').innerText = allLogs.length;
            document.getElementById('stat-buses').innerText = Object.keys(busStats).length;
            document.getElementById('stat-db').innerText = Math.round(totalDb / (allLogs.length || 1));
            document.getElementById('stat-critical').innerText = criticalCount;
            
            lucide.createIcons();
        }

        // Busca na Tabela
        document.getElementById('table-search').oninput = function(e) {
            const term = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#table-body tr');
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        };
    </script>
</body>
</html>