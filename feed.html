<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinela STP - Mural e Jornalismo Popular</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        :root { --sat: env(safe-area-inset-top, 0px); --sab: env(safe-area-inset-bottom, 0px); }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Nav Bar Styles from index.html */
        .nav-link.active { color: #1d4ed8; }
        .nav-link.active i { color: #1d4ed8; fill: #dbeafe; }
        main { padding-bottom: calc(5rem + var(--sab)); }

        .feedback-card {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInScale 0.6s ease-out forwards;
        }
        
        /* Estilo Especial para o Jornalismo Investigativo */
        .editorial-card {
            background: linear-gradient(to bottom right, #1e3a8a, #1d4ed8);
            color: white;
            border: none;
            box-shadow: 0 20px 25px -5px rgba(29, 78, 216, 0.2);
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .live-dot {
            width: 10px; height: 10px;
            background-color: #ef4444;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.6); opacity: 0.4; }
            100% { transform: scale(1); opacity: 1; }
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Carousel Snap Styles */
        .snap-x-mandatory {
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
        }
        .snap-center {
            scroll-snap-align: center;
        }

        /* Anima√ß√£o do √çcone Flutuante */
        @keyframes floatIcon {
            0% { transform: translateY(0) scale(1) rotate(0deg); opacity: 0.15; }
            50% { transform: translateY(-15px) scale(1.1) rotate(5deg); opacity: 0.3; }
            100% { transform: translateY(0) scale(1) rotate(0deg); opacity: 0.15; }
        }

        .animated-icon {
            animation: floatIcon 6s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(255,255,255,0.4));
        }
        
        /* √çcone da Timeline */
        @keyframes pulseIcon {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }
        
        .timeline-icon {
            animation: pulseIcon 3s ease-in-out infinite;
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }
    </style>
</head>
<body class="min-h-screen pb-20">

    <!-- Cabe√ßalho Fixo Padronizado -->
    <header class="bg-blue-700 text-white px-6 py-4 shadow-lg sticky top-0 z-[100]">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-white/10 p-2 rounded-xl text-white backdrop-blur-sm">
                    <i data-lucide="newspaper" size="20"></i>
                </div>
                <div>
                    <h1 class="text-lg font-black tracking-tighter uppercase leading-none">Sentinela STP</h1>
                    <p class="text-[10px] font-bold text-blue-200 uppercase tracking-widest text-left">Mural & Central de Not√≠cias</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 bg-blue-800/50 px-4 py-2 rounded-full border border-blue-400/30">
                    <span class="live-dot bg-red-500"></span>
                    <span class="text-[10px] font-black uppercase text-white tracking-widest">Feed Ativo</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-6 md:pt-12">
        
        <!-- √Årea de Destaque Jornal√≠stico (Din√¢mica) -->
        <section id="editorial-section" class="mb-12">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-2">
                    <i data-lucide="search" class="text-blue-600" size="18"></i>
                    <h3 class="text-xs font-black uppercase tracking-[0.2em] text-slate-400">Investiga√ß√£o Sentinela</h3>
                </div>
                <!-- Indicadores do Carousel (opcional) -->
                <div id="carousel-dots" class="flex gap-1"></div>
            </div>
            
            <div id="editorial-carousel" class="flex overflow-x-auto snap-x-mandatory no-scrollbar gap-4 pb-4 -mx-6 px-6 md:mx-0 md:px-0">
                <!-- Conte√∫do injetado via JS -->
                <div class="w-full shrink-0 snap-center editorial-card p-8 rounded-[2.5rem] relative overflow-hidden min-h-[300px] flex items-center justify-center">
                    <i data-lucide="loader-2" class="animate-spin text-white/50" size="32"></i>
                </div>
            </div>
        </section>

        <!-- Divisor -->
        <div class="flex items-center gap-4 mb-8">
            <div class="h-px bg-slate-200 flex-1"></div>
            <span class="text-[10px] font-black text-slate-300 uppercase tracking-[0.3em]">Relatos em Tempo Real</span>
            <div class="h-px bg-slate-200 flex-1"></div>
        </div>

        <!-- Filtros e Controles -->
        <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm mb-8">
            <div class="flex flex-col md:flex-row gap-4 justify-between items-center">
                <div class="flex items-center gap-2 w-full md:w-auto">
                    <i data-lucide="filter" class="text-slate-400" size="16"></i>
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Filtrar por:</span>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                    <select id="filter-zone" class="bg-slate-50 border border-slate-200 text-slate-600 text-xs font-bold rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500 uppercase tracking-wide">
                        <option value="">Todas as Zonas</option>
                        <option value="Norte">Zona Norte</option>
                        <option value="Sul">Zona Sul</option>
                        <option value="Leste">Zona Leste</option>
                        <option value="Oeste">Zona Oeste</option>
                        <option value="Centro">Centro</option>
                    </select>

                    <input type="text" id="filter-line" placeholder="Linha (Ex: 8615)" class="bg-slate-50 border border-slate-200 text-slate-600 text-xs font-bold rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500 uppercase tracking-wide">
                    
                    <button id="apply-filters" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-black uppercase tracking-widest hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                        Aplicar <i data-lucide="arrow-right" size="14"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Feed de Relatos -->
        <div id="infinite-feed" class="space-y-8">
            <div id="initial-loader" class="flex flex-col items-center justify-center py-20 text-slate-300">
                <i data-lucide="loader-2" class="animate-spin mb-4" size="48"></i>
                <p class="font-bold uppercase text-xs tracking-widest">Conectando ao banco de dados...</p>
            </div>
        </div>

        <!-- Sentinela de Scroll -->
        <div id="scroll-anchor" class="h-20 flex items-center justify-center mt-12">
            <div id="load-more-loader" class="hidden text-slate-400 flex items-center gap-2">
                <i data-lucide="refresh-cw" class="animate-spin" size="16"></i>
                <span class="text-[10px] font-black uppercase tracking-widest">Buscando hist√≥rico...</span>
            </div>
        </div>
    </main>

    <!-- Barra de Navega√ß√£o Padr√£o -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 py-3 px-6 z-50" style="padding-bottom: calc(1rem + var(--sab));">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <a href="index.html" class="nav-link flex flex-col items-center gap-1 text-slate-400 font-bold text-[10px] uppercase transition-colors">
                <i data-lucide="home" size="20"></i>
                <span>In√≠cio</span>
            </a>
            <a href="feed.html" class="nav-link active flex flex-col items-center gap-1 text-slate-400 font-bold text-[10px] uppercase transition-colors">
                <i data-lucide="message-square" size="20"></i>
                <span>Feed</span>
            </a>
            <a href="painel.html" class="nav-link flex flex-col items-center gap-1 text-slate-400 font-bold text-[10px] uppercase transition-colors">
                <i data-lucide="bar-chart" size="20"></i>
                <span>Painel</span>
            </a>
            <a href="landpage.html" class="nav-link flex flex-col items-center gap-1 text-slate-400 font-bold text-[10px] uppercase transition-colors">
                <i data-lucide="info" size="20"></i>
                <span>Sobre</span>
            </a>
        </div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, getDocs, startAfter, where, doc, updateDoc, increment, getDoc, setDoc, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBwXw-f03A0mEfw3-RHc5A-1paido_ZDhM",
          authDomain: "sentinela-stp.firebaseapp.com",
          projectId: "sentinela-stp",
          storageBucket: "sentinela-stp.firebasestorage.app",
          messagingSenderId: "845865605498",
          appId: "1:845865605498:web:f4823825b7114d08dcdec3",
          measurementId: "G-6DT4QG0RVT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const container = document.getElementById('infinite-feed');
        const scrollAnchor = document.getElementById('scroll-anchor');
        const loadMoreLoader = document.getElementById('load-more-loader');
        const editorialCarousel = document.getElementById('editorial-carousel');
        const carouselDots = document.getElementById('carousel-dots');
        
        // Filtros UI
        const filterZone = document.getElementById('filter-zone');
        const filterLine = document.getElementById('filter-line');
        const applyFiltersBtn = document.getElementById('apply-filters');

        let lastVisible = null;
        let isLoadingMore = false;
        let hasMore = true;
        let unsubscribeLiveFeed = null;
        let unsubscribeNewsFeed = null; // Listener para not√≠cias na timeline
        let currentFilters = {};

        // --- SISTEMA JORNAL√çSTICO (CAROUSEL) ---
        const loadEditorialCarousel = () => {
            const qArtigo = query(
                collection(db, 'artifacts', 'sentinela-stp', 'public', 'data', 'artigos'),
                orderBy('timestamp', 'desc'),
                limit(5)
            );

            onSnapshot(qArtigo, (snapshot) => {
                editorialCarousel.innerHTML = '';
                carouselDots.innerHTML = '';

                if (snapshot.empty) {
                    editorialCarousel.innerHTML = `
                        <div class="w-full shrink-0 snap-center editorial-card p-8 rounded-[2.5rem] relative overflow-hidden group cursor-pointer">
                            <div class="relative z-10 text-left">
                                <span class="bg-blue-400/30 text-[10px] font-black uppercase px-3 py-1 rounded-full border border-white/20 mb-4 inline-block">Boas-vindas</span>
                                <h2 class="text-3xl font-black tracking-tight mb-4">A Sentinela est√° nas ruas.</h2>
                                <p class="text-blue-100 text-sm font-medium leading-relaxed">
                                    Use o app para registrar ru√≠do e calor. Em breve, traremos investiga√ß√µes profundas.
                                </p>
                            </div>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                snapshot.docs.forEach((doc, index) => {
                    const data = doc.data();
                    const card = document.createElement('div');
                    // Removida a classe 'group-hover:scale-110' do √≠cone para evitar conflito com anima√ß√£o CSS
                    card.className = "w-full shrink-0 snap-center editorial-card p-8 rounded-[2.5rem] relative overflow-hidden group cursor-pointer transition-all";
                    
                    // √çcone Maior e Animado
                    card.innerHTML = `
                        <div class="absolute -top-12 -right-12 p-0 z-0 pointer-events-none overflow-visible">
                            <div class="animated-icon text-white">
                                <i data-lucide="${data.icone || 'mic'}" width="280" height="280" stroke-width="0.8"></i>
                            </div>
                        </div>
                        <div class="relative z-10 max-w-2xl text-left h-full flex flex-col justify-between">
                            <div>
                                <span class="bg-blue-400/30 text-[10px] font-black uppercase px-3 py-1 rounded-full border border-white/20 mb-4 inline-block backdrop-blur-md">${data.categoria || 'Reportagem'}</span>
                                <h2 class="text-2xl md:text-3xl font-black tracking-tight mb-2 leading-tight drop-shadow-sm line-clamp-2">${data.titulo}</h2>
                                <p class="text-blue-100 text-xs md:text-sm font-medium leading-relaxed mb-4 line-clamp-3">
                                    ${data.resumo}
                                </p>
                            </div>
                            <div class="flex items-center gap-4 mt-auto">
                                <a href="${data.link || '#'}" class="bg-white text-blue-700 px-5 py-2.5 rounded-2xl font-black uppercase text-[9px] tracking-widest hover:bg-blue-50 transition-all shadow-lg shadow-blue-900/20">Ler Tudo</a>
                                <span class="text-[9px] font-bold text-blue-200">Publicado em ${data.data_str || 'Recentemente'}</span>
                            </div>
                        </div>
                    `;
                    editorialCarousel.appendChild(card);

                    // Indicador (Dot)
                    const dot = document.createElement('div');
                    dot.className = `w-1.5 h-1.5 rounded-full transition-all cursor-pointer ${index === 0 ? 'bg-blue-600 w-3' : 'bg-slate-300'}`;
                    // Permitir clique nos dots
                    dot.onclick = () => {
                        editorialCarousel.scrollTo({
                            left: card.offsetLeft,
                            behavior: 'smooth'
                        });
                        resetAutoScroll(); // Reinicia o timer ao interagir
                    };
                    carouselDots.appendChild(dot);
                });

                // --- Auto Scroll & Interatividade Desktop ---
                let autoScrollInterval;
                const scrollDelay = 5000; // 5 segundos por slide

                const startAutoScroll = () => {
                    clearInterval(autoScrollInterval);
                    autoScrollInterval = setInterval(() => {
                        const width = editorialCarousel.offsetWidth;
                        const scrollLeft = editorialCarousel.scrollLeft;
                        const maxScroll = editorialCarousel.scrollWidth - width;
                        
                        // Se chegou no fim, volta pro come√ßo
                        if (scrollLeft >= maxScroll - 10) { // -10 margem de erro
                            editorialCarousel.scrollTo({ left: 0, behavior: 'smooth' });
                        } else {
                            editorialCarousel.scrollBy({ left: width, behavior: 'smooth' });
                        }
                    }, scrollDelay);
                };

                const stopAutoScroll = () => clearInterval(autoScrollInterval);
                const resetAutoScroll = () => {
                    stopAutoScroll();
                    startAutoScroll();
                };

                // Iniciar Auto Scroll
                startAutoScroll();

                // Parar ao passar o mouse (Desktop) ou tocar (Mobile)
                editorialCarousel.addEventListener('mouseenter', stopAutoScroll);
                editorialCarousel.addEventListener('mouseleave', startAutoScroll);
                editorialCarousel.addEventListener('touchstart', stopAutoScroll);
                editorialCarousel.addEventListener('touchend', startAutoScroll);

                // L√≥gica de Arrastar com Mouse (Desktop Drag-to-Scroll)
                let isDown = false;
                let startX;
                let scrollLeft;

                editorialCarousel.addEventListener('mousedown', (e) => {
                    isDown = true;
                    editorialCarousel.classList.add('cursor-grabbing');
                    editorialCarousel.classList.remove('cursor-grab');
                    startX = e.pageX - editorialCarousel.offsetLeft;
                    scrollLeft = editorialCarousel.scrollLeft;
                    stopAutoScroll(); // Para enquanto arrasta
                });

                editorialCarousel.addEventListener('mouseleave', () => {
                    isDown = false;
                    editorialCarousel.classList.remove('cursor-grabbing');
                    startAutoScroll(); // Retoma se sair
                });

                editorialCarousel.addEventListener('mouseup', () => {
                    isDown = false;
                    editorialCarousel.classList.remove('cursor-grabbing');
                    startAutoScroll(); // Retoma ao soltar
                });

                editorialCarousel.addEventListener('mousemove', (e) => {
                    if (!isDown) return;
                    e.preventDefault();
                    const x = e.pageX - editorialCarousel.offsetLeft;
                    const walk = (x - startX) * 2; // Velocidade do scroll
                    editorialCarousel.scrollLeft = scrollLeft - walk;
                });

                // Scroll Handler para atualizar Dots (Mantido)
                editorialCarousel.onscroll = () => {
                    const scrollLeft = editorialCarousel.scrollLeft;
                    const width = editorialCarousel.offsetWidth;
                    // Melhor precis√£o no c√°lculo do √≠ndice atual
                    const index = Math.round(scrollLeft / width);
                    
                    Array.from(carouselDots.children).forEach((d, i) => {
                        d.className = `w-1.5 h-1.5 rounded-full transition-all cursor-pointer ${i === index ? 'bg-blue-600 w-3' : 'bg-slate-300'}`;
                    });
                };

                lucide.createIcons();
            });
        };

        const createNewsFeedCard = (item) => {
            const el = document.createElement('div');
            el.className = "bg-slate-900 border-l-4 border-blue-500 rounded-xl p-4 mb-4 shadow-md relative overflow-hidden group";
            
            // Timestamp seguro
            if (item.timestamp && item.timestamp.seconds) {
                el.dataset.timestamp = item.timestamp.seconds * 1000;
            } else if (item.timestamp) {
                el.dataset.timestamp = item.timestamp;
            } else {
                el.dataset.timestamp = Date.now();
            }
            
            // Fundo Sutil Animado
            el.innerHTML = `
                <div class="absolute -right-6 -bottom-6 text-blue-800/20 group-hover:text-blue-700/30 transition-all duration-500 timeline-icon">
                    <i data-lucide="${item.icone || 'newspaper'}" width="120" height="120" stroke-width="1.5"></i>
                </div>
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="bg-blue-600 text-white text-[10px] font-black uppercase px-2 py-0.5 rounded-md tracking-wider">
                            ${item.categoria || 'Not√≠cia'}
                        </span>
                        <span class="text-slate-400 text-[10px] font-bold uppercase tracking-widest flex items-center gap-1">
                            <i data-lucide="clock" size="10"></i>
                            ${item.data_str || 'Agora'}
                        </span>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-2 leading-tight">${item.titulo}</h3>
                    <p class="text-slate-300 text-xs leading-relaxed mb-3 line-clamp-3 w-[85%]">
                        ${item.resumo}
                    </p>
                    <a href="${item.link || '#'}" class="inline-flex items-center gap-1 text-blue-400 text-[10px] font-black uppercase tracking-widest hover:text-blue-300 transition-colors">
                        Ler Reportagem <i data-lucide="arrow-right" size="10"></i>
                    </a>
                </div>
            `;
            return el;
        };

        const insertSorted = (container, element) => {
            const timestamp = parseInt(element.dataset.timestamp || 0);
            const children = Array.from(container.children);
            
            // Encontrar o primeiro filho com timestamp MENOR (mais antigo)
            // Porque queremos ordem DECRESCENTE (Mais novo no topo)
            const nextElement = children.find(child => {
                // Ignorar elementos sem timestamp (loaders, mensagens de erro)
                if (!child.dataset.timestamp) return false;
                const childTs = parseInt(child.dataset.timestamp);
                return childTs < timestamp;
            });

            if (nextElement) {
                container.insertBefore(element, nextElement);
            } else {
                // Se n√£o achou ningu√©m mais antigo, ou a lista acabou, ou todos s√£o mais novos (o que seria estranho se appendChild for o padr√£o)
                // Se todos s√£o mais novos, appendChild coloca no fim? N√£o, se todos s√£o mais novos, nextElement seria null.
                // Mas queremos colocar ANTES de algu√©m MAIS ANTIGO.
                // Se todos na lista s√£o MAIS NOVOS (ts > timestamp), ent√£o este elemento √© o mais antigo de todos -> appendChild.
                // Se todos na lista s√£o MAIS ANTIGOS (ts < timestamp), ent√£o este elemento √© o mais novo -> insertBefore(firstChild).
                
                // Corre√ß√£o da l√≥gica:
                // Lista: [100, 90, 80]
                // Novo: 95.
                // child=100 (100 < 95? False)
                // child=90 (90 < 95? True) -> InsertBefore 90. Result: [100, 95, 90]. Correto.
                
                // Novo: 110.
                // child=100 (100 < 110? True) -> InsertBefore 100. Result: [110, 100, 90]. Correto.
                
                // Novo: 70.
                // child=100 (False)
                // child=90 (False)
                // child=80 (False)
                // nextElement = undefined.
                // AppendChild. Result: [100, 90, 80, 70]. Correto.
                
                container.appendChild(element);
            }
        };

        // Configura√ß√£o de Rea√ß√µes
        const REACTION_TYPES = {
            angry: { icon: 'üò°', label: 'Indignado' },
            sad: { icon: 'üò¢', label: 'Triste' },
            support: { icon: '‚úä', label: 'Apoio' },
            noise: { icon: 'üì¢', label: 'Barulho' }
        };

        const getUserId = () => {
            let id = localStorage.getItem('sentinela_uid');
            if (!id) {
                id = 'user_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('sentinela_uid', id);
            }
            return id;
        };

        const createCard = (item, isNew = false) => {
            if (!item.relato_pessoal || item.relato_pessoal.trim() === "") return null;

            const card = document.createElement('div');
            card.className = `feedback-card bg-white p-8 rounded-[2.5rem] border border-slate-200 shadow-sm relative ${isNew ? 'ring-2 ring-blue-500 ring-offset-4' : ''}`;
            
            // Timestamp para ordena√ß√£o
            if (item.timestamp) {
                // Normalizar para milissegundos
                if (item.timestamp.seconds) {
                    card.dataset.timestamp = item.timestamp.seconds * 1000;
                } else {
                    card.dataset.timestamp = item.timestamp;
                }
            } else {
                card.dataset.timestamp = 0;
            }

            const dbVal = parseInt(item.ruido_db) || 0;
            const noiseColor = dbVal >= 85 ? 'bg-red-500' : 'bg-blue-600';
            
            // Rea√ß√µes
            const reactions = item.reactions || {};
            const userReaction = localStorage.getItem(`reacted_${item.id}`);

            let reactionsHtml = '';
            for (const [key, config] of Object.entries(REACTION_TYPES)) {
                const count = reactions[key] || 0;
                const isActive = userReaction === key;
                // Estilo ajustado: sem scale, fundo mais sutil, foco no contorno e cor do √≠cone
                const activeClass = isActive 
                    ? 'bg-blue-50 ring-2 ring-blue-500 grayscale-0 opacity-100' 
                    : 'bg-slate-50 hover:bg-slate-100 grayscale opacity-60 hover:grayscale-0 hover:opacity-100';
                
                // Texto colorido apenas se ativo
                const textClass = isActive ? 'text-blue-700' : 'text-slate-500';

                reactionsHtml += `
                    <button onclick="handleReaction(event, '${item.id}', '${key}')" 
                        data-emoji-type="${key}"
                        class="reaction-btn group flex items-center gap-2 px-3 py-1.5 rounded-xl transition-all duration-200 border border-transparent ${activeClass}" 
                        title="${config.label}">
                        <span class="text-lg transition-transform group-active:scale-90">${config.icon}</span>
                        <span class="count-span text-[10px] font-black ${textClass}">${count > 0 ? count : ''}</span>
                    </button>
                `;
            }

            card.innerHTML = `
                <div class="flex justify-between items-start mb-6 text-left">
                    <div>
                        <p class="text-[10px] font-black text-blue-600 uppercase mb-1">Ve√≠culo #${item.prefixo || 'S/N'}</p>
                        <h4 class="text-sm font-bold text-slate-800 uppercase leading-none text-left">${item.linha || 'Linha N√£o Informada'}</h4>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        <span class="${noiseColor} text-white text-[10px] font-black px-3 py-1 rounded-full shadow-sm">${dbVal}dB</span>
                        <span class="text-[10px] font-bold text-blue-500 bg-blue-50 px-2 py-0.5 rounded-md border border-blue-100">${item.temp_interna}¬∞C</span>
                    </div>
                </div>
                <div class="bg-slate-50 p-6 rounded-[2rem] border border-slate-100 relative mb-6 text-left">
                    <i data-lucide="quote" class="absolute -top-3 -left-3 text-blue-500 opacity-20" size="40"></i>
                    <p class="text-base font-semibold text-slate-700 italic leading-relaxed text-left">"${item.relato_pessoal}"</p>
                </div>
                
                <!-- Barra de Rea√ß√µes -->
                <div class="flex flex-col gap-2 mb-4">
                    <p class="text-[9px] font-black text-slate-300 uppercase tracking-widest pl-2">Rea√ß√µes da Comunidade</p>
                    <div class="flex items-center gap-2 overflow-x-auto no-scrollbar p-1">
                        ${reactionsHtml}
                    </div>
                </div>

                <div class="flex justify-between items-center text-[11px] font-black text-slate-400 uppercase tracking-widest pt-4 border-t border-slate-100">
                    <div class="flex items-center gap-4">
                        <span class="flex items-center gap-1"><i data-lucide="calendar" size="12"></i> ${item.data}</span>
                        <span class="flex items-center gap-1"><i data-lucide="clock" size="12"></i> ${item.hora}</span>
                    </div>
                    <span class="flex items-center gap-1"><i data-lucide="map-pin" size="12"></i> ${item.zona || 'Interno'}</span>
                </div>
            `;
            return card;
        };

        window.handleReaction = async (event, docId, emojiType) => {
            const btn = event.currentTarget;
            const container = btn.parentElement;
            const userId = getUserId();
            const storageKey = `reacted_${docId}`;
            const previousReaction = localStorage.getItem(storageKey);
            
            // --- ATUALIZA√á√ÉO OTIMISTA DA UI ---
            // 1. Reverter estado visual do bot√£o anteriormente ativo (se houver e for diferente)
            if (previousReaction && previousReaction !== emojiType) {
                const prevBtn = container.querySelector(`button[data-emoji-type="${previousReaction}"]`);
                if (prevBtn) {
                    // Resetar estilos
                    prevBtn.className = 'reaction-btn group flex items-center gap-2 px-3 py-1.5 rounded-xl transition-all duration-200 border border-transparent bg-slate-50 hover:bg-slate-100 grayscale opacity-60 hover:grayscale-0 hover:opacity-100';
                    const prevCountSpan = prevBtn.querySelector('.count-span');
                    prevCountSpan.className = 'count-span text-[10px] font-black text-slate-500';
                    
                    // Decrementar contador
                    let prevCount = parseInt(prevCountSpan.innerText) || 0;
                    prevCount = Math.max(0, prevCount - 1);
                    prevCountSpan.innerText = prevCount > 0 ? prevCount : '';
                }
            }

            // 2. Atualizar estado do bot√£o clicado
            const isActive = previousReaction === emojiType; // Se j√° estava ativo, √© um toggle OFF
            const countSpan = btn.querySelector('.count-span');
            let currentCount = parseInt(countSpan.innerText) || 0;

            if (isActive) {
                // TOGGLE OFF: Remover estilos e decrementar
                btn.className = 'reaction-btn group flex items-center gap-2 px-3 py-1.5 rounded-xl transition-all duration-200 border border-transparent bg-slate-50 hover:bg-slate-100 grayscale opacity-60 hover:grayscale-0 hover:opacity-100';
                countSpan.className = 'count-span text-[10px] font-black text-slate-500';
                currentCount = Math.max(0, currentCount - 1);
                localStorage.removeItem(storageKey); // Atualiza localstorage otimistamente tamb√©m
            } else {
                // TOGGLE ON: Adicionar estilos e incrementar
                btn.className = 'reaction-btn group flex items-center gap-2 px-3 py-1.5 rounded-xl transition-all duration-200 border border-transparent bg-blue-50 ring-2 ring-blue-500 grayscale-0 opacity-100';
                countSpan.className = 'count-span text-[10px] font-black text-blue-700';
                currentCount++;
                localStorage.setItem(storageKey, emojiType); // Atualiza localstorage otimistamente
            }
            countSpan.innerText = currentCount > 0 ? currentCount : '';

            // --- FIM DA ATUALIZA√á√ÉO OTIMISTA ---
            
            try {
                const docRef = doc(db, 'artifacts', 'sentinela-stp', 'public', 'data', 'evidencias', docId);
                const interactionRef = doc(docRef, 'interactions', userId);
                let action = 'set';

                await runTransaction(db, async (transaction) => {
                    const interactionDoc = await transaction.get(interactionRef);
                    const currentData = interactionDoc.exists() ? interactionDoc.data() : null;
                    
                    if (currentData && currentData.emoji === emojiType) {
                        // Toggle Off (Remover rea√ß√£o)
                        transaction.delete(interactionRef);
                        transaction.update(docRef, { [`reactions.${emojiType}`]: increment(-1) });
                        action = 'remove';
                    } else {
                        // Nova rea√ß√£o ou Troca
                        if (currentData) {
                            // Troca: remove anterior
                            transaction.update(docRef, { [`reactions.${currentData.emoji}`]: increment(-1) });
                        }
                        // Adiciona nova
                        transaction.set(interactionRef, { emoji: emojiType, timestamp: new Date() });
                        transaction.update(docRef, { [`reactions.${emojiType}`]: increment(1) });
                        action = 'set';
                    }
                });
                
                // Sincroniza√ß√£o final do LocalStorage (redund√¢ncia para garantir consist√™ncia)
                if (action === 'remove') {
                    localStorage.removeItem(storageKey);
                } else {
                    localStorage.setItem(storageKey, emojiType);
                }
                
            } catch (e) {
                console.error("Erro na rea√ß√£o:", e);
                // Rollback visual simples: recarregar a p√°gina ou reverter classes (opcional, mas recomendado em apps complexos)
                // Aqui, como o listener do Firestore vai disparar em breve se houver erro de rede, a UI vai se corrigir sozinha eventualmente.
                // Mas para feedback de erro imediato:
                window.showToast ? window.showToast("Erro ao salvar rea√ß√£o") : alert("Erro ao salvar rea√ß√£o");
            }
        };

        const buildQuery = (baseCollection, isHistory = false) => {
            let constraints = [];
            
            // Adicionar Filtros
            if (currentFilters.zona) constraints.push(where('zona', '==', currentFilters.zona));
            if (currentFilters.linha) constraints.push(where('linha', '==', currentFilters.linha));
            
            // Ordena√ß√£o (Sempre por Timestamp Descendente)
            constraints.push(orderBy('timestamp', 'desc'));

            // Pagina√ß√£o ou Limite Inicial
            if (isHistory) {
                constraints.push(startAfter(lastVisible));
                constraints.push(limit(5));
            } else {
                constraints.push(limit(10));
            }

            return query(baseCollection, ...constraints);
        };

        const startNewsFeedIntegration = () => {
            if (unsubscribeNewsFeed) {
                unsubscribeNewsFeed();
                unsubscribeNewsFeed = null;
            }

            const qNews = query(
                collection(db, 'artifacts', 'sentinela-stp', 'public', 'data', 'artigos'),
                orderBy('timestamp', 'desc'),
                limit(10)
            );

            unsubscribeNewsFeed = onSnapshot(qNews, (snapshot) => {
                let hasChanges = false;
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const data = change.doc.data();
                        // Adicionar ID ao objeto
                        const newsCard = createNewsFeedCard({ ...data, id: change.doc.id });
                        insertSorted(container, newsCard);
                        hasChanges = true;
                    }
                });
                if (hasChanges) {
                    lucide.createIcons();
                }
            });
        };

        const startLiveFeed = () => {
            // Cancelar listener anterior se existir
            if (unsubscribeLiveFeed) {
                unsubscribeLiveFeed();
                unsubscribeLiveFeed = null;
            }

            // Resetar estado
            container.innerHTML = `
                <div id="initial-loader" class="flex flex-col items-center justify-center py-20 text-slate-300">
                    <i data-lucide="loader-2" class="animate-spin mb-4" size="48"></i>
                    <p class="font-bold uppercase text-xs tracking-widest">Conectando ao banco de dados...</p>
                </div>
            `;
            
            // Iniciar tamb√©m o feed de not√≠cias para garantir sincronia
            startNewsFeedIntegration();
            
            lucide.createIcons();
            lastVisible = null;
            hasMore = true;

            try {
                const qLive = buildQuery(collection(db, 'artifacts', 'sentinela-stp', 'public', 'data', 'evidencias'));
                let isFirstLoad = true;

                unsubscribeLiveFeed = onSnapshot(qLive, (snapshot) => {
                    const initialLoader = document.getElementById('initial-loader');
                    if (initialLoader) initialLoader.remove();
                    
                    if (snapshot.empty && isFirstLoad) {
                        // Se n√£o tiver relatos, apenas removemos o loader. 
                        // As not√≠cias podem aparecer, ent√£o n√£o mostramos "Nenhum relato" imediatamente se houver not√≠cias.
                        // Mas como not√≠cias s√£o ass√≠ncronas, talvez mostremos depois.
                        // Vamos deixar o container limpo (exceto not√≠cias que j√° chegaram)
                        
                        // Verificar se j√° tem not√≠cias
                        if (container.children.length === 0) {
                             container.innerHTML = `
                                <div class="text-center py-12 text-slate-400 empty-msg">
                                    <i data-lucide="inbox" class="mx-auto mb-2" size="32"></i>
                                    <p class="text-xs font-bold uppercase tracking-widest">Nenhum relato encontrado com este filtro.</p>
                                </div>
                            `;
                            lucide.createIcons();
                        }
                        isFirstLoad = false;
                        return;
                    }

                    if (isFirstLoad) {
                        // Carga Inicial
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            const card = createCard({ id: doc.id, ...data });
                            if (card) insertSorted(container, card);
                        });
                        isFirstLoad = false;
                    } else {
                        // Atualiza√ß√µes em Tempo Real
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === "added") {
                                const data = change.doc.data();
                                const card = createCard({ id: change.doc.id, ...data }, true);
                                if (card) {
                                    insertSorted(container, card);
                                    // Remover mensagem de vazio
                                    const emptyMsg = container.querySelector('.empty-msg');
                                    if(emptyMsg) emptyMsg.remove();
                                }
                            }
                        });
                    }

                    if (!lastVisible && !snapshot.empty) {
                        lastVisible = snapshot.docs[snapshot.docs.length - 1];
                    }
                    lucide.createIcons();

                }, (error) => {
                    console.error("Erro Live Feed:", error);
                    container.innerHTML = `
                        <div class="text-center py-8 text-red-400">
                            <i data-lucide="alert-triangle" class="mx-auto mb-2" size="24"></i>
                            <p class="text-xs font-bold uppercase">Erro ao carregar feed. Verifique sua conex√£o ou filtros.</p>
                        </div>
                    `;
                    lucide.createIcons();
                });

            } catch (e) {
                console.error("Erro ao iniciar feed:", e);
            }
        };

        const loadHistory = async () => {
            if (isLoadingMore || !lastVisible || !hasMore) return;
            
            isLoadingMore = true;
            if (loadMoreLoader) loadMoreLoader.classList.remove('hidden');

            try {
                const qNext = buildQuery(collection(db, 'artifacts', 'sentinela-stp', 'public', 'data', 'evidencias'), true);
                const snapshot = await getDocs(qNext);
                
                if (snapshot.empty) {
                    hasMore = false;
                    if (scrollAnchor) {
                        scrollAnchor.innerHTML = `<p class="text-[10px] font-black text-slate-300 uppercase tracking-widest">Fim dos relatos hist√≥ricos</p>`;
                    }
                    return;
                }

                lastVisible = snapshot.docs[snapshot.docs.length - 1];
                
                snapshot.forEach(doc => {
                    const card = createCard({ id: doc.id, ...doc.data() });
                    if (card) insertSorted(container, card);
                });
                
                lucide.createIcons();
            } catch (e) {
                console.error("Erro Pagina√ß√£o:", e);
                hasMore = false; // Parar de tentar se der erro (ex: falta de indice)
            } finally {
                isLoadingMore = false;
                if (loadMoreLoader) loadMoreLoader.classList.add('hidden');
            }
        };

        // Event Listeners para Filtros
        applyFiltersBtn.addEventListener('click', () => {
            currentFilters = {
                zona: filterZone.value,
                linha: filterLine.value.trim()
            };
            startLiveFeed();
        });

        // Trigger inicial
        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting) loadHistory();
        }, { threshold: 0.1 });

        if (scrollAnchor) observer.observe(scrollAnchor);

        signInAnonymously(auth)
            .then(() => {
                loadEditorialCarousel();
                startLiveFeed();
            })
            .catch(err => console.error("Erro Auth:", err));

    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });
    </script>
    <script src="version-display.js"></script>
</body>
</html>