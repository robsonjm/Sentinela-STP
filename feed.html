<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinela STP - Mural e Jornalismo Popular</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        :root { --sat: env(safe-area-inset-top, 0px); --sab: env(safe-area-inset-bottom, 0px); }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Nav Bar Styles from index.html */
        .nav-link.active { color: #1d4ed8; }
        .nav-link.active i { color: #1d4ed8; fill: #dbeafe; }
        main { padding-bottom: calc(5rem + var(--sab)); }

        .feedback-card {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInScale 0.6s ease-out forwards;
        }
        
        /* Estilo Especial para o Jornalismo Investigativo */
        .editorial-card {
            background: linear-gradient(to bottom right, #1e3a8a, #1d4ed8);
            color: white;
            border: none;
            box-shadow: 0 20px 25px -5px rgba(29, 78, 216, 0.2);
            display: none; /* Escondido por padrão, aparece se houver artigo */
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .live-dot {
            width: 10px; height: 10px;
            background-color: #ef4444;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.6); opacity: 0.4; }
            100% { transform: scale(1); opacity: 1; }
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .glass-header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }
    </style>
</head>
<body class="min-h-screen pb-20">

    <!-- Cabeçalho Fixo Padronizado -->
    <header class="bg-blue-700 text-white px-6 py-4 shadow-lg sticky top-0 z-[100]">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-white/10 p-2 rounded-xl text-white backdrop-blur-sm">
                    <i data-lucide="newspaper" size="20"></i>
                </div>
                <div>
                    <h1 class="text-lg font-black tracking-tighter uppercase leading-none">Sentinela STP</h1>
                    <p class="text-[10px] font-bold text-blue-200 uppercase tracking-widest text-left">Mural & Central de Notícias</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 bg-blue-800/50 px-4 py-2 rounded-full border border-blue-400/30">
                    <span class="live-dot bg-red-500"></span>
                    <span class="text-[10px] font-black uppercase text-white tracking-widest">Feed Ativo</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-6 md:pt-12">
        
        <!-- Área de Destaque Jornalístico (Dinâmica) -->
        <section id="editorial-section" class="mb-12">
            <div class="flex items-center gap-2 mb-6">
                <i data-lucide="search" class="text-blue-600" size="18"></i>
                <h3 class="text-xs font-black uppercase tracking-[0.2em] text-slate-400">Investigação Sentinela</h3>
            </div>
            
            <div id="editorial-content" class="editorial-card p-8 rounded-[2.5rem] relative overflow-hidden group cursor-pointer transition-all hover:scale-[1.01]">
                <!-- Conteúdo injetado via JS -->
            </div>
        </section>

        <!-- Divisor -->
        <div class="flex items-center gap-4 mb-8">
            <div class="h-px bg-slate-200 flex-1"></div>
            <span class="text-[10px] font-black text-slate-300 uppercase tracking-[0.3em]">Relatos em Tempo Real</span>
            <div class="h-px bg-slate-200 flex-1"></div>
        </div>

        <!-- Feed de Relatos -->
        <div id="infinite-feed" class="space-y-8">
            <div id="initial-loader" class="flex flex-col items-center justify-center py-20 text-slate-300">
                <i data-lucide="loader-2" class="animate-spin mb-4" size="48"></i>
                <p class="font-bold uppercase text-xs tracking-widest">Conectando ao banco de dados...</p>
            </div>
        </div>

        <!-- Sentinela de Scroll -->
        <div id="scroll-anchor" class="h-20 flex items-center justify-center mt-12">
            <div id="load-more-loader" class="hidden text-slate-400 flex items-center gap-2">
                <i data-lucide="refresh-cw" class="animate-spin" size="16"></i>
                <span class="text-[10px] font-black uppercase tracking-widest">Buscando histórico...</span>
            </div>
        </div>
    </main>

    <!-- Barra de Navegação Padrão -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 py-3 px-6 z-50" style="padding-bottom: calc(1rem + var(--sab));">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <a href="index.html" class="nav-link flex flex-col items-center gap-1 text-slate-400 font-bold text-[10px] uppercase transition-colors">
                <i data-lucide="home" size="20"></i>
                <span>Início</span>
            </a>
            <a href="feed.html" class="nav-link active flex flex-col items-center gap-1 text-slate-400 font-bold text-[10px] uppercase transition-colors">
                <i data-lucide="message-square" size="20"></i>
                <span>Feed</span>
            </a>
            <a href="painel.html" class="nav-link flex flex-col items-center gap-1 text-slate-400 font-bold text-[10px] uppercase transition-colors">
                <i data-lucide="bar-chart" size="20"></i>
                <span>Painel</span>
            </a>
            <a href="landpage.html" class="nav-link flex flex-col items-center gap-1 text-slate-400 font-bold text-[10px] uppercase transition-colors">
                <i data-lucide="info" size="20"></i>
                <span>Sobre</span>
            </a>
        </div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, getDocs, startAfter } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBwXw-f03A0mEfw3-RHc5A-1paido_ZDhM",
          authDomain: "sentinela-stp.firebaseapp.com",
          projectId: "sentinela-stp",
          storageBucket: "sentinela-stp.firebasestorage.app",
          messagingSenderId: "845865605498",
          appId: "1:845865605498:web:f4823825b7114d08dcdec3",
          measurementId: "G-6DT4QG0RVT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const container = document.getElementById('infinite-feed');
        const scrollAnchor = document.getElementById('scroll-anchor');
        const loadMoreLoader = document.getElementById('load-more-loader');
        const editorialContent = document.getElementById('editorial-content');
        
        let lastVisible = null;
        let isLoadingMore = false;
        let hasMore = true;

        // --- SISTEMA JORNALÍSTICO (ALIMENTAÇÃO DINÂMICA) ---
        const loadLatestEditorial = () => {
            // Busca o último artigo publicado na coleção 'artigos'
            const qArtigo = query(
                collection(db, 'artifacts', 'sentinela-stp', 'public', 'data', 'artigos'),
                orderBy('timestamp', 'desc'),
                limit(1)
            );

            onSnapshot(qArtigo, (snapshot) => {
                if (!snapshot.empty) {
                    const data = snapshot.docs[0].data();
                    editorialContent.style.display = 'block';
                    editorialContent.innerHTML = `
                        <div class="absolute top-0 right-0 p-8 opacity-10 group-hover:scale-110 transition-transform">
                            <i data-lucide="${data.icone || 'mic'}" size="120"></i>
                        </div>
                        <div class="relative z-10 max-w-2xl text-left">
                            <span class="bg-blue-400/30 text-[10px] font-black uppercase px-3 py-1 rounded-full border border-white/20 mb-4 inline-block">${data.categoria || 'Reportagem Especial'}</span>
                            <h2 class="text-3xl md:text-4xl font-black tracking-tight mb-4 leading-tight">${data.titulo}</h2>
                            <p class="text-blue-100 text-sm md:text-base font-medium leading-relaxed mb-6">
                                ${data.resumo}
                            </p>
                            <div class="flex items-center gap-4">
                                <a href="${data.link || '#'}" class="bg-white text-blue-700 px-6 py-3 rounded-2xl font-black uppercase text-[10px] tracking-widest hover:bg-blue-50 transition-all">Ler Matéria Completa</a>
                                <span class="text-[10px] font-bold text-blue-200">Publicado em ${data.data_str || 'Recentemente'}</span>
                            </div>
                        </div>
                    `;
                    lucide.createIcons();
                } else {
                    // Caso não haja artigos, mantemos um padrão informativo do projeto
                    editorialContent.style.display = 'block';
                    editorialContent.innerHTML = `
                        <div class="relative z-10 text-left">
                            <span class="bg-blue-400/30 text-[10px] font-black uppercase px-3 py-1 rounded-full border border-white/20 mb-4 inline-block">Boas-vindas</span>
                            <h2 class="text-3xl font-black tracking-tight mb-4">A Sentinela está nas ruas.</h2>
                            <p class="text-blue-100 text-sm font-medium leading-relaxed">
                                Use o app para registrar ruído e calor. Em breve, traremos investigações profundas sobre as linhas mais denunciadas pela população.
                            </p>
                        </div>
                    `;
                    lucide.createIcons();
                }
            });
        };

        const createCard = (item, isNew = false) => {
            if (!item.relato_pessoal || item.relato_pessoal.trim() === "") return null;

            const card = document.createElement('div');
            card.className = `feedback-card bg-white p-8 rounded-[2.5rem] border border-slate-200 shadow-sm relative ${isNew ? 'ring-2 ring-blue-500 ring-offset-4' : ''}`;
            
            const dbVal = parseInt(item.ruido_db) || 0;
            const noiseColor = dbVal >= 85 ? 'bg-red-500' : 'bg-blue-600';

            card.innerHTML = `
                <div class="flex justify-between items-start mb-6 text-left">
                    <div>
                        <p class="text-[10px] font-black text-blue-600 uppercase mb-1">Veículo #${item.prefixo || 'S/N'}</p>
                        <h4 class="text-sm font-bold text-slate-800 uppercase leading-none text-left">${item.linha || 'Linha Não Informada'}</h4>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        <span class="${noiseColor} text-white text-[10px] font-black px-3 py-1 rounded-full shadow-sm">${dbVal}dB</span>
                        <span class="text-[10px] font-bold text-blue-500 bg-blue-50 px-2 py-0.5 rounded-md border border-blue-100">${item.temp_interna}°C</span>
                    </div>
                </div>
                <div class="bg-slate-50 p-6 rounded-[2rem] border border-slate-100 relative mb-6 text-left">
                    <i data-lucide="quote" class="absolute -top-3 -left-3 text-blue-500 opacity-20" size="40"></i>
                    <p class="text-base font-semibold text-slate-700 italic leading-relaxed text-left">"${item.relato_pessoal}"</p>
                </div>
                <div class="flex justify-between items-center text-[11px] font-black text-slate-400 uppercase tracking-widest">
                    <div class="flex items-center gap-4">
                        <span class="flex items-center gap-1"><i data-lucide="calendar" size="12"></i> ${item.data}</span>
                        <span class="flex items-center gap-1"><i data-lucide="clock" size="12"></i> ${item.hora}</span>
                    </div>
                    <span class="flex items-center gap-1"><i data-lucide="map-pin" size="12"></i> ${item.zona || 'Interno'}</span>
                </div>
            `;
            return card;
        };

        const startLiveFeed = () => {
            const qLive = query(
                collection(db, 'artifacts', 'sentinela-stp', 'public', 'data', 'evidencias'),
                orderBy('timestamp', 'desc'),
                limit(10)
            );

            onSnapshot(qLive, (snapshot) => {
                const initialLoader = document.getElementById('initial-loader');
                if (initialLoader) initialLoader.remove();
                
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const data = change.doc.data();
                        const card = createCard(data, true);
                        if (card && container) {
                            container.prepend(card);
                            lucide.createIcons();
                        }
                    }
                });

                if (!lastVisible && !snapshot.empty) {
                    lastVisible = snapshot.docs[snapshot.docs.length - 1];
                }
            }, (error) => console.error("Erro Live Feed:", error));
        };

        const loadHistory = async () => {
            if (isLoadingMore || !lastVisible || !hasMore) return;
            
            isLoadingMore = true;
            if (loadMoreLoader) loadMoreLoader.classList.remove('hidden');

            try {
                const qNext = query(
                    collection(db, 'artifacts', 'sentinela-stp', 'public', 'data', 'evidencias'),
                    orderBy('timestamp', 'desc'),
                    startAfter(lastVisible),
                    limit(5)
                );

                const snapshot = await getDocs(qNext);
                
                if (snapshot.empty) {
                    hasMore = false;
                    if (scrollAnchor) {
                        scrollAnchor.innerHTML = `<p class="text-[10px] font-black text-slate-300 uppercase tracking-widest">Fim dos relatos históricos</p>`;
                    }
                    return;
                }

                lastVisible = snapshot.docs[snapshot.docs.length - 1];
                
                snapshot.forEach(doc => {
                    const card = createCard(doc.data());
                    if (card && container) container.appendChild(card);
                });
                
                lucide.createIcons();
            } catch (e) {
                console.error("Erro Paginação:", e);
            } finally {
                isLoadingMore = false;
                if (loadMoreLoader) loadMoreLoader.classList.add('hidden');
            }
        };

        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting) loadHistory();
        }, { threshold: 0.1 });

        if (scrollAnchor) observer.observe(scrollAnchor);

        signInAnonymously(auth)
            .then(() => {
                loadLatestEditorial(); // Carrega a notícia
                startLiveFeed();      // Carrega os relatos
            })
            .catch(err => console.error("Erro Auth:", err));

    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });
    </script>
    <script src="version-display.js"></script>
</body>
</html>