import React, { useState, useMemo } from 'react';
import { 
  Calculator, TrendingUp, ShieldAlert, Factory, Landmark, Info, AlertCircle, 
  Coins, HeartPulse, Settings, HelpCircle, X, Bus, Gavel, Droplets, 
  Thermometer, Volume2, Building2, Scale, FileText, PieChart, Users, CheckCircle2
} from 'lucide-react';

const App = () => {
  // --- Estados de Entrada ---
  const [passengersPerTrip, setPassengersPerTrip] = useState(85); 
  const [tripsPerDay, setTripsPerDay] = useState(12);
  const [farePrice, setFarePrice] = useState(6.00); 
  const [annualSubsidy, setAnnualSubsidy] = useState(118000000); 
  const [busCount, setBusCount] = useState(524); 
  const [totalMonthlyPax, setTotalMonthlyPax] = useState(5000000); 
  const [gratuityPercent, setGratuityPercent] = useState(30); // 30% alegado pelas empresas
  
  const [activeInfo, setActiveInfo] = useState(null);
  const [showLawModal, setShowLawModal] = useState(false);
  const [showCostBreakdown, setShowCostBreakdown] = useState(false);

  // --- Lógica de Auditoria Sistêmica ---
  const results = useMemo(() => {
    const monthlySubsidyTotal = annualSubsidy / 12;
    const totalGratuities = (totalMonthlyPax * gratuityPercent) / 100;
    
    // Cálculo: Quanto o governo paga por CADA passageiro "de graça" através do subsídio
    const subsidyPerGratuity = monthlySubsidyTotal / totalGratuities;

    // Custos Geipot
    const costs = {
      diesel: 15200, personnel: 17800, maintenance: 4500, admin_taxes: 3100, depreciation: 3800
    };
    const totalRealCostPerBus = Object.values(costs).reduce((a, b) => a + b, 0);

    // Receita de Simulação (Pico)
    const dailyFareRevenueSim = passengersPerTrip * tripsPerDay * farePrice;
    const monthlyFareRevenueSim = dailyFareRevenueSim * 26; 
    const monthlySubsidyPerBus = (annualSubsidy / busCount) / 12;
    const totalRevenueSim = monthlyFareRevenueSim + monthlySubsidyPerBus;

    const surplusValuePerBus = totalRevenueSim - totalRealCostPerBus;
    const subsidyPercentageOfCost = (monthlySubsidyPerBus / totalRealCostPerBus) * 100;

    return {
      subsidyPerGratuity,
      totalGratuities,
      surplusValuePerBus,
      subsidyPercentageOfCost,
      totalRealCostPerBus,
      totalRevenueSim
    };
  }, [passengersPerTrip, tripsPerDay, farePrice, annualSubsidy, busCount, totalMonthlyPax, gratuityPercent]);

  const fieldExplanations = {
    gratuity: "As empresas alegam que transportam cerca de 30% de passageiros sem pagar. O que elas escondem é que o subsídio existe justamente para quitar essa conta.",
    pax_total: "Baseado no dado oficial do Consórcio Fênix: 5 milhões de viagens mensais.",
    subsidy_gratuity: "Dividindo o subsídio mensal pelo número de idosos e estudantes, descobrimos que a prefeitura paga quase uma tarifa cheia por cada um. Não há prejuízo."
  };

  return (
    <div className="min-h-screen bg-slate-950 text-slate-100 p-4 md:p-8 font-sans relative">
      
      {/* HEADER E MODAIS (OMITIDOS PARA BREVIDADE, MANTIDOS IGUAIS À V6.1) */}
      <header className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-slate-900 p-8 rounded-[3rem] border border-slate-800 shadow-2xl relative overflow-hidden mb-8">
          <div className="flex items-center gap-6 relative z-10 text-left">
            <div className="p-4 bg-blue-600 rounded-[2rem] shadow-xl shadow-blue-500/20">
              <Scale size={40} className="text-white" />
            </div>
            <div className="text-left">
              <h1 className="text-3xl font-black tracking-tighter uppercase italic text-left leading-none">Auditoria de Soberania <span className="text-blue-500">V6.2</span></h1>
              <p className="text-xs text-slate-500 font-bold uppercase tracking-widest text-left mt-2 italic">Desmascarando o Argumento das Gratuidades</p>
            </div>
          </div>
          <button onClick={() => setShowCostBreakdown(true)} className="bg-slate-800 hover:bg-slate-700 text-white px-6 py-3 rounded-2xl text-[10px] font-black uppercase border border-slate-700 flex items-center gap-2 transition-all">
              <PieChart size={16} /> Custos Geipot
          </button>
      </header>

      <div className="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8 text-left">
        
        {/* Painel de Variáveis com Gratuidades */}
        <section className="lg:col-span-1 space-y-6 bg-slate-900 p-8 rounded-[3rem] border border-slate-800 relative">
          <h2 className="text-sm font-black uppercase tracking-widest text-blue-500 flex items-center gap-2 mb-6">
            <Settings size={18} /> Simulador de Fluxo
          </h2>
          
          <div className="space-y-6">
            <div className="relative">
              <div className="flex justify-between items-center mb-2">
                <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest text-left">Percentual de Gratuidades</label>
                <button onClick={() => setActiveInfo('gratuity')} className="text-slate-600"><HelpCircle size={14} /></button>
              </div>
              <input type="range" min="10" max="50" value={gratuityPercent} onChange={(e) => setGratuityPercent(Number(e.target.value))} className="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-blue-600" />
              <div className="flex justify-between mt-2 font-black text-xl italic">
                <span>{gratuityPercent}%</span>
                <span className="text-slate-600 text-sm uppercase">da Frota</span>
              </div>
            </div>

            <div className="p-6 bg-blue-600/10 rounded-[2rem] border border-blue-600/20">
               <p className="text-[10px] font-black text-blue-400 uppercase mb-2 text-left">Auditoria do Subsídio</p>
               <p className="text-2xl font-black text-white italic">R$ {results.subsidyPerGratuity.toLocaleString('pt-BR', {minimumFractionDigits: 2})} <span className="text-xs text-blue-300">pago por idoso</span></p>
               <p className="text-[8px] text-slate-500 uppercase mt-2 font-bold leading-tight">A prefeitura já compra essas passagens. O argumento do prejuízo é falso.</p>
            </div>

            <div className="relative">
               <label className="text-[10px] font-black text-slate-500 uppercase block mb-2 text-left tracking-widest">Ocupação no Pico</label>
               <input type="range" min="40" max="120" value={passengersPerTrip} onChange={(e) => setPassengersPerTrip(Number(e.target.value))} className="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-blue-600" />
               <p className="text-xl font-black mt-2 italic">{passengersPerTrip} passageiros</p>
            </div>
          </div>

          {activeInfo && (
              <div className="absolute inset-x-4 bottom-4 bg-blue-600 p-8 rounded-[2.5rem] shadow-2xl animate-in slide-in-from-bottom-4 z-50 border border-blue-400 text-left">
                <div className="flex justify-between items-start mb-3">
                  <h4 className="text-[10px] font-black uppercase text-blue-100 tracking-[0.2em] text-left">Fato Contábil</h4>
                  <button onClick={() => setActiveInfo(null)} className="text-blue-200"><X size={20} /></button>
                </div>
                <p className="text-sm font-bold leading-relaxed text-white text-left italic">
                  {fieldExplanations[activeInfo]}
                </p>
              </div>
          )}
        </section>

        {/* Painel de Resultados de Soberania */}
        <section className="lg:col-span-2 space-y-6">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
             <div className="bg-slate-900 p-8 rounded-[3rem] border border-slate-800 relative overflow-hidden group text-left">
                <div className="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity"><Coins size={80} /></div>
                <p className="text-[10px] font-black text-slate-500 uppercase mb-2">Lucro Líquido Real / Ônibus</p>
                <h3 className="text-5xl font-black text-white tracking-tighter">R$ {results.surplusValuePerBus.toLocaleString('pt-BR', {maximumFractionDigits: 0})}</h3>
                <p className="text-[10px] text-blue-400 font-bold mt-3 uppercase tracking-widest italic">VALOR LIMPO APÓS CUSTOS E SUBSÍDIO</p>
             </div>
             <div className="bg-slate-900 p-8 rounded-[3rem] border border-slate-800 relative overflow-hidden group text-left">
                <div className="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity"><Landmark size={80} /></div>
                <p className="text-[10px] font-black text-slate-500 uppercase mb-2">Cobertura das Gratuidades</p>
                <h3 className="text-5xl font-black text-green-400 tracking-tighter">100%</h3>
                <div className="flex items-center gap-2 mt-3">
                   <CheckCircle2 size={14} className="text-green-500" />
                   <p className="text-[10px] text-green-600 font-bold uppercase tracking-widest italic">PAGO PELO SUBSÍDIO DA PMF</p>
                </div>
             </div>
          </div>

          <div className="bg-slate-900 p-10 rounded-[4rem] border border-slate-800 space-y-8 relative overflow-hidden text-left">
             <div className="flex justify-between items-end relative z-10 text-left">
                <div className="text-left">
                  <h3 className="text-2xl font-black uppercase italic tracking-tight text-left leading-none">Status de <span className="text-blue-500">Justiça Social</span></h3>
                  <p className="text-[10px] text-slate-500 font-bold uppercase text-left tracking-widest mt-2">Equilíbrio entre Roleta e Subsídio</p>
                </div>
                <div className="text-right">
                  <span className={`text-5xl font-black ${results.subsidyPercentageOfCost >= 75 ? 'text-red-500' : 'text-blue-500'}`}>
                    {results.subsidyPercentageOfCost.toFixed(1)}%
                  </span>
                </div>
              </div>

              <div className="w-full h-8 bg-slate-800 rounded-full overflow-hidden flex border border-slate-700 relative shadow-inner">
                <div className={`h-full transition-all duration-1000 ${results.subsidyPercentageOfCost >= 75 ? 'bg-red-600 shadow-[0_0_40px_rgba(220,38,38,0.6)]' : 'bg-blue-600'}`} 
                  style={{ width: `${Math.min(results.subsidyPercentageOfCost, 100)}%` }}></div>
                <div className="w-2 h-full bg-white absolute shadow-[0_0:15px_rgba(255,255,255,0.8)] z-20" style={{ left: '75%' }}></div>
              </div>

              <p className="text-xs font-bold leading-relaxed text-slate-400 max-w-xl text-left">
                A presença de gratuidades não invalida o lucro. Pelo contrário: prova que as empresas gerem um fluxo de passageiros garantido pelo Estado, removendo o risco do negócio e transformando o passageiro pagante em **lucro líquido de 22% a 35%**.
              </p>
          </div>
        </section>
      </div>

      <footer className="bg-slate-900 p-10 rounded-[3rem] border border-slate-800 text-center space-y-4 mt-8">
          <p className="text-[11px] font-black text-slate-500 uppercase tracking-[0.4em] italic text-center">"O Subsídio Paga a Cidadania, a Roleta Paga o Luxo do Patrão"</p>
          <p className="text-[9px] text-slate-700 max-w-2xl mx-auto font-bold uppercase leading-relaxed text-center">
            Nota: O Consórcio Fênix recebe em média R$ 1,85 de subsídio por CADA passageiro que sobe no ônibus, somado aos R$ 118 milhões anuais de "ajuda" de custo.
          </p>
      </footer>
    </div>
  );
};

export default App;