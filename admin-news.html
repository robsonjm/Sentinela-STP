<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sentinela STP - Admin Notícias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        :root { --sat: env(safe-area-inset-top, 0px); --sab: env(safe-area-inset-bottom, 0px); }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; padding-bottom: calc(5rem + var(--sab)); }
        
        .nav-link.active { color: #1d4ed8; }
        .nav-link.active i { color: #1d4ed8; fill: #dbeafe; }
        
        /* Estilo do Card de Preview */
        .preview-card {
            background: linear-gradient(to bottom right, #1e3a8a, #1d4ed8);
            color: white;
            border-radius: 2.5rem;
            box-shadow: 0 20px 25px -5px rgba(29, 78, 216, 0.2);
        }

        /* Tipografia de Artigo (Preview) */
        .article-preview p { margin-bottom: 1.5rem; line-height: 1.8; color: #334155; font-size: 1.05rem; }
        .article-preview h2 { font-size: 1.5rem; font-weight: 800; color: #1e293b; margin-top: 2.5rem; margin-bottom: 1rem; letter-spacing: -0.02em; }
        .article-preview h3 { font-size: 1.25rem; font-weight: 700; color: #334155; margin-top: 2rem; margin-bottom: 0.75rem; }
        .article-preview ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1.5rem; color: #334155; }
        .article-preview li { margin-bottom: 0.5rem; }
        .article-preview blockquote { border-left: 4px solid #3b82f6; padding-left: 1.5rem; font-style: italic; color: #475569; margin: 2rem 0; background: #eff6ff; padding: 1.5rem; border-radius: 0 1rem 1rem 0; }
        .article-preview img { width: 100%; height: auto; border-radius: 1rem; margin: 2rem 0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .article-preview a { color: #2563eb; text-decoration: underline; font-weight: 600; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
    </style>
</head>
<body class="min-h-screen">

    <!-- Header -->
    <header class="bg-slate-900 text-white px-6 py-4 shadow-lg sticky top-0 z-[100]">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-white/10 p-2 rounded-xl text-white backdrop-blur-sm">
                    <i data-lucide="shield-check" size="20"></i>
                </div>
                <div>
                    <h1 class="text-lg font-black tracking-tighter uppercase leading-none">Sentinela STP</h1>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest text-left">Painel Administrativo</p>
                </div>
            </div>
            <button id="logout-btn" class="bg-red-500/20 hover:bg-red-500/40 text-red-200 p-2 rounded-lg transition-colors" title="Sair">
                <i data-lucide="log-out" size="18"></i>
            </button>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 sm:p-6 space-y-8">
        
        <!-- Título da Seção -->
        <div class="text-center space-y-2 max-w-lg mx-auto">
            <div class="inline-flex items-center gap-2 bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest border border-blue-200">
                <i data-lucide="file-plus" size="12"></i> Nova Publicação
            </div>
            <h2 class="text-2xl font-black text-slate-800 tracking-tight">Alimentar Feed Investigativo</h2>
            <p class="text-sm text-slate-500 font-medium">Preencha os dados abaixo para atualizar o mural de notícias em tempo real.</p>
        </div>

        <!-- Grid Layout -->
        <div class="grid lg:grid-cols-2 gap-8 items-start">
            
            <!-- Formulário -->
            <form id="news-form" class="space-y-4 bg-white p-6 rounded-[2rem] shadow-sm border border-slate-200">
            
            <!-- Título -->
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Título da Matéria</label>
                <input type="text" id="titulo" required placeholder="Ex: A Máfia do Transporte" 
                    class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm font-bold text-slate-800 outline-none focus:ring-2 focus:ring-blue-600 transition-all placeholder:text-slate-300">
            </div>

            <!-- Resumo -->
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Resumo (Lead)</label>
                <textarea id="resumo" required rows="3" placeholder="Um parágrafo curto que instiga a leitura..." 
                    class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm font-medium text-slate-700 outline-none focus:ring-2 focus:ring-blue-600 transition-all placeholder:text-slate-300 resize-none"></textarea>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <!-- Categoria -->
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Categoria</label>
                    <select id="categoria" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-xs font-bold text-slate-800 outline-none focus:ring-2 focus:ring-blue-600 appearance-none">
                        <option value="Investigação">Investigação</option>
                        <option value="Denúncia">Denúncia</option>
                        <option value="Urgente">Urgente</option>
                        <option value="Legislativo">Legislativo</option>
                        <option value="Vitória Popular">Vitória Popular</option>
                    </select>
                </div>

                <!-- Ícone -->
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Ícone (Lucide)</label>
                <div class="flex gap-2">
                    <input type="text" id="icone" value="alert-triangle" placeholder="Ex: alert-triangle" 
                        class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-xs font-mono font-medium text-slate-600 outline-none focus:ring-2 focus:ring-blue-600 transition-all">
                    <button type="button" id="open-icon-picker" class="bg-slate-100 hover:bg-slate-200 text-slate-600 p-3 rounded-xl transition-colors border border-slate-200" title="Escolher Ícone">
                        <i data-lucide="layout-grid" size="20"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Conteúdo Completo (WYSIWYG Simplificado) -->
        <div class="space-y-2">
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Diagramação da Matéria</label>
            <div class="bg-white border border-slate-200 rounded-2xl overflow-hidden shadow-sm">
                
                <!-- Toolbar Principal -->
                <div class="flex flex-col border-b border-slate-100 bg-slate-50/50">
                    
                    <!-- Linha 1: Tipografia Básica -->
                    <div class="flex items-center gap-1 p-2 overflow-x-auto no-scrollbar">
                        <div class="flex bg-white border border-slate-200 rounded-lg p-0.5 shadow-sm">
                            <button type="button" onclick="insertTag('<b>', '</b>')" class="p-2 hover:bg-slate-100 rounded-md text-slate-700 font-bold" title="Negrito"><i data-lucide="bold" size="16"></i></button>
                            <button type="button" onclick="insertTag('<i>', '</i>')" class="p-2 hover:bg-slate-100 rounded-md text-slate-700 italic" title="Itálico"><i data-lucide="italic" size="16"></i></button>
                            <button type="button" onclick="insertTag('<u>', '</u>')" class="p-2 hover:bg-slate-100 rounded-md text-slate-700 underline" title="Sublinhado"><i data-lucide="underline" size="16"></i></button>
                        </div>

                        <div class="w-px h-6 bg-slate-200 mx-1"></div>

                        <div class="flex bg-white border border-slate-200 rounded-lg p-0.5 shadow-sm">
                            <button type="button" onclick="insertTag('<h2>', '</h2>')" class="p-2 hover:bg-slate-100 rounded-md text-slate-700 font-bold text-xs" title="Título Principal">H2</button>
                            <button type="button" onclick="insertTag('<h3>', '</h3>')" class="p-2 hover:bg-slate-100 rounded-md text-slate-700 font-bold text-xs" title="Subtítulo">H3</button>
                        </div>

                        <div class="w-px h-6 bg-slate-200 mx-1"></div>

                        <div class="flex bg-white border border-slate-200 rounded-lg p-0.5 shadow-sm">
                            <button type="button" onclick="insertTag('<p>', '</p>')" class="p-2 hover:bg-slate-100 rounded-md text-slate-700" title="Parágrafo"><i data-lucide="pilcrow" size="16"></i></button>
                            <button type="button" onclick="insertTag('<ul>\n<li>', '</li>\n</ul>')" class="p-2 hover:bg-slate-100 rounded-md text-slate-700" title="Lista com Marcadores"><i data-lucide="list" size="16"></i></button>
                            <button type="button" onclick="insertTag('<ol>\n<li>', '</li>\n</ol>')" class="p-2 hover:bg-slate-100 rounded-md text-slate-700" title="Lista Numerada"><i data-lucide="list-ordered" size="16"></i></button>
                        </div>
                    </div>

                    <!-- Linha 2: Elementos Ricos e Mídia -->
                    <div class="flex items-center gap-1 p-2 border-t border-slate-100 overflow-x-auto no-scrollbar bg-slate-100/50">
                        
                        <!-- Blocos Especiais -->
                        <div class="flex bg-white border border-slate-200 rounded-lg p-0.5 shadow-sm mr-2">
                            <button type="button" onclick="insertBlock('quote')" class="p-2 hover:bg-slate-100 rounded-md text-slate-700 flex items-center gap-2 text-[10px] font-bold uppercase" title="Citação em Destaque">
                                <i data-lucide="quote" size="14"></i> <span class="hidden sm:inline">Citação</span>
                            </button>
                            <div class="w-px h-6 bg-slate-100 mx-1"></div>
                            <button type="button" onclick="insertBlock('info')" class="p-2 hover:bg-blue-50 text-blue-600 rounded-md flex items-center gap-2 text-[10px] font-bold uppercase" title="Caixa de Informação">
                                <i data-lucide="info" size="14"></i> <span class="hidden sm:inline">Info</span>
                            </button>
                            <button type="button" onclick="insertBlock('alert')" class="p-2 hover:bg-amber-50 text-amber-600 rounded-md flex items-center gap-2 text-[10px] font-bold uppercase" title="Caixa de Alerta">
                                <i data-lucide="alert-triangle" size="14"></i> <span class="hidden sm:inline">Alerta</span>
                            </button>
                            <div class="w-px h-6 bg-slate-100 mx-1"></div>
                            <button type="button" onclick="insertBlock('divider')" class="p-2 hover:bg-slate-100 text-slate-400 rounded-md flex items-center gap-2 text-[10px] font-bold uppercase" title="Divisor">
                                <i data-lucide="minus" size="14"></i>
                            </button>
                            <button type="button" onclick="insertBlock('button')" class="p-2 hover:bg-slate-100 text-slate-700 rounded-md flex items-center gap-2 text-[10px] font-bold uppercase" title="Botão de Ação">
                                <i data-lucide="mouse-pointer-2" size="14"></i> <span class="hidden sm:inline">Botão</span>
                            </button>
                        </div>

                        <!-- Mídia -->
                        <div class="flex bg-white border border-slate-200 rounded-lg p-0.5 shadow-sm ml-auto">
                            <button type="button" onclick="insertVideo()" class="p-2 hover:bg-slate-100 rounded-md text-slate-700 flex items-center gap-1 text-[10px] font-bold uppercase" title="Inserir Vídeo">
                                <i data-lucide="video" size="14"></i> <span class="hidden sm:inline">Vídeo</span>
                            </button>
                            <div class="w-px h-6 bg-slate-100 mx-1"></div>
                            <button type="button" onclick="triggerImageUpload()" class="p-2 hover:bg-slate-100 rounded-md text-slate-700 flex items-center gap-1 text-[10px] font-bold uppercase" title="Enviar Imagem">
                                <i data-lucide="image-plus" size="14"></i> <span class="hidden sm:inline">Foto</span>
                            </button>
                            <input type="file" id="image-upload-input" accept="image/*" class="hidden">
                            
                            <button type="button" onclick="insertImage()" class="p-2 hover:bg-slate-100 rounded-md text-slate-500 hover:text-blue-600 flex items-center gap-1 text-[10px] font-bold uppercase border-l border-slate-100" title="Inserir URL Manualmente">
                                <i data-lucide="link" size="14"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Área de Edição -->
                <textarea id="conteudo_html" rows="16" placeholder="Escreva sua matéria aqui..." 
                    class="w-full bg-white p-6 text-sm font-mono text-slate-700 outline-none resize-y leading-relaxed selection:bg-blue-100 selection:text-blue-900"></textarea>
                
                <!-- Rodapé do Editor -->
                <div class="bg-slate-50 border-t border-slate-200 p-2 flex justify-between items-center text-[10px] text-slate-400 font-medium px-4">
                    <span>Use os botões acima para diagramar</span>
                    <span class="opacity-50">HTML Mode</span>
                </div>
            </div>
        </div>

        <!-- Link (Opcional / Automático) -->
        <div class="space-y-1 opacity-50">
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Link Externo (Opcional)</label>
            <div class="relative">
                <i data-lucide="link" size="14" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                <input type="url" id="link" placeholder="Deixe em branco para usar o artigo interno" 
                    class="w-full bg-slate-50 border border-slate-200 rounded-xl pl-10 pr-4 py-3 text-xs font-medium text-blue-600 outline-none focus:ring-2 focus:ring-blue-600 transition-all placeholder:text-slate-300">
            </div>
        </div>

        <!-- Data Customizada -->
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Data de Exibição</label>
                <input type="text" id="data_str" placeholder="Ex: 25 de Outubro, 2025" 
                    class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-xs font-bold text-slate-800 outline-none focus:ring-2 focus:ring-blue-600 transition-all">
            </div>

            <!-- Botões de Ação -->
            <div class="flex gap-3 pt-2">
                <button type="button" id="cancel-edit-btn" class="hidden w-1/3 bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold uppercase text-xs tracking-widest py-4 rounded-xl transition-all">
                    Cancelar
                </button>
                <button type="submit" id="submit-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-black uppercase text-xs tracking-widest py-4 rounded-xl shadow-lg shadow-blue-200 active:scale-95 transition-all flex items-center justify-center gap-2">
                    <i data-lucide="send" size="16"></i> <span id="submit-btn-text">Publicar Notícia</span>
                </button>
            </div>
        </form>

        <!-- Preview em Tempo Real -->
        <div class="lg:sticky lg:top-24 space-y-4 pt-4 border-t lg:border-t-0 border-slate-200">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-xs font-black text-slate-300 uppercase tracking-[0.2em]">Visualização</h3>
                <div class="flex bg-slate-100 p-1 rounded-lg">
                    <button type="button" onclick="setPreviewMode('card')" id="btn-preview-card" class="px-3 py-1 text-[10px] font-bold uppercase tracking-widest rounded-md bg-white text-blue-600 shadow-sm transition-all">
                        Card
                    </button>
                    <button type="button" onclick="setPreviewMode('article')" id="btn-preview-article" class="px-3 py-1 text-[10px] font-bold uppercase tracking-widest rounded-md text-slate-400 hover:text-slate-600 transition-all">
                        Artigo
                    </button>
                </div>
            </div>

            <!-- Container Card -->
            <div id="preview-container-card" class="opacity-50 pointer-events-none transition-all duration-300">
                <div id="card-preview" class="preview-card p-6 sm:p-8 relative overflow-hidden group transform transition-transform duration-500 hover:scale-[1.02]">
                    <div class="absolute top-0 right-0 p-8 opacity-10">
                        <i id="preview-icon" data-lucide="alert-triangle" size="120"></i>
                    </div>
                    <div class="relative z-10 text-left">
                        <span id="preview-categoria" class="bg-blue-400/30 text-[10px] font-black uppercase px-3 py-1 rounded-full border border-white/20 mb-4 inline-block">Investigação</span>
                        <h2 id="preview-titulo" class="text-2xl font-black tracking-tight mb-4 leading-tight">Título da Matéria</h2>
                        <p id="preview-resumo" class="text-blue-100 text-sm font-medium leading-relaxed mb-6 line-clamp-3">
                            Resumo da matéria aparecerá aqui...
                        </p>
                        <div class="flex items-center gap-4">
                            <span class="bg-white text-blue-700 px-4 py-2 rounded-xl font-black uppercase text-[9px] tracking-widest">Ler Matéria</span>
                            <span id="preview-data" class="text-[9px] font-bold text-blue-200">Data Atual</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Container Artigo Completo -->
            <div id="preview-container-article" class="hidden bg-white p-6 rounded-2xl border border-slate-200 shadow-sm article-preview relative max-h-[80vh] overflow-y-auto custom-scrollbar">
                <div class="absolute top-4 right-4 opacity-10 text-slate-300">
                    <i data-lucide="smartphone" size="24"></i>
                </div>
                <span id="preview-article-date" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 block">Data</span>
                <h1 id="preview-article-title" class="text-2xl font-black text-slate-900 mb-4 leading-tight tracking-tight">Título da Matéria</h1>
                <p id="preview-article-lead" class="text-sm font-bold text-slate-600 mb-6 border-l-4 border-blue-500 pl-4 italic">
                    Resumo (Lead) aparecerá aqui...
                </p>
                <div id="preview-article-body" class="text-sm text-slate-600">
                    <p class="italic text-slate-400">Comece a escrever para ver o resultado...</p>
                </div>
            </div>
        </div>
    </div> <!-- Fechando Grid -->

        <!-- Lista de Gerenciamento -->
        <div class="space-y-4 pt-8 border-t border-slate-200" id="manage-news-section">
            <div class="flex justify-between items-end px-2">
                <div>
                    <h3 class="text-lg font-black text-slate-800 tracking-tight">Gerenciar Publicações</h3>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Editar ou remover notícias</p>
                </div>
                <div class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-widest flex items-center gap-1">
                    <i data-lucide="database" size="10"></i> <span id="news-count">0</span>
                </div>
            </div>
            
            <div id="news-list" class="space-y-3">
                <!-- Loading State -->
                <div class="text-center py-12 bg-white rounded-2xl border border-slate-100 shadow-sm">
                    <i data-lucide="loader-2" class="animate-spin mx-auto mb-3 text-blue-500" size="24"></i>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Carregando notícias...</p>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal Editor de Imagem (Cropper) -->
    <div id="cropper-modal" class="fixed inset-0 bg-black/90 z-[300] hidden flex flex-col p-4 opacity-0 transition-opacity duration-300">
        <div class="flex-1 relative bg-black rounded-xl overflow-hidden mb-4">
            <img id="image-to-crop" class="max-w-full h-auto opacity-0" src="">
        </div>
        
        <div class="flex flex-col gap-4 bg-slate-900 p-4 rounded-xl border border-slate-800">
            <div class="flex justify-between items-center text-white">
                <h3 class="font-bold text-sm uppercase tracking-widest">Ajustar Imagem</h3>
                <button onclick="closeCropper()" class="text-slate-400 hover:text-white"><i data-lucide="x" size="24"></i></button>
            </div>
            
            <!-- Controles Rápidos -->
            <div class="flex gap-2 overflow-x-auto pb-2">
                <button type="button" data-aspect-ratio="1.7777" class="aspect-ratio-btn bg-slate-800 text-slate-300 px-3 py-2 rounded text-xs font-bold whitespace-nowrap hover:bg-slate-700">16:9 (Capa)</button>
                <button type="button" data-aspect-ratio="1.3333" class="aspect-ratio-btn bg-slate-800 text-slate-300 px-3 py-2 rounded text-xs font-bold whitespace-nowrap hover:bg-slate-700">4:3 (Padrão)</button>
                <button type="button" data-aspect-ratio="1" class="aspect-ratio-btn bg-slate-800 text-slate-300 px-3 py-2 rounded text-xs font-bold whitespace-nowrap hover:bg-slate-700">1:1 (Quadrado)</button>
                <button type="button" data-aspect-ratio="NaN" class="aspect-ratio-btn bg-slate-800 text-slate-300 px-3 py-2 rounded text-xs font-bold whitespace-nowrap hover:bg-slate-700">Livre</button>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeCropper()" class="bg-slate-800 text-white font-bold py-3 rounded-lg hover:bg-slate-700 transition-colors">Cancelar</button>
                <button onclick="confirmCrop()" id="confirm-crop-btn" class="bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-500 transition-colors flex items-center justify-center gap-2">
                    <i data-lucide="check" size="18"></i> Confirmar & Upload
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Seletor de Ícones -->
    <div id="icon-picker-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-6 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-sm max-h-[80vh] flex flex-col overflow-hidden scale-95 transition-transform duration-300 transform">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <div>
                    <h3 class="text-lg font-black text-slate-800 tracking-tight">Escolher Ícone</h3>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Selecione um ícone para a matéria</p>
                </div>
                <button type="button" id="close-icon-picker" class="bg-slate-200 hover:bg-slate-300 text-slate-600 p-2 rounded-full transition-colors">
                    <i data-lucide="x" size="20"></i>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto grid grid-cols-4 gap-4" id="icon-grid">
                <!-- Ícones serão injetados aqui via JS -->
            </div>
        </div>
    </div>

    <!-- Modal API Key ImgBB -->
    <div id="api-key-modal" class="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-[400] hidden flex items-center justify-center p-6 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-sm overflow-hidden scale-95 transition-transform duration-300 transform">
            <div class="p-6 border-b border-slate-100 bg-slate-50">
                <h3 class="text-lg font-black text-slate-800 tracking-tight">Configurar ImgBB</h3>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Chave de API necessária</p>
            </div>
            
            <div class="p-6 space-y-4">
                <p class="text-sm text-slate-600">
                    A chave de API atual é inválida ou expirou. Por favor, insira uma nova chave para continuar fazendo uploads.
                </p>
                <div class="bg-blue-50 p-3 rounded-xl border border-blue-100">
                    <p class="text-[10px] text-blue-700 font-medium">
                        <i data-lucide="info" size="10" class="inline mr-1"></i>
                        Obtenha gratuitamente em: <a href="https://api.imgbb.com/" target="_blank" class="underline font-bold">api.imgbb.com</a>
                    </p>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Sua API Key</label>
                    <input type="text" id="imgbb-api-key-input" placeholder="Cole sua chave aqui..." 
                        class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-xs font-mono font-medium text-slate-600 outline-none focus:ring-2 focus:ring-blue-600 transition-all">
                </div>
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <button type="button" id="cancel-api-key-btn" class="bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-3 rounded-xl transition-colors text-xs uppercase tracking-widest">
                        Cancelar
                    </button>
                    <button type="button" id="save-api-key-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-colors text-xs uppercase tracking-widest shadow-lg shadow-blue-200">
                        Salvar Chave
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de Navegação Padrão (para facilitar o retorno) -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 py-3 px-6 z-50" style="padding-bottom: calc(1rem + var(--sab));">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <a href="index.html" class="nav-link flex flex-col items-center gap-1 text-slate-400 font-bold text-[10px] uppercase transition-colors">
                <i data-lucide="home" size="20"></i>
                <span>Início</span>
            </a>
            <a href="feed.html" class="nav-link flex flex-col items-center gap-1 text-slate-400 font-bold text-[10px] uppercase transition-colors">
                <i data-lucide="message-square" size="20"></i>
                <span>Feed</span>
            </a>
            <a href="painel.html" class="nav-link flex flex-col items-center gap-1 text-slate-400 font-bold text-[10px] uppercase transition-colors">
                <i data-lucide="bar-chart" size="20"></i>
                <span>Painel</span>
            </a>
            <a href="landpage.html" class="nav-link flex flex-col items-center gap-1 text-slate-400 font-bold text-[10px] uppercase transition-colors">
                <i data-lucide="info" size="20"></i>
                <span>Sobre</span>
            </a>
        </div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, getDocs, startAfter, where, doc, updateDoc, increment, getDoc, setDoc, deleteDoc, runTransaction, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBwXw-f03A0mEfw3-RHc5A-1paido_ZDhM",
          authDomain: "sentinela-stp.firebaseapp.com",
          projectId: "sentinela-stp",
          storageBucket: "sentinela-stp.firebasestorage.app",
          messagingSenderId: "845865605498",
          appId: "1:845865605498:web:f4823825b7114d08dcdec3",
          measurementId: "G-6DT4QG0RVT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Elementos do DOM
        const form = document.getElementById('news-form');
        const submitBtn = document.getElementById('submit-btn');
        const submitBtnText = document.getElementById('submit-btn-text');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const newsListEl = document.getElementById('news-list');
        const newsCountEl = document.getElementById('news-count');
        const previewContainer = document.getElementById('preview-container-card');
        const logoutBtn = document.getElementById('logout-btn');

        let editingId = null;

        // Verificar Autenticação
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuário está logado
                console.log("Usuário autenticado:", user.email);
                previewContainer.classList.remove('opacity-50', 'pointer-events-none');
                loadNewsList();
            } else {
                // Usuário não está logado
                console.log("Usuário não autenticado. Redirecionando...");
                window.location.href = "login.html";
            }
        });

        // Logout
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                signOut(auth).then(() => {
                    console.log("Logout realizado com sucesso.");
                    window.location.href = "login.html";
                }).catch((error) => {
                    console.error("Erro ao fazer logout:", error);
                });
            });
        }

        // Helper para inserir tags no Textarea (Global)
        window.insertTag = (openTag, closeTag) => {
            const textarea = document.getElementById('conteudo_html');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            
            const before = text.substring(0, start);
            const selection = text.substring(start, end);
            const after = text.substring(end);
            
            textarea.value = before + openTag + selection + closeTag + after;
            
            // Reposicionar cursor após a tag de abertura e seleção
            const newCursorPos = start + openTag.length + selection.length + closeTag.length;
            textarea.focus();
            textarea.setSelectionRange(newCursorPos, newCursorPos);
            
            updatePreview();
        };

        // Função para Inserir Blocos Inteligentes
        window.insertBlock = (type) => {
            let content = '';
            
            switch(type) {
                case 'quote':
                    content = `<blockquote class="border-l-4 border-blue-500 pl-4 italic text-slate-600 my-4 bg-slate-50 p-4 rounded-r-lg">\n    "Escreva a citação aqui..."\n    <footer class="text-xs font-bold text-slate-400 mt-2 not-italic">- Autor da Frase</footer>\n</blockquote>`;
                    break;
                case 'info':
                    content = `<div class="bg-blue-50 border border-blue-100 rounded-xl p-4 my-4 flex gap-3">\n    <div class="text-blue-500"><i data-lucide="info" size="20"></i></div>\n    <div class="text-sm text-blue-900">\n        <strong class="block text-blue-700 mb-1">Informação Importante</strong>\n        Escreva o detalhe informativo aqui.\n    </div>\n</div>`;
                    break;
                case 'alert':
                    content = `<div class="bg-amber-50 border border-amber-100 rounded-xl p-4 my-4 flex gap-3">\n    <div class="text-amber-500"><i data-lucide="alert-triangle" size="20"></i></div>\n    <div class="text-sm text-amber-900">\n        <strong class="block text-amber-700 mb-1">Atenção</strong>\n        Escreva o alerta aqui.\n    </div>\n</div>`;
                    break;
                case 'divider':
                    content = `<hr class="my-8 border-slate-200" />`;
                    break;
                case 'button':
                    const btnText = prompt("Texto do Botão:", "Clique Aqui");
                    const btnUrl = prompt("Link do Botão:", "https://");
                    if (btnText && btnUrl) {
                        content = `<div class="my-6 text-center">\n    <a href="${btnUrl}" target="_blank" class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-all shadow-lg shadow-blue-200">\n        ${btnText} <i data-lucide="arrow-right" size="16"></i>\n    </a>\n</div>`;
                    }
                    break;
            }

            const textarea = document.getElementById('conteudo_html');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            
            textarea.value = text.substring(0, start) + content + text.substring(end);
            
            updatePreview();
            lucide.createIcons();
        };

        window.insertImage = () => {
            const url = prompt("Cole a URL da imagem:");
            if (url) {
                insertTag(`<img src="${url}" alt="Imagem da matéria">`, '');
            }
        };

        window.insertVideo = () => {
            const url = prompt("Cole o link do vídeo (YouTube, Instagram, TikTok):");
            if (!url) return;

            let embedCode = '';
            
            // YouTube
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                let videoId = '';
                if (url.includes('youtu.be')) {
                    videoId = url.split('/').pop().split('?')[0];
                } else if (url.includes('v=')) {
                    videoId = url.split('v=')[1].split('&')[0];
                } else if (url.includes('/embed/')) {
                    videoId = url.split('/embed/')[1].split('?')[0];
                }
                
                if (videoId) {
                    embedCode = `<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; border-radius: 12px; margin: 2rem 0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">\n    <iframe src="https://www.youtube.com/embed/${videoId}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>\n</div>`;
                }
            } 
            // Instagram
            else if (url.includes('instagram.com')) {
                const cleanUrl = url.split('?')[0];
                embedCode = `<blockquote class="instagram-media" data-instgrm-permalink="${cleanUrl}" data-instgrm-version="14" style="background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:540px; min-width:326px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);">\n    <div style="padding:16px;">\n        <a href="${cleanUrl}" style="background:#FFFFFF; line-height:0; padding:0 0; text-align:center; text-decoration:none; width:100%;" target="_blank">Ver no Instagram</a>\n    </div>\n</blockquote>`;
            } 
            // TikTok
            else if (url.includes('tiktok.com')) {
                const videoIdMatch = url.match(/video\/(\d+)/);
                const videoId = videoIdMatch ? videoIdMatch[1] : '';
                const cleanUrl = url.split('?')[0];
                embedCode = `<blockquote class="tiktok-embed" cite="${cleanUrl}" data-video-id="${videoId}" style="max-width: 605px;min-width: 325px;">\n    <section>\n        <a target="_blank" href="${cleanUrl}">Ver no TikTok</a>\n    </section>\n</blockquote>`;
            } 
            else {
                alert("Plataforma não suportada. Tente YouTube, Instagram ou TikTok.");
                return;
            }

            if (embedCode) {
                insertTag(embedCode, '');
            }
        };

        // ImgBB Upload & Cropper Logic
        // Tenta pegar a API Key do LocalStorage ou usa uma chave padrão (que pode estar inválida/expirada)
        const IMGBB_API_KEY = '5a004494191316c17430155a5b58390b'; 
        let cropper;
        const imageUploadInput = document.getElementById('image-upload-input');
        const cropperModal = document.getElementById('cropper-modal');
        const imageToCrop = document.getElementById('image-to-crop');
        const confirmCropBtn = document.getElementById('confirm-crop-btn');
        
        // Elementos do Modal de API Key - REMOVIDOS
        const apiKeyModal = document.getElementById('api-key-modal');
        
        // Adicionar Listeners para os botões de Aspect Ratio
        document.querySelectorAll('.aspect-ratio-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                if (!cropper) return;
                const ratio = parseFloat(e.target.dataset.aspectRatio);
                cropper.setAspectRatio(ratio);
            });
        });

        window.triggerImageUpload = () => {
            imageUploadInput.click();
        };

        imageUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imageToCrop.src = e.target.result;
                    openCropper();
                };
                reader.readAsDataURL(file);
            }
        });

        function openCropper() {
            cropperModal.classList.remove('hidden');
            setTimeout(() => {
                cropperModal.classList.remove('opacity-0');
                if (cropper) cropper.destroy();
                cropper = new Cropper(imageToCrop, {
                    aspectRatio: 16 / 9,
                    viewMode: 1,
                    autoCropArea: 1,
                });
                imageToCrop.classList.remove('opacity-0');
            }, 100);
        }

        window.closeCropper = () => {
            cropperModal.classList.add('opacity-0');
            setTimeout(() => {
                cropperModal.classList.add('hidden');
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                imageUploadInput.value = ''; // Reset input
            }, 300);
        };

        window.confirmCrop = () => {
            if (!cropper) return;

            // Loading state
            const originalBtnContent = confirmCropBtn.innerHTML;
            confirmCropBtn.disabled = true;
            confirmCropBtn.innerHTML = `<i data-lucide="loader-2" class="animate-spin" size="18"></i> Processando...`;
            lucide.createIcons();

            // Obter canvas cortado e redimensionado (max 1024px)
            const canvas = cropper.getCroppedCanvas({
                maxWidth: 1024,
                maxHeight: 1024,
                fillColor: '#fff',
            });

            // Converter para Blob (JPEG 80% qualidade)
            canvas.toBlob((blob) => {
                uploadToImgBB(blob, originalBtnContent);
            }, 'image/jpeg', 0.8);
        };

        // Função para abrir o modal de API Key e retornar uma Promise com a nova chave - REMOVIDA
        
        function uploadToImgBB(imageBlob, originalBtnContent) {
            confirmCropBtn.innerHTML = `<i data-lucide="upload-cloud" class="animate-spin" size="18"></i> Enviando...`;
            lucide.createIcons();

            const formData = new FormData();
            formData.append('image', imageBlob);

            return fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const imageUrl = data.data.url;
                    insertTag(`<img src="${imageUrl}" alt="Imagem da matéria">`, '');
                    closeCropper();
                } else {
                    throw new Error(data.error ? data.error.message : 'Erro desconhecido no upload');
                }
            })
            .catch(error => {
                console.error('Erro no upload:', error);
                alert('Falha ao enviar imagem: ' + error.message);
            })
            .finally(() => {
                confirmCropBtn.disabled = false;
                confirmCropBtn.innerHTML = originalBtnContent;
                lucide.createIcons();
            });
        }

        // Icon Picker Logic
        const iconPickerModal = document.getElementById('icon-picker-modal');
        const openIconPickerBtn = document.getElementById('open-icon-picker');
        const closeIconPickerBtn = document.getElementById('close-icon-picker');
        const iconGrid = document.getElementById('icon-grid');
        const modalContent = iconPickerModal.querySelector('div'); // O card branco

        const availableIcons = [
            'alert-triangle', 'newspaper', 'file-text', 'search', 'shield-alert', 
            'megaphone', 'check-circle', 'scale', 'users', 'info', 'camera', 
            'video', 'map-pin', 'calendar', 'dollar-sign', 'flame', 'zap', 
            'trending-up', 'activity', 'lock', 'unlock', 'eye', 'eye-off',
            'bell', 'bookmark', 'award', 'flag', 'target', 'compass', 'globe',
            'home', 'message-square', 'bar-chart', 'settings', 'user', 'user-check',
            'briefcase', 'clipboard', 'file-plus', 'folder', 'image', 'mic',
            'music', 'pause', 'play', 'power', 'printer', 'save', 'send',
            'share', 'shield', 'shield-check', 'smartphone', 'star', 'sun',
            'moon', 'thumbs-up', 'thumbs-down', 'trash', 'truck', 'wifi'
        ];

        function renderIconGrid() {
            iconGrid.innerHTML = '';
            availableIcons.forEach(iconName => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'flex flex-col items-center justify-center gap-2 p-3 rounded-xl bg-slate-50 hover:bg-blue-100 hover:text-blue-600 transition-colors border border-slate-100';
                btn.innerHTML = `
                    <i data-lucide="${iconName}" size="24"></i>
                    <span class="text-[8px] font-mono font-medium text-slate-500 uppercase truncate w-full text-center">${iconName}</span>
                `;
                btn.onclick = () => {
                    document.getElementById('icone').value = iconName;
                    updatePreview();
                    closeIconPicker();
                };
                iconGrid.appendChild(btn);
            });
            lucide.createIcons();
        }

        function openIconPicker() {
            renderIconGrid();
            iconPickerModal.classList.remove('hidden');
            // Timeout para permitir a transição CSS
            setTimeout(() => {
                iconPickerModal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
        }

        function closeIconPicker() {
            iconPickerModal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                iconPickerModal.classList.add('hidden');
            }, 300); // Tempo da transição
        }

        openIconPickerBtn.addEventListener('click', openIconPicker);
        closeIconPickerBtn.addEventListener('click', closeIconPicker);
        
        // Fechar ao clicar fora
        iconPickerModal.addEventListener('click', (e) => {
            if (e.target === iconPickerModal) closeIconPicker();
        });

        // Live Preview Logic
        const inputs = ['titulo', 'resumo', 'categoria', 'icone', 'data_str', 'conteudo_html'];
        inputs.forEach(id => {
            document.getElementById(id).addEventListener('input', updatePreview);
        });

        // Preencher data atual automaticamente se vazio
        const today = new Date();
        const options = { day: 'numeric', month: 'long', year: 'numeric' };
        document.getElementById('data_str').value = today.toLocaleDateString('pt-BR', options);
        
        // Preview Mode Toggle
        window.setPreviewMode = (mode) => {
            const cardBtn = document.getElementById('btn-preview-card');
            const articleBtn = document.getElementById('btn-preview-article');
            const cardContainer = document.getElementById('preview-container-card');
            const articleContainer = document.getElementById('preview-container-article');

            if (mode === 'card') {
                // Ativar Card
                cardBtn.classList.remove('text-slate-400', 'hover:text-slate-600');
                cardBtn.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
                
                articleBtn.classList.add('text-slate-400', 'hover:text-slate-600');
                articleBtn.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');

                cardContainer.classList.remove('hidden');
                articleContainer.classList.add('hidden');
            } else {
                // Ativar Artigo
                articleBtn.classList.remove('text-slate-400', 'hover:text-slate-600');
                articleBtn.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
                
                cardBtn.classList.add('text-slate-400', 'hover:text-slate-600');
                cardBtn.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');

                articleContainer.classList.remove('hidden');
                cardContainer.classList.add('hidden');
            }
        };

        function updatePreview() {
            // Card Preview Data
            document.getElementById('preview-titulo').innerText = document.getElementById('titulo').value || 'Título da Matéria';
            document.getElementById('preview-resumo').innerText = document.getElementById('resumo').value || 'Resumo da matéria aparecerá aqui...';
            document.getElementById('preview-categoria').innerText = document.getElementById('categoria').value;
            document.getElementById('preview-data').innerText = document.getElementById('data_str').value;
            
            // Article Preview Data
            document.getElementById('preview-article-title').innerText = document.getElementById('titulo').value || 'Título da Matéria';
            document.getElementById('preview-article-lead').innerText = document.getElementById('resumo').value || 'Resumo (Lead) aparecerá aqui...';
            document.getElementById('preview-article-date').innerText = document.getElementById('data_str').value;
            
            const content = document.getElementById('conteudo_html').value;
            const bodyContainer = document.getElementById('preview-article-body');
            
            if (content && content.trim() !== '') {
                bodyContainer.innerHTML = content;
            } else {
                bodyContainer.innerHTML = '<p class="italic text-slate-400">Comece a escrever para ver o resultado...</p>';
            }

            // Atualizar ícone (Card Only)
            const iconName = document.getElementById('icone').value || 'alert-triangle';
            const iconContainer = document.querySelector('#card-preview .absolute');
            if (iconContainer) {
                iconContainer.innerHTML = `<i data-lucide="${iconName}" size="120"></i>`;
            }
            
            lucide.createIcons();

            // Re-process Instagram/TikTok Embeds
            // Usa Lazy Loading para não travar o preview
            const bodyContainer = document.getElementById('preview-article-body');
            
            if (bodyContainer.querySelector('.instagram-media') && !document.querySelector('script[src="//www.instagram.com/embed.js"]')) {
                const script = document.createElement('script');
                script.src = "//www.instagram.com/embed.js";
                script.async = true;
                document.body.appendChild(script);
            } else if (window.instgrm) {
                window.instgrm.Embeds.process();
            }

            if (bodyContainer.querySelector('.tiktok-embed') && !document.querySelector('script[src="https://www.tiktok.com/embed.js"]')) {
                const script = document.createElement('script');
                script.src = "https://www.tiktok.com/embed.js";
                script.async = true;
                document.body.appendChild(script);
            }
        }

        // Initialize
        updatePreview();

        // Funções de Gerenciamento de Notícias
        function loadNewsList() {
            const q = query(
                collection(db, 'artifacts', 'sentinela-stp', 'public', 'data', 'artigos')
            );

            onSnapshot(q, (snapshot) => {
                newsCountEl.innerText = snapshot.size;
                
                if (snapshot.empty) {
                    newsListEl.innerHTML = `
                        <div class="text-center py-8 text-slate-400">
                            <i data-lucide="inbox" class="mx-auto mb-2" size="24"></i>
                            <p class="text-xs font-medium">Nenhuma notícia publicada ainda.</p>
                        </div>`;
                    lucide.createIcons();
                    return;
                }

                const docs = [];
                snapshot.forEach((doc) => {
                    docs.push({ id: doc.id, ...doc.data() });
                });

                // Ordenação Client-Side (timestamp desc)
                // Garante que notícias sem timestamp apareçam (como antigas)
                docs.sort((a, b) => {
                    const tA = a.timestamp ? (a.timestamp.seconds || 0) : 0;
                    const tB = b.timestamp ? (b.timestamp.seconds || 0) : 0;
                    return tB - tA;
                });

                let html = '';
                docs.forEach((data) => {
                    const id = data.id;
                    const date = data.data_str || 'Sem data';
                    
                    html += `
                        <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex items-center justify-between gap-4 hover:shadow-md transition-shadow group">
                            <div class="flex items-center gap-3 overflow-hidden">
                                <div class="bg-blue-50 p-2 rounded-lg text-blue-600 flex-shrink-0">
                                    <i data-lucide="${data.icone || 'file-text'}" size="18"></i>
                                </div>
                                <div class="min-w-0">
                                    <h4 class="text-sm font-bold text-slate-800 truncate">${data.titulo}</h4>
                                    <div class="flex items-center gap-2 text-[10px] text-slate-400 font-medium uppercase tracking-wider">
                                        <span>${data.categoria}</span>
                                        <span>•</span>
                                        <span>${date}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-1 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="window.editNews('${id}')" class="p-2 hover:bg-blue-50 text-slate-400 hover:text-blue-600 rounded-lg transition-colors" title="Editar">
                                    <i data-lucide="edit-2" size="16"></i>
                                </button>
                                <button onclick="window.deleteNews('${id}')" class="p-2 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded-lg transition-colors" title="Excluir">
                                    <i data-lucide="trash-2" size="16"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                newsListEl.innerHTML = html;
                lucide.createIcons();
            });
        }

        window.editNews = async (id) => {
            try {
                const docRef = doc(db, 'artifacts', 'sentinela-stp', 'public', 'data', 'artigos', id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Preencher formulário
                    document.getElementById('titulo').value = data.titulo;
                    document.getElementById('resumo').value = data.resumo;
                    document.getElementById('categoria').value = data.categoria;
                    document.getElementById('icone').value = data.icone;
                    document.getElementById('link').value = (data.link && !data.link.includes('artigo.html')) ? data.link : '';
                    document.getElementById('data_str').value = data.data_str;
                    document.getElementById('conteudo_html').value = data.conteudo_html || '';

                    // Atualizar preview
                    updatePreview();

                    // Mudar estado para edição
                    editingId = id;
                    submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    submitBtn.classList.add('bg-amber-500', 'hover:bg-amber-600');
                    submitBtnText.innerText = "Salvar Alterações";
                    cancelEditBtn.classList.remove('hidden');
                    
                    // Rolar para o topo
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } catch (error) {
                console.error("Erro ao carregar notícia para edição:", error);
                alert("Erro ao carregar notícia.");
            }
        };

        window.deleteNews = async (id) => {
            if (confirm('Tem certeza que deseja excluir esta notícia? Esta ação não pode ser desfeita.')) {
                try {
                    await deleteDoc(doc(db, 'artifacts', 'sentinela-stp', 'public', 'data', 'artigos', id));
                    // Lista atualiza automaticamente via onSnapshot
                } catch (error) {
                    console.error("Erro ao excluir:", error);
                    alert("Erro ao excluir notícia.");
                }
            }
        };

        window.cancelEdit = () => {
            editingId = null;
            form.reset();
            
            // Restaurar data
            const today = new Date();
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            document.getElementById('data_str').value = today.toLocaleDateString('pt-BR', options);
            
            updatePreview();

            // Restaurar botões
            submitBtn.classList.remove('bg-amber-500', 'hover:bg-amber-600');
            submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            submitBtnText.innerText = "Publicar Notícia";
            cancelEditBtn.classList.add('hidden');
        };

        cancelEditBtn.addEventListener('click', window.cancelEdit);

        // Submit Handler
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Estado de Loading
            const originalBtnContent = submitBtn.innerHTML;
            // Salvar classes originais (se não estiver editando, assume blue)
            const isEditing = editingId !== null;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<i data-lucide="loader-2" class="animate-spin" size="16"></i> ${isEditing ? 'Salvando...' : 'Publicando...'}`;
            lucide.createIcons();

            try {
                const titulo = document.getElementById('titulo').value;
                const resumo = document.getElementById('resumo').value;
                const categoria = document.getElementById('categoria').value;
                const icone = document.getElementById('icone').value;
                let link = document.getElementById('link').value; // Link opcional
                const data_str = document.getElementById('data_str').value;
                const conteudo_html = document.getElementById('conteudo_html').value;

                const newsData = {
                    titulo: titulo,
                    resumo: resumo,
                    categoria: categoria,
                    icone: icone,
                    data_str: data_str,
                    conteudo_html: conteudo_html,
                };

                // Se tiver link externo, usa. Se não, usa placeholder ou mantém o existente na edição.
                if (link && link.trim() !== "") {
                    newsData.link = link;
                } else if (!editingId) {
                    newsData.link = '#'; // Placeholder para criação
                }

                // Garantir timestamp na criação (Independentemente do link)
                if (!editingId) {
                    newsData.timestamp = serverTimestamp();
                }

                if (editingId) {
                    // Atualizar Existente
                    const docRef = doc(db, 'artifacts', 'sentinela-stp', 'public', 'data', 'artigos', editingId);
                    
                    // Verificar se já tem timestamp (correção para notícias legadas)
                    // Se não tiver, adiciona o timestamp atual para que apareça no feed ordenado
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists() && !docSnap.data().timestamp) {
                        newsData.timestamp = serverTimestamp();
                    }

                    await updateDoc(docRef, newsData);
                    submitBtn.innerHTML = `<i data-lucide="check-circle" size="16"></i> Atualizado!`;
                } else {
                    // Criar Novo
                    const docRef = await addDoc(collection(db, 'artifacts', 'sentinela-stp', 'public', 'data', 'artigos'), newsData);
                    console.log("Documento escrito com ID: ", docRef.id);

                    // Se o link estiver vazio, atualizar com o link interno gerado
                    if (!link || link.trim() === "") {
                        const generatedLink = `artigo.html?id=${docRef.id}`;
                        await updateDoc(doc(db, 'artifacts', 'sentinela-stp', 'public', 'data', 'artigos', docRef.id), {
                            link: generatedLink
                        });
                    }
                    submitBtn.innerHTML = `<i data-lucide="check-circle" size="16"></i> Publicado!`;
                }

                // Feedback de Sucesso
                submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-amber-500', 'hover:bg-amber-600');
                submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                lucide.createIcons();

                // Limpar formulário após 1.5 segundos
                setTimeout(() => {
                    window.cancelEdit(); // Reseta tudo para estado inicial
                    submitBtn.disabled = false;
                    lucide.createIcons();
                }, 1500);

            } catch (e) {
                console.error("Erro ao salvar: ", e);
                alert("Erro ao salvar: " + e.message);
                
                // Restaurar botão
                submitBtn.innerHTML = originalBtnContent;
                submitBtn.disabled = false;
                lucide.createIcons();
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });
    </script>
    <script src="version-display.js"></script>
</body>
</html>