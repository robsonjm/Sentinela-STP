<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sentinela STP - Transporte é Saúde</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        :root {
            /* Fallbacks para navegadores que não suportam env() */
            --sat: env(safe-area-inset-top, 0px);
            --sab: env(safe-area-inset-bottom, 0px);
            --sal: env(safe-area-inset-left, 0px);
            --sar: env(safe-area-inset-right, 0px);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            touch-action: manipulation;
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
            /* Garante que o fundo preencha tudo, inclusive as safe areas */
            background-color: #f8fafc; 
        }

        /* Estrutura para fixar elementos e rolar apenas o centro */
        .app-container {
            height: 100dvh; /* Dynamic Viewport Height */
            display: flex;
            flex-direction: column;
            padding-left: var(--sal);
            padding-right: var(--sar);
        }

        header {
            padding-top: calc(0.5rem + var(--sat));
        }

        footer {
            padding-bottom: calc(1rem + var(--sab));
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .active-zone {
            background-color: #1d4ed8 !important;
            color: white !important;
            border-color: #1d4ed8 !important;
        }

        canvas {
            image-rendering: pixelated;
        }

        /* Estilização Customizada do Slider de Temperatura */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #1d4ed8;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            margin-top: -8px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
    </style>
</head>
<body class="overflow-hidden">

    <div class="app-container">
        <!-- Header -->
        <header class="bg-blue-700 text-white px-6 pb-4 shadow-lg flex-none">
            <div class="max-w-md mx-auto flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-black tracking-tighter flex items-center gap-2">
                        <i data-lucide="shield-alert" size="20"></i> SENTINELA STP
                    </h1>
                    <p class="text-[10px] font-bold opacity-80 uppercase tracking-widest">Saúde é Direito • Florianópolis</p>
                </div>
                <div id="status-badge" class="bg-blue-900/40 text-[9px] px-2 py-1 rounded-full border border-white/20 font-bold uppercase tracking-tighter">Standby</div>
            </div>
        </header>

        <!-- Main Content (Scrollable) -->
        <main class="flex-1 overflow-y-auto no-scrollbar bg-slate-50">
            <div class="max-w-md mx-auto p-4 space-y-4">
                
                <!-- Permissões Rapid Check -->
                <div class="bg-white p-3 rounded-2xl shadow-sm border border-slate-200 flex justify-around">
                    <div class="flex items-center gap-2 text-[10px] font-bold uppercase text-slate-400">
                        <span id="mic-dot" class="status-dot bg-slate-200"></span> Áudio
                    </div>
                    <div class="flex items-center gap-2 text-[10px] font-bold uppercase text-slate-400">
                        <span id="geo-dot" class="status-dot bg-slate-200"></span> GPS
                    </div>
                    <button onclick="requestPermissions()" class="text-[10px] font-black text-blue-600 uppercase underline">Autorizar</button>
                </div>

                <!-- Identificação do Veículo -->
                <section class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">Linha</label>
                            <input type="text" id="bus-line" placeholder="Ex: 233" 
                                class="w-full bg-slate-50 border border-slate-100 rounded-xl px-3 py-2 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-600">
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">Nº Ônibus</label>
                            <input type="number" id="bus-number" placeholder="0000" 
                                class="w-full bg-slate-50 border border-slate-100 rounded-xl px-3 py-2 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-600">
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase mb-2 block">Sua Posição</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="setZone('Frente')" id="zone-Frente" class="zone-btn py-2 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-bold uppercase">Frente</button>
                            <button onclick="setZone('Meio')" id="zone-Meio" class="zone-btn active-zone py-2 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-bold uppercase">Meio</button>
                            <button onclick="setZone('Fundo')" id="zone-Fundo" class="zone-btn py-2 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-bold uppercase">Fundo</button>
                        </div>
                    </div>
                </section>

                <!-- Medidor SPL -->
                <section id="meter-card" class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-200 text-center relative overflow-hidden">
                    <canvas id="audio-visualizer" class="absolute inset-0 w-full h-full opacity-10 pointer-events-none"></canvas>
                    <div id="danger-overlay" class="absolute inset-0 bg-red-600/10 opacity-0 pointer-events-none transition-opacity duration-300"></div>
                    
                    <div class="relative z-10">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Pressão Sonora</p>
                        <div class="flex justify-center items-baseline">
                            <span id="db-display" class="text-8xl font-black tracking-tighter tabular-nums">0</span>
                            <span class="text-2xl font-bold text-slate-300 ml-1">dB</span>
                        </div>
                        <div id="db-status" class="inline-block mt-3 px-4 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-slate-100 text-slate-400 italic">Sensores Off</div>
                        
                        <div class="mt-8 w-full h-2.5 bg-slate-100 rounded-full overflow-hidden">
                            <div id="db-progress" class="h-full bg-blue-600 w-0 transition-all duration-150"></div>
                        </div>
                    </div>
                </section>

                <!-- Temperatura -->
                <section class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-[11px] font-black text-slate-400 uppercase flex items-center gap-2">
                            <i data-lucide="thermometer" size="14"></i> Temp. Interna
                        </span>
                        <span id="temp-val" class="text-2xl font-black text-blue-700">25°C</span>
                    </div>
                    <input type="range" id="temp-input" min="15" max="45" value="25">
                </section>

                <!-- Evidências -->
                <section class="space-y-3 pb-8">
                    <div class="flex justify-between items-center px-1">
                        <h2 class="text-xs font-black text-slate-800 uppercase tracking-tight">Logs de Evidência</h2>
                        <button onclick="downloadCSV()" id="btn-csv" class="hidden text-[10px] font-black bg-slate-900 text-white px-4 py-2 rounded-xl uppercase shadow-md">Exportar CSV</button>
                    </div>
                    <div id="log-list" class="space-y-3">
                        <div id="empty-state" class="py-12 bg-white/40 rounded-3xl border-2 border-dashed border-slate-200 text-center">
                            <i data-lucide="database" class="mx-auto mb-2 text-slate-200" size="40"></i>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Nenhuma infração capturada</p>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <!-- Tab Bar / Footer -->
        <footer class="bg-white border-t border-slate-200 p-4 flex-none shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
            <div class="max-w-md mx-auto grid grid-cols-5 gap-4 items-center">
                <div class="col-span-1 flex flex-col items-center justify-center opacity-30 text-slate-600">
                    <i data-lucide="map-pin" size="20"></i>
                    <span id="gps-label" class="text-[8px] font-black mt-1 uppercase">OFF</span>
                </div>
                
                <button id="main-btn" class="col-span-4 bg-blue-600 active:scale-95 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-200 transition-all flex items-center justify-center gap-2 text-sm uppercase tracking-widest">
                    <i data-lucide="play" size="20"></i> Iniciar Fiscalização
                </button>
                
                <button id="stop-btn" class="hidden col-span-4 bg-red-600 active:scale-95 text-white font-black py-4 rounded-2xl shadow-xl shadow-red-200 transition-all flex items-center justify-center gap-2 text-sm uppercase tracking-widest">
                    <i data-lucide="square" size="20"></i> Parar Sensores
                </button>
            </div>
        </footer>
    </div>

    <script>
        lucide.createIcons();

        let audioCtx, analyser, mic, dataArr, animId;
        let isActive = false;
        let currentZone = "Meio";
        let logs = [];
        let lastLog = 0;
        let userStream = null;

        // Configs
        const DB_LIMIT = 85;
        const LOG_WAIT = 10000; 

        // UI Refs
        const dbDisplay = document.getElementById('db-display');
        const dbStatus = document.getElementById('db-status');
        const dbBar = document.getElementById('db-progress');
        const dangerLayer = document.getElementById('danger-overlay');
        const mainBtn = document.getElementById('main-btn');
        const stopBtn = document.getElementById('stop-btn');
        const gpsText = document.getElementById('gps-label');
        const tempSlider = document.getElementById('temp-input');
        const tempLabel = document.getElementById('temp-val');
        const logContainer = document.getElementById('log-list');
        const emptyView = document.getElementById('empty-state');
        const csvBtn = document.getElementById('btn-csv');
        const micDot = document.getElementById('mic-dot');
        const geoDot = document.getElementById('geo-dot');

        // Permissões iniciais
        window.onload = () => requestPermissions();

        async function requestPermissions() {
            try {
                userStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                micDot.className = "status-dot bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.4)]";
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((p) => {
                        geoDot.className = "status-dot bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.4)]";
                        gpsText.innerText = `${p.coords.latitude.toFixed(2)}, ${p.coords.longitude.toFixed(2)}`;
                        gpsText.parentElement.classList.remove('opacity-30');
                        gpsText.parentElement.classList.add('text-blue-600');
                    }, () => {
                        geoDot.className = "status-dot bg-red-500";
                    }, {enableHighAccuracy: true});
                }
            } catch (err) {
                micDot.className = "status-dot bg-red-500";
            }
        }

        function setZone(z) {
            currentZone = z;
            document.querySelectorAll('.zone-btn').forEach(b => b.classList.remove('active-zone'));
            document.getElementById(`zone-${z}`).classList.add('active-zone');
            if(navigator.vibrate) navigator.vibrate(20);
        }

        tempSlider.oninput = (e) => {
            const v = e.target.value;
            tempLabel.innerText = `${v}°C`;
            tempLabel.className = v >= 32 ? 'text-2xl font-black text-red-600 animate-pulse' : 'text-2xl font-black text-blue-700';
        };

        async function start() {
            if(!document.getElementById('bus-line').value) {
                alert("Identifique a linha de ônibus antes de começar.");
                return;
            }

            try {
                if(!userStream) userStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                const AC = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AC();
                if (audioCtx.state === 'suspended') await audioCtx.resume();
                
                analyser = audioCtx.createAnalyser();
                mic = audioCtx.createMediaStreamSource(userStream);
                analyser.fftSize = 256;
                dataArr = new Uint8Array(analyser.frequencyBinCount);
                mic.connect(analyser);

                isActive = true;
                mainBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                csvBtn.classList.remove('hidden');
                
                const badge = document.getElementById('status-badge');
                badge.innerText = "Monitorando";
                badge.className = "bg-red-600 text-[9px] px-2 py-1 rounded-full border border-red-400 font-black animate-pulse uppercase";

                loop();
            } catch (err) {
                alert("Falha ao acessar sensores.");
            }
        }

        function stop() {
            isActive = false;
            cancelAnimationFrame(animId);
            if(audioCtx) audioCtx.suspend();
            stopBtn.classList.add('hidden');
            mainBtn.classList.remove('hidden');
            dbDisplay.innerText = "0";
            dbBar.style.width = "0%";
            dangerLayer.style.opacity = "0";
            dbStatus.innerText = "Pausado";
            const badge = document.getElementById('status-badge');
            badge.innerText = "Standby";
            badge.className = "bg-blue-900/40 text-[9px] px-2 py-1 rounded-full border border-white/20 font-bold uppercase tracking-tighter";
        }

        function loop() {
            if(!isActive) return;
            analyser.getByteTimeDomainData(dataArr);
            
            // Desenho do waveform básico no canvas
            const canvas = document.getElementById('audio-visualizer');
            const cctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            cctx.clearRect(0,0,canvas.width,canvas.height);
            cctx.lineWidth = 2;
            cctx.strokeStyle = '#3b82f6';
            cctx.beginPath();
            let slice = canvas.width/dataArr.length;
            let x = 0;
            for(let i=0; i<dataArr.length; i++) {
                let v = dataArr[i]/128.0;
                let y = v * canvas.height/2;
                if(i===0) cctx.moveTo(x,y); else cctx.lineTo(x,y);
                x += slice;
            }
            cctx.stroke();

            // Cálculo dB
            let sum = 0;
            let sig = false;
            for(let i=0; i<dataArr.length; i++) {
                if(dataArr[i] !== 128) sig = true;
                let n = (dataArr[i]-128)/128;
                sum += n*n;
            }
            let rms = Math.sqrt(sum/dataArr.length);
            let db = sig ? Math.round(20 * Math.log10(rms) + 105) : 30;
            if(sig && db < 35) db = 35 + Math.floor(Math.random()*4);

            dbDisplay.innerText = db;
            let p = Math.min(Math.max((db-30)/(110-30)*100, 0), 100);
            dbBar.style.width = `${p}%`;

            if(db >= DB_LIMIT) {
                dbStatus.innerText = "⚠️ AGRESSÃO SONORA";
                dbStatus.className = "inline-block mt-3 px-4 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-red-100 text-red-600 animate-bounce";
                dbBar.className = "h-full bg-red-600";
                dangerLayer.style.opacity = "1";
                addRecord(db);
            } else {
                dbStatus.innerText = "Nível Seguro";
                dbStatus.className = "inline-block mt-3 px-4 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-blue-50 text-blue-500";
                dbBar.className = "h-full bg-blue-600";
                dangerLayer.style.opacity = "0";
            }

            animId = requestAnimationFrame(loop);
        }

        function addRecord(db) {
            const now = Date.now();
            if(now - lastLog < LOG_WAIT) return;
            lastLog = now;

            const rec = {
                t: new Date().toLocaleTimeString('pt-BR'),
                db: db,
                temp: tempSlider.value,
                line: document.getElementById('bus-line').value,
                bus: document.getElementById('bus-number').value || "S/N",
                zone: currentZone,
                loc: gpsText.innerText
            };

            logs.unshift(rec);
            renderRecords();
            if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
        }

        function renderRecords() {
            emptyView.classList.add('hidden');
            logContainer.innerHTML = '';
            logs.slice(0, 10).forEach(l => {
                const item = document.createElement('div');
                item.className = "bg-white p-4 rounded-2xl border-l-8 border-red-500 shadow-sm flex justify-between items-center";
                item.innerHTML = `
                    <div class="space-y-1">
                        <div class="flex gap-2">
                            <span class="bg-red-600 text-white text-[9px] font-black px-2 py-0.5 rounded tracking-tighter">${l.db}dB</span>
                            <span class="bg-blue-600 text-white text-[9px] font-black px-2 py-0.5 rounded tracking-tighter">${l.temp}°C</span>
                            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">${l.t}</span>
                        </div>
                        <p class="text-[13px] font-black text-slate-800">${l.line} <span class="text-slate-300 font-medium">#${l.bus}</span></p>
                    </div>
                    <div class="text-[9px] font-black text-slate-400 uppercase text-right leading-none">
                        Pos: ${l.zone}<br><span class="text-blue-500 font-bold">${l.loc}</span>
                    </div>
                `;
                logContainer.appendChild(item);
            });
        }

        function downloadCSV() {
            if(!logs.length) return;
            let c = "Hora,Ruido_dB,Temperatura,Linha,Onibus,Zona,Localizacao\n";
            logs.forEach(l => c += `${l.t},${l.db},${l.temp},${l.line},${l.bus},${l.zone},${l.loc}\n`);
            const b = new Blob([c], {type:'text/csv'});
            const u = window.URL.createObjectURL(b);
            const a = document.createElement('a');
            a.href = u;
            a.download = `STP_EVIDENCIA_${Date.now()}.csv`;
            a.click();
        }

        mainBtn.onclick = start;
        stopBtn.onclick = stop;
    </script>
</body>
</html>