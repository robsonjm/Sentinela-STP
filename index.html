<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Sentinela STP - Transporte Ã© SaÃºde</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        :root { --sat: env(safe-area-inset-top, 0px); --sab: env(safe-area-inset-bottom, 0px); }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; overscroll-behavior: none; -webkit-tap-highlight-color: transparent; }
        .app-container { height: 100dvh; display: flex; flex-direction: column; }
        header { padding-top: calc(0.5rem + var(--sat)); }
        footer { padding-bottom: calc(1rem + var(--sab)); }
        .active-zone { background-color: #1d4ed8 !important; color: white !important; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; transition: all 0.3s; }
        #toast { position: fixed; top: 5rem; left: 50%; transform: translate(-50%, -200%); z-index: 100; transition: transform 0.4s; }
        #toast.show { transform: translate(-50%, 0); }
        .symptom-chip { border: 1px solid #e2e8f0; transition: all 0.2s; }
        .symptom-chip.active { background-color: #dbeafe; border-color: #2563eb; color: #1e40af; }
    </style>
</head>
<body class="overflow-hidden">
    <div class="app-container">
        <!-- Toast de Sincronia -->
        <div id="toast" class="pointer-events-none">
            <div class="bg-slate-900/95 text-white text-[10px] font-bold px-4 py-2 rounded-full shadow-lg flex items-center gap-2 backdrop-blur-sm">
                <i data-lucide="cloud-check" size="14" class="text-green-400"></i>
                <span id="toast-msg">Sincronizando...</span>
            </div>
        </div>

        <header class="bg-blue-700 text-white px-4 pb-3 shadow-lg flex-none z-50">
            <div class="max-w-md mx-auto flex justify-between items-center">
                <h1 class="text-base font-black tracking-tighter flex items-center gap-1 uppercase">
                    <i data-lucide="shield-alert" size="16"></i> Sentinela STP
                </h1>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-1.5 bg-blue-800/40 px-2 py-1 rounded-md">
                        <span id="geo-dot" class="status-dot bg-slate-400"></span>
                        <span id="gps-label" class="text-[8px] font-black uppercase opacity-70">GPS OFF</span>
                    </div>
                    <div class="flex items-center gap-1.5 bg-blue-800/40 px-2 py-1 rounded-md">
                        <span id="cloud-dot" class="status-dot bg-slate-400"></span>
                        <span class="text-[8px] font-black uppercase tracking-tighter opacity-70">Nuvem</span>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto bg-slate-50 no-scrollbar">
            <div class="max-w-md mx-auto p-4 space-y-4">
                
                <!-- IdentificaÃ§Ã£o -->
                <section class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[9px] font-black text-slate-400 uppercase block mb-1">Linha Oficial</label>
                            <input list="fenix-lines" id="bus-line" placeholder="Busque a linha..." class="w-full bg-slate-50 border border-slate-100 rounded-xl px-3 py-2 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-600">
                            <datalist id="fenix-lines">
                                <option value="665 - AbraÃ£o"><option value="762 - Angelo Laporta"><option value="844 - Bairro de FÃ¡tima"><option value="V-844 - Bairro de FÃ¡tima">
                                <option value="V-661 - BalneÃ¡rio"><option value="661 - BalneÃ¡rio"><option value="763 - Caeira do Saco dos LimÃµes"><option value="V-662 - Canto via OtÃ­lia Cruz">
                                <option value="662 - Canto via OtÃ­lia Cruz"><option value="V-631 - Capoeiras"><option value="631 - Capoeiras"><option value="183 - Carianos via Saco dos LimÃµes">
                                <option value="772 - Chico Mendes"><option value="V-663 - Coloninha via Araci Vaz Callado"><option value="663 - Coloninha via Araci Vaz Callado">
                                <option value="630 - Corredor Continente"><option value="V-630 - Corredor Continente"><option value="664 - ItaguaÃ§u"><option value="V-670 - Monte Cristo">
                                <option value="670 - Monte Cristo"><option value="672 - Monte Cristo via Esc. Edith Gama Ramos"><option value="764 - Monte Serrat"><option value="V-764 - Monte Serrat via NEIM Evandro Sousa">
                                <option value="160 - Morro da Cruz"><option value="161 - Morro da PenitenciÃ¡ria"><option value="186 - Multi-hospital via TÃºnel"><option value="467 - Tapera / Saco dos LimÃµes">
                                <option value="210 - TICAN / TICEN Direto"><option value="221 - TICAN / TICEN via Mauro Ramos"><option value="233 - TICAN - UFSC via Santa MÃ´nica">
                                <option value="320 - TILAG / TICEN via Beira Mar"><option value="330 - TILAG / TICEN via Mauro Ramos"><option value="410 - TIRIO / TICEN Direto">
                                <option value="430 - TIRIO / TICEN via Costeira"><option value="110 - TITRI - TICEN Direto"><option value="133 - TITRI / TICEN via Mauro Ramos">
                                <option value="2120 - Executivo Barra da Lagoa"><option value="1120 - Executivo Canasvieiras"><option value="1121 - Executivo Ingleses / Santinho">
                                <option value="1123 - Executivo JurerÃª"><option value="1125 - Executivo Rio Vermelho"><option value="4123 - Executivo RibeirÃ£o da Ilha">
                                <option value="673 - Ponte Viva">
                            </datalist>
                        </div>
                        <div>
                            <label class="text-[9px] font-black text-slate-400 uppercase block mb-1">NÂº Ã”nibus</label>
                            <input type="number" id="bus-number" placeholder="Prefixo" class="w-full bg-slate-50 border border-slate-100 rounded-xl px-3 py-2 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-600">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 pt-1">
                        <button onclick="setZone('Frente')" id="zone-Frente" class="zone-btn py-2 bg-slate-50 border rounded-xl text-[10px] font-black uppercase">Frente</button>
                        <button onclick="setZone('Meio')" id="zone-Meio" class="zone-btn active-zone py-2 bg-slate-50 border rounded-xl text-[10px] font-black uppercase">Meio</button>
                        <button onclick="setZone('Fundo')" id="zone-Fundo" class="zone-btn py-2 bg-slate-50 border rounded-xl text-[10px] font-black uppercase">Fundo</button>
                    </div>
                </section>

                <!-- Medidor de RuÃ­do -->
                <section id="meter-card" class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-200 text-center relative overflow-hidden">
                    <canvas id="audio-visualizer" class="absolute inset-0 w-full h-full opacity-10 pointer-events-none"></canvas>
                    <div id="danger-overlay" class="absolute inset-0 bg-red-600/10 opacity-0 pointer-events-none transition-opacity"></div>
                    <div class="relative z-10">
                        <p class="text-[9px] font-black text-slate-400 uppercase mb-1 tracking-widest">PressÃ£o Sonora (dB)</p>
                        <div class="flex justify-center items-baseline">
                            <span id="db-display" class="text-8xl font-black tabular-nums tracking-tighter">0</span>
                            <span class="text-2xl font-bold text-slate-300 ml-1">dB</span>
                        </div>
                        <div class="mt-4 w-full h-2.5 bg-slate-100 rounded-full overflow-hidden">
                            <div id="db-progress" class="h-full bg-blue-600 w-0 transition-all duration-200"></div>
                        </div>
                        <div id="db-warning" class="text-[9px] font-bold text-slate-400 uppercase mt-2">Aguardando Captura...</div>
                    </div>
                </section>

                <!-- Relato de Impacto Pessoal -->
                <section class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase block text-center tracking-widest">Relato de Impacto (Opcional)</label>
                    <textarea id="personal-story" placeholder="Como isso afeta seu dia? Ex: Vou atrasar no trabalho, sinto tontura..." 
                        class="w-full bg-slate-50 border border-slate-100 rounded-xl p-3 text-xs font-medium outline-none focus:ring-2 focus:ring-blue-600 h-20 resize-none"></textarea>
                </section>

                <!-- Sintomas -->
                <section class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                    <label class="text-[10px] font-black text-slate-400 uppercase mb-3 block text-center tracking-widest">O que estÃ¡ sentindo?</label>
                    <div class="flex flex-wrap justify-center gap-2">
                        <button onclick="toggleSymptom(this, 'Dor de CabeÃ§a')" class="symptom-chip px-3 py-2 rounded-full text-[10px] font-black uppercase">Dor de CabeÃ§a</button>
                        <button onclick="toggleSymptom(this, 'Estresse')" class="symptom-chip px-3 py-2 rounded-full text-[10px] font-black uppercase">Estresse</button>
                        <button onclick="toggleSymptom(this, 'Tontura')" class="symptom-chip px-3 py-2 rounded-full text-[10px] font-black uppercase">Tontura</button>
                        <button onclick="toggleSymptom(this, 'Calor')" class="symptom-chip px-3 py-2 rounded-full text-[10px] font-black uppercase">Calor</button>
                    </div>
                </section>

                <!-- AÃ§Ãµes Especiais -->
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="logSpecialEvent('Quebra de VeÃ­culo')" class="bg-orange-50 border border-orange-100 p-4 rounded-2xl text-center active:scale-95 transition-all">
                        <i data-lucide="wrench" class="mx-auto mb-1 text-orange-600" size="20"></i>
                        <span class="text-[9px] font-black text-orange-800 uppercase block">Ã”nibus Quebrado</span>
                    </button>
                    <button onclick="logSpecialEvent('Atraso CrÃ­tico')" class="bg-purple-50 border border-purple-100 p-4 rounded-2xl text-center active:scale-95 transition-all">
                        <i data-lucide="clock" class="mx-auto mb-1 text-purple-600" size="20"></i>
                        <span class="text-[9px] font-black text-purple-800 uppercase block">Atraso CrÃ­tico</span>
                    </button>
                </div>

                <!-- Temperatura -->
                <section class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[10px] font-black text-slate-400 uppercase">Temperatura Manual</span>
                        <span id="temp-val" class="text-xl font-black text-blue-700">25Â°C</span>
                    </div>
                    <input type="range" id="temp-input" min="15" max="45" value="25" class="w-full h-2 bg-slate-100 rounded-lg appearance-none cursor-pointer">
                </section>

                <div id="log-list" class="space-y-2 pb-8"></div>
            </div>
        </main>

        <footer class="bg-white border-t border-slate-200 p-4 flex-none shadow-lg z-50">
            <div class="max-w-md mx-auto flex gap-4 items-center">
                <button id="status-btn" onclick="requestPermissions()" class="w-12 h-12 flex items-center justify-center bg-slate-100 rounded-2xl text-slate-400">
                    <i data-lucide="map-pin-off" id="gps-icon" size="20"></i>
                </button>
                <button id="main-btn" class="flex-1 bg-blue-600 active:scale-95 text-white font-black py-4 rounded-2xl shadow-xl flex items-center justify-center gap-2 text-xs uppercase tracking-widest transition-all">
                    <i data-lucide="play" size="18"></i> Iniciar FiscalizaÃ§Ã£o
                </button>
                <button id="stop-btn" class="hidden flex-1 bg-red-600 active:scale-95 text-white font-black py-4 rounded-2xl shadow-xl flex items-center justify-center gap-2 text-xs uppercase tracking-widest transition-all">
                    <i data-lucide="square" size="18"></i> Parar Sensores
                </button>
            </div>
        </footer>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBwXw-f03A0mEfw3-RHc5A-1paido_ZDhM",
          authDomain: "sentinela-stp.firebaseapp.com",
          projectId: "sentinela-stp",
          storageBucket: "sentinela-stp.firebasestorage.app",
          messagingSenderId: "845865605498",
          appId: "1:845865605498:web:f4823825b7114d08dcdec3",
          measurementId: "G-6DT4QG0RVT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let user = null;

        signInAnonymously(auth);
        onAuthStateChanged(auth, u => {
            user = u;
            document.getElementById('cloud-dot').className = user ? "status-dot bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.4)]" : "status-dot bg-red-500";
        });

        // FunÃ§Ã£o de GeocalizaÃ§Ã£o de Alta Fidelidade (Promisified) com melhor tratamento de erro
        const getPreciseLocation = () => {
            return new Promise((resolve) => {
                if (!navigator.geolocation) return resolve("Sem Suporte");
                navigator.geolocation.getCurrentPosition(
                    (p) => resolve(`${p.coords.latitude.toFixed(6)}, ${p.coords.longitude.toFixed(6)}`),
                    (err) => {
                        console.error("Erro GPS:", err);
                        resolve(`Erro: ${err.message}`);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        };

        window.saveLogToCloud = async (rec) => {
            if (!user) {
                window.showToast("Erro: NÃ£o autenticado na nuvem.");
                return;
            }
            const story = document.getElementById('personal-story').value;
            const coords = await getPreciseLocation(); 
            
            try {
                await addDoc(collection(db, 'artifacts', 'sentinela-stp', 'public', 'data', 'evidencias'), {
                    ...rec,
                    relato_pessoal: story,
                    coordenadas: coords,
                    userId: user.uid,
                    timestamp: serverTimestamp(),
                    audit: { deviceId: localStorage.getItem('stp_id') || (localStorage.setItem('stp_id', crypto.randomUUID()), localStorage.getItem('stp_id')) }
                });
                document.getElementById('personal-story').value = "";
                window.showToast("Dados Sincronizados âœ“");
            } catch (err) { 
                console.error("Erro ao salvar:", err);
                window.showToast("Erro ao sincronizar dados.");
            }
        };
    </script>

    <script>
        lucide.createIcons();
        let audioCtx, analyser, mic, dataArr, animId, isActive = false, lastLog = 0, currentZone = "Meio", activeSymptoms = [], userStream = null;

        const dbDisplay = document.getElementById('db-display');
        const dbBar = document.getElementById('db-progress');
        const tempSlider = document.getElementById('temp-input');
        const tempLabel = document.getElementById('temp-val');

        window.showToast = (msg) => {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        };

        async function requestPermissions() {
            // Verifica se estÃ¡ em contexto seguro (HTTPS)
            if (window.location.protocol === 'http:' && window.location.hostname !== 'localhost') {
                window.showToast("Erro: Sensores exigem HTTPS!");
                return;
            }

            try {
                // Ãudio
                userStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                document.getElementById('mic-dot').className = "status-dot bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.4)]";
                
                // LocalizaÃ§Ã£o
                navigator.geolocation.watchPosition(p => {
                    document.getElementById('geo-dot').className = "status-dot bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.4)]";
                    document.getElementById('gps-label').innerText = "GPS ATIVO";
                    const gpsIcon = document.getElementById('gps-icon');
                    gpsIcon.setAttribute('data-lucide', 'map-pin');
                    gpsIcon.parentElement.classList.replace('text-slate-400', 'text-blue-600');
                    lucide.createIcons();
                }, (err) => {
                    console.warn("GPS Denied or Error:", err);
                    document.getElementById('geo-dot').className = "status-dot bg-red-500";
                    window.showToast("Permita a localizaÃ§Ã£o no navegador!");
                }, { enableHighAccuracy: true });

            } catch(e) { 
                console.error("Mic Error:", e);
                document.getElementById('mic-dot').className = "status-dot bg-red-500";
                window.showToast("Permita o microfone no navegador!");
            }
        }

        function setZone(z) {
            currentZone = z;
            document.querySelectorAll('.zone-btn').forEach(b => b.classList.remove('active-zone'));
            document.getElementById(`zone-${z}`).classList.add('active-zone');
        }

        function toggleSymptom(el, name) {
            el.classList.toggle('active');
            if(el.classList.contains('active')) activeSymptoms.push(name);
            else activeSymptoms = activeSymptoms.filter(s => s !== name);
        }

        tempSlider.oninput = (e) => { tempLabel.innerText = `${e.target.value}Â°C`; };

        async function start() {
            if(!document.getElementById('bus-line').value) {
                window.showToast("Identifique a linha primeiro!");
                return;
            }
            
            try {
                if(!userStream) await requestPermissions();
                
                const AC = window.AudioContext || window.webkitAudioContext;
                if (!audioCtx) audioCtx = new AC();
                if (audioCtx.state === 'suspended') await audioCtx.resume();
                
                analyser = audioCtx.createAnalyser();
                mic = audioCtx.createMediaStreamSource(userStream);
                analyser.fftSize = 256;
                dataArr = new Uint8Array(analyser.frequencyBinCount);
                mic.connect(analyser);
                
                isActive = true;
                document.getElementById('main-btn').classList.add('hidden');
                document.getElementById('stop-btn').classList.remove('hidden');
                document.getElementById('status-badge').innerText = "FISCALIZANDO";
                document.getElementById('status-badge').className = "bg-red-600 text-[8px] px-2 py-1 rounded-full font-black animate-pulse";
                loop();
            } catch (err) {
                console.error("Start Error:", err);
                window.showToast("Erro ao iniciar sensores. Tente recarregar.");
            }
        }

        function loop() {
            if(!isActive) return;
            analyser.getByteTimeDomainData(dataArr);
            let sum = 0; for(let i=0; i<dataArr.length; i++) { let n = (dataArr[i]-128)/128; sum += n*n; }
            let db = Math.round(20 * Math.log10(Math.sqrt(sum/dataArr.length) || 0.0001) + 105);
            dbDisplay.innerText = Math.max(db, 30);
            dbBar.style.width = `${Math.min((db/110)*100, 100)}%`;
            
            if(db >= 85) {
                document.getElementById('danger-overlay').style.opacity = "1";
                document.getElementById('db-warning').innerText = "ðŸ”Š EXCESSO DETECTADO!";
                document.getElementById('db-warning').classList.add('text-red-500');
                addRecord(db);
            } else {
                document.getElementById('danger-overlay').style.opacity = "0";
                document.getElementById('db-warning').innerText = "CAPTURANDO...";
                document.getElementById('db-warning').classList.remove('text-red-500');
            }
            animId = requestAnimationFrame(loop);
        }

        async function addRecord(db, tipo = "RuÃ­do Elevado") {
            const now = Date.now(); if(now - lastLog < 15000) return; lastLog = now;
            const rec = {
                tipo_evento: tipo, ruido_db: db, temp_interna: tempSlider.value, sintomas: activeSymptoms.join(', '),
                linha: document.getElementById('bus-line').value, prefixo: document.getElementById('bus-number').value || "S/N",
                zona: currentZone, hora: new Date().toLocaleTimeString(), data: new Date().toLocaleDateString()
            };
            if (window.saveLogToCloud) window.saveLogToCloud(rec);
            renderLocalLog(rec);
        }

        async function logSpecialEvent(tipo) { await addRecord(dbDisplay.innerText, tipo); }

        function renderLocalLog(l) {
            const container = document.getElementById('log-list');
            const d = document.createElement('div');
            d.className = "bg-white p-3 rounded-xl border-l-4 border-blue-500 shadow-sm text-[10px] font-bold";
            d.innerHTML = `${l.tipo_evento} - ${l.linha} (#${l.prefixo}) <span class="float-right opacity-40">${l.hora}</span>`;
            container.prepend(d);
        }

        function stop() { 
            isActive = false; 
            document.getElementById('stop-btn').classList.add('hidden'); 
            document.getElementById('main-btn').classList.remove('hidden'); 
            document.getElementById('status-badge').innerText = "Inativo"; 
            document.getElementById('status-badge').className = "bg-blue-900/50 text-[8px] px-2 py-1 rounded-full font-bold uppercase"; 
        }
        
        document.getElementById('main-btn').onclick = start;
        document.getElementById('stop-btn').onclick = stop;
    </script>
</body>
</html>