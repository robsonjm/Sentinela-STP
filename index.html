<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Sentinela STP - Transporte é Saúde</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        :root {
            --sat: env(safe-area-inset-top, 0px);
            --sab: env(safe-area-inset-bottom, 0px);
            --sal: env(safe-area-inset-left, 0px);
            --sar: env(safe-area-inset-right, 0px);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            touch-action: manipulation;
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
            background-color: #f8fafc; 
        }

        .app-container {
            height: 100dvh;
            display: flex;
            flex-direction: column;
            padding-left: var(--sal);
            padding-right: var(--sar);
        }

        header { padding-top: calc(0.5rem + var(--sat)); }
        footer { padding-bottom: calc(1rem + var(--sab)); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .active-zone {
            background-color: #1d4ed8 !important;
            color: white !important;
            border-color: #1d4ed8 !important;
        }

        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        #toast {
            position: fixed;
            top: calc(4.5rem + var(--sat));
            left: 50%;
            transform: translate(-50%, -200%);
            z-index: 100;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: fit-content;
        }
        #toast.show { transform: translate(-50%, 0); }

        .symptom-chip {
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
        }
        .symptom-chip.active {
            background-color: #dbeafe;
            border-color: #2563eb;
            color: #1e40af;
        }
    </style>
</head>
<body class="overflow-hidden">

    <div class="app-container">
        <!-- Notificação Toast -->
        <div id="toast" class="pointer-events-none">
            <div class="bg-slate-900/95 text-white text-[10px] font-bold px-4 py-2 rounded-full shadow-lg flex items-center gap-2 backdrop-blur-sm">
                <i data-lucide="cloud-check" size="14" class="text-green-400"></i>
                <span id="toast-msg">Sincronizando...</span>
            </div>
        </div>

        <!-- Header -->
        <header class="bg-blue-700 text-white px-4 pb-3 shadow-lg flex-none relative z-50">
            <div class="max-w-md mx-auto flex justify-between items-center gap-2">
                <div class="flex flex-col">
                    <h1 class="text-base font-black tracking-tighter flex items-center gap-1">
                        <i data-lucide="shield-alert" size="16"></i> SENTINELA STP
                    </h1>
                </div>

                <div id="cloud-indicator" class="flex items-center gap-1.5 bg-blue-800/40 px-2 py-1 rounded-md border border-blue-400/20">
                    <span id="cloud-dot" class="status-dot bg-slate-400"></span>
                    <span class="text-[8px] font-black uppercase tracking-tighter opacity-70">Nuvem</span>
                </div>

                <div id="status-badge" class="bg-blue-900/50 text-[8px] px-2 py-1 rounded-full border border-blue-400/50 font-bold uppercase tracking-widest shrink-0 text-center">Inativo</div>
            </div>
        </header>

        <!-- Conteúdo Principal -->
        <main class="flex-1 overflow-y-auto no-scrollbar bg-slate-50">
            <div class="max-w-md mx-auto p-4 space-y-4">
                
                <!-- Status de Sensores -->
                <div class="bg-white p-3 rounded-2xl shadow-sm border border-slate-200 flex justify-around">
                    <div class="flex items-center gap-2 text-[9px] font-bold uppercase text-slate-400">
                        <span id="mic-dot" class="status-dot bg-slate-200"></span> Áudio
                    </div>
                    <div class="flex items-center gap-2 text-[9px] font-bold uppercase text-slate-400">
                        <span id="geo-dot" class="status-dot bg-slate-200"></span> GPS
                    </div>
                    <button onclick="requestPermissions()" class="text-[9px] font-black text-blue-600 uppercase underline">Autorizar Sensores</button>
                </div>

                <!-- Identificação do Veículo -->
                <section class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="relative">
                            <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block tracking-wider">Linha Oficial</label>
                            <input list="fenix-lines" id="bus-line" placeholder="Busque a linha..." 
                                class="w-full bg-slate-50 border border-slate-100 rounded-xl px-3 py-2 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-600">
                            <datalist id="fenix-lines">
                                <!-- Alimentadoras TICEN / Continente -->
                                <option value="665 - Abraão"><option value="762 - Angelo Laporta"><option value="844 - Bairro de Fátima"><option value="V-844 - Bairro de Fátima">
                                <option value="V-661 - Balneário"><option value="661 - Balneário"><option value="763 - Caeira do Saco dos Limões"><option value="V-662 - Canto via Otília Cruz">
                                <option value="662 - Canto via Otília Cruz"><option value="V-631 - Capoeiras"><option value="631 - Capoeiras"><option value="183 - Carianos via Saco dos Limões">
                                <option value="772 - Chico Mendes"><option value="V-663 - Coloninha via Araci Vaz Callado"><option value="663 - Coloninha via Araci Vaz Callado">
                                <option value="630 - Corredor Continente"><option value="V-630 - Corredor Continente"><option value="664 - Itaguaçu"><option value="V-670 - Monte Cristo">
                                <option value="670 - Monte Cristo"><option value="672 - Monte Cristo via Esc. Edith Gama Ramos"><option value="764 - Monte Serrat"><option value="V-764 - Monte Serrat via NEIM Evandro Sousa">
                                <option value="160 - Morro da Cruz"><option value="161 - Morro da Penitenciária"><option value="765 - Morro da Queimada"><option value="766 - Morro do 25">
                                <option value="760 - Morro do Geraldo"><option value="768 - Morro do Horácio"><option value="769 - Morro Nova Trento"><option value="186 - Multi-hospital via Túnel">
                                <option value="460 - Porto da Lagoa"><option value="467 - Tapera / Saco dos Limões"><option value="461 - Tapera via Túnel"><option value="154 - TICEN - Carvoeira via Pantanal">
                                <option value="188 - TICEN - UFSC"><option value="431 - TICEN - Aeroporto"><option value="104 - TICEN / Itacorubi via Mauro Ramos"><option value="476 - TICEN / Tapera">
                                <option value="191 - TITRI / TICEN via Transcaeira"><option value="184 - UDESC via Beira Mar"><option value="V-671 - Vila / Promorar"><option value="671 - Vila / Promorar">
                                <option value="761 - Vila Aparecida"><option value="137 - Volta ao Morro Norte via H.U."><option value="135 - Volta ao Morro Norte via Lauro Linhares">
                                <option value="136 - Volta ao Morro Sul via H.U."><option value="138 - Volta ao Morro Sul via Lauro Linhares">
                                <!-- Troncal (Inter-Terminal) -->
                                <option value="230 - TICAN - Gama D'Eça via TITRI"><option value="224 - TICAN - TITRI via Virgílio Várzea"><option value="233 - TICAN - UFSC via Santa Mônica">
                                <option value="210 - TICAN / TICEN Direto"><option value="221 - TICAN / TICEN via Mauro Ramos"><option value="231 - TICAN / TICEN via TITRI">
                                <option value="840 - TICAN - TILAG via Barra da Lagoa"><option value="132 - TITRI - TICEN via Gama D'Eça/H.I"><option value="850 - TILAG / Rio Vermelho via Cidade da Barra">
                                <option value="320 - TILAG / TICEN via Beira Mar"><option value="330 - TILAG / TICEN via Mauro Ramos"><option value="841 - TILAG / TIRIO"><option value="843 - TILAG / TIRIO via LIC">
                                <option value="845 - TILAG / TITRI via Córrego Grande"><option value="333 - TILAG / TITRI via Madre Benvenuta"><option value="410 - TIRIO / TICEN Direto">
                                <option value="430 - TIRIO / TICEN via Costeira"><option value="847 - TIRIO - TITRI via UFSC"><option value="212 - TISAN - TICEN Direto">
                                <option value="332 - TISAN / TICEN via Beira Mar"><option value="331 - TISAN / TICEN via Mauro Ramos"><option value="110 - TITRI - TICEN Direto">
                                <option value="131 - TITRI - TICEN via Gama D'Eça"><option value="133 - TITRI / TICEN via Mauro Ramos">
                                <!-- Executivo -->
                                <option value="2120 - Executivo Barra da Lagoa"><option value="1126 - Executivo Cachoeira"><option value="4124 - Executivo Caieira da Barra do Sul via Tapera">
                                <option value="1120 - Executivo Canasvieiras"><option value="1128 - Executivo Costa do Moçambique"><option value="1132 - Executivo Costa do Moçambique via Vargem Grande">
                                <option value="1127 - Executivo Gaivotas"><option value="1121 - Executivo Ingleses / Santinho"><option value="1123 - Executivo Jurerê"><option value="1129 - Executivo Muquém">
                                <option value="4120 - Executivo Pântano do Sul via Eucaliptos"><option value="4125 - Executivo Pântano do Sul via Gramal"><option value="1122 - Executivo Praia Brava">
                                <option value="4123 - Executivo Ribeirão da Ilha"><option value="1125 - Executivo Rio Vermelho">
                                <!-- Convencional -->
                                <option value="673 - Ponte Viva">
                                <!-- Alimentadoras TICAN -->
                                <option value="276 - Balneário Canasvieiras"><option value="277 - Balneário Ingleses"><option value="280 - Cachoeira - TICAN"><option value="260 - Cachoeira do Bom Jesus">
                                <option value="261 - Capivari"><option value="V-261 - Capivari via SC-403"><option value="262 - Circular Canasvieiras"><option value="285 - Circular Moçambique">
                                <option value="288 - Circular Rio Vermelho"><option value="281 - Costa do Moçambique"><option value="250 - Forte / Canasvieiras"><option value="V-250 - Forte / Canasvieiras via Col. Virgílio Várzea">
                                <option value="263 - Gaivotas"><option value="269 - Moçambique via Rua Alzira Rosa Aguiar"><option value="265 - Ponta das Canas"><option value="266 - Praia Brava">
                                <option value="267 - Rio Vermelho"><option value="287 - Rio Vermelho via Vargem Grande"><option value="264 - Santinho via Ingleses"><option value="268 - Sítio de Baixo">
                                <option value="274 - Tulipas Vermelhas via Muquém"><option value="283 - Vargem do Bom Jesus"><option value="270 - Vargem Grande"><option value="289 - Circular Vargem Grande via Rio Vermelho">
                                <option value="282 - Vargem Pequena"><option value="V-282 - Vargem Pequena via Esc. Prof. Zulma Freitas">
                                <!-- Alimentadoras TITRI -->
                                <option value="846 - Cacupé"><option value="V-846 - Cacupé via Caminho dos Açores"><option value="170 - Caminho da Cruz via João Paulo"><option value="151 - Centro Administrativo">
                                <option value="164 - Córrego Grande via Poção"><option value="165 - Itacorubi"><option value="169 - Monte Verde via Mané Vicente"><option value="173 - Morro do Quilombo">
                                <option value="V-173 - Morro do Quilombo via SC 404"><option value="178 - Saco Grande Retorno SC-401"><option value="176 - Saco Grande via HU"><option value="174 - Saco Grande via João Paulo">
                                <option value="V-174 - Saco Grande via João Paulo / Barreira do Janga"><option value="177 - Santa Mônica"><option value="179 - Serrinha"><option value="155 - Sol Nascente">
                                <option value="470 - Tapera / TITRI"><option value="180 - TITRI - Pantanal via Carvoeira">
                                <!-- Alimentadoras TISAN -->
                                <option value="366 - Barra do Sambaqui via Padre Rohr"><option value="181 - Cacupé - João Paulo"><option value="940 - Canasvieiras / Santo Antônio via Jurerê">
                                <option value="273 - Circular Ratones"><option value="271 - Daniela"><option value="272 - Jurerê"><option value="365 - Sambaqui">
                                <!-- Inter-Regional e Madrugadão -->
                                <option value="601 - Circular Abraão - Estreito"><option value="291 - Circular Canasvieiras/Praia Brava"><option value="605 - Circular Estreito - Abraão"><option value="296 - Circular Santinho Ingleses">
                                <option value="294 - Interpraias"><option value="100 - Madrugadão Centro - UFSC Norte"><option value="102 - Madrugadão Centro / UFSC Sul"><option value="600 - Madrugadão Continente Norte">
                                <option value="604 - Madrugadão Continente Sul"><option value="300 - Madrugadão Leste"><option value="201 - Madrugadão Norte - Jurerê / Canasvieiras"><option value="200 - Madrugadão Norte - Rio Vermelho / Santinho">
                                <option value="301 - Madrugadão Norte - Santo Antônio / TICAN"><option value="500 - Madrugadão Sul - Pântano do Sul"><option value="501 - Madrugadão Sul - Ribeirão">
                                <option value="720 - Monte Serrat - Serrinha"><option value="722 - Morro do 25 - Morro da Cruz"><option value="721 - Morro do Horácio - Saco dos Limões">
                                <option value="D-564 - Pântano do Sul"><option value="D-565 - Ribeirão da Ilha"><option value="D-260 - TICEN / Cachoeira do Bom Jesus via Mauro Ramos">
                                <option value="D-264 - TICEN / Ingleses via Mauro Ramos"><option value="D-266 - TICEN / Praia Brava via Mauro Ramos"><option value="D-267 - TICEN / Rio Vermelho via Mauro Ramos">
                                <!-- Alimentadoras TIRIO -->
                                <option value="560 - Armação"><option value="561 - Caieira da Barra do Sul"><option value="462 - Campeche"><option value="562 - Costa de Cima">
                                <option value="V-562 - Costa de Cima via Costa de Dentro"><option value="563 - Costa de Dentro"><option value="V-563 - Costa de Dentro via Costa de Cima"><option value="473 - Morro das Pedras via Eucaliptos">
                                <option value="474 - Morro das Pedras via Gramal"><option value="564 - Pântano do Sul"><option value="565 - Ribeirão da Ilha"><option value="469 - Tapera / TIRIO">
                                <option value="477 - TIRIO / Aeroporto via Tapera"><option value="V-468 - TIRIO / Multihospital via Aeroporto"><option value="468 - TIRIO / Multihospital">
                                <!-- Alimentadoras TILAG -->
                                <option value="360 - Barra da Lagoa"><option value="V-360 - Barra da Lagoa via Terminal Lacustre"><option value="362 - Canto dos Araçás"><option value="363 - Joaquina"><option value="364 - Osni Ortiga">
                            </datalist>
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block tracking-wider">Nº Ônibus</label>
                            <input type="number" id="bus-number" placeholder="Prefixo" 
                                class="w-full bg-slate-50 border border-slate-100 rounded-xl px-3 py-2 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-600">
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase mb-2 block tracking-wider text-center">Onde você está no veículo?</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="setZone('Frente')" id="zone-Frente" class="zone-btn py-2 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-bold uppercase transition-all active:scale-95">Frente</button>
                            <button onclick="setZone('Meio')" id="zone-Meio" class="zone-btn active-zone py-2 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-bold uppercase transition-all active:scale-95">Meio</button>
                            <button onclick="setZone('Fundo')" id="zone-Fundo" class="zone-btn py-2 bg-slate-50 border border-slate-100 rounded-xl text-[11px] font-bold uppercase transition-all active:scale-95">Fundo</button>
                        </div>
                    </div>
                </section>

                <!-- Medidor SPL -->
                <section id="meter-card" class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-200 text-center relative overflow-hidden">
                    <canvas id="audio-visualizer" class="absolute inset-0 w-full h-full opacity-10 pointer-events-none"></canvas>
                    <div id="danger-overlay" class="absolute inset-0 bg-red-600/10 opacity-0 pointer-events-none transition-opacity duration-300"></div>
                    
                    <div class="relative z-10">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Pressão Sonora em Tempo Real</p>
                        <div class="flex justify-center items-baseline">
                            <span id="db-display" class="text-8xl font-black tracking-tighter tabular-nums text-slate-800">0</span>
                            <span class="text-2xl font-bold text-slate-300 ml-1">dB</span>
                        </div>
                        
                        <div id="db-comparison" class="text-[9px] font-bold text-blue-500 uppercase mt-1 opacity-60">Aguardando Captura</div>
                        
                        <div class="mt-8 w-full h-2.5 bg-slate-100 rounded-full overflow-hidden">
                            <div id="db-progress" class="h-full bg-blue-600 w-0 transition-all duration-150"></div>
                        </div>
                        <div class="flex justify-between mt-2 text-[8px] font-bold text-slate-400 uppercase">
                            <span>Mínimo</span>
                            <span class="text-red-500 font-black">Risco à Saúde: 85dB</span>
                            <span>Máximo</span>
                        </div>
                    </div>
                </section>

                <!-- Impacto na Saúde (Sintomas) -->
                <section class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                    <label class="text-[10px] font-black text-slate-400 uppercase mb-3 block text-center tracking-widest">O que você está sentindo agora?</label>
                    <div class="flex flex-wrap justify-center gap-2">
                        <button onclick="toggleSymptom(this, 'Dor de Cabeça')" class="symptom-chip px-3 py-1.5 rounded-full text-[10px] font-bold uppercase">Dor de Cabeça</button>
                        <button onclick="toggleSymptom(this, 'Estresse')" class="symptom-chip px-3 py-1.5 rounded-full text-[10px] font-bold uppercase">Estresse</button>
                        <button onclick="toggleSymptom(this, 'Tontura')" class="symptom-chip px-3 py-1.5 rounded-full text-[10px] font-bold uppercase">Tontura</button>
                        <button onclick="toggleSymptom(this, 'Calor Excessivo')" class="symptom-chip px-3 py-1.5 rounded-full text-[10px] font-bold uppercase">Calor</button>
                    </div>
                </section>

                <!-- Ocorrências Especiais (Quebra/Atraso) -->
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="logSpecialEvent('Quebra de Veículo')" class="bg-orange-50 border border-orange-100 p-3 rounded-2xl text-center active:scale-95 transition-all">
                        <i data-lucide="wrench" class="mx-auto mb-1 text-orange-600" size="18"></i>
                        <span class="text-[9px] font-black text-orange-800 uppercase block">Veículo Quebrado</span>
                    </button>
                    <button onclick="logSpecialEvent('Atraso Crítico')" class="bg-purple-50 border border-purple-100 p-3 rounded-2xl text-center active:scale-95 transition-all">
                        <i data-lucide="clock" class="mx-auto mb-1 text-purple-600" size="18"></i>
                        <span class="text-[9px] font-black text-purple-800 uppercase block">Atraso Crítico</span>
                    </button>
                </div>

                <!-- Temperatura -->
                <section class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-[11px] font-black text-slate-400 uppercase flex items-center gap-2">
                            <i data-lucide="thermometer" size="14"></i> Temp. Interna (Manual)
                        </span>
                        <span id="temp-val" class="text-2xl font-black text-blue-700">25°C</span>
                    </div>
                    <input type="range" id="temp-input" min="15" max="45" value="25" class="w-full h-2 bg-slate-100 rounded-lg appearance-none cursor-pointer">
                </section>

                <!-- Manifesto e Base Jurídica -->
                <button onclick="openManifesto()" class="w-full bg-slate-800 text-white p-4 rounded-2xl flex items-center justify-between group">
                    <div class="flex items-center gap-3 text-left">
                        <i data-lucide="book-open" size="20" class="text-blue-400"></i>
                        <div>
                            <p class="text-[10px] font-black uppercase tracking-widest text-blue-400">Base Jurídica</p>
                            <p class="text-xs font-bold text-slate-300">Lei 8.080 e Seus Direitos</p>
                        </div>
                    </div>
                    <i data-lucide="chevron-right" size="18" class="text-slate-500 group-hover:translate-x-1 transition-transform"></i>
                </button>

                <!-- Denúncias Coletadas -->
                <section class="space-y-3 pb-8">
                    <div class="flex justify-between items-center px-1">
                        <h2 class="text-xs font-black text-slate-800 uppercase tracking-widest">Suas Denúncias</h2>
                        <button onclick="downloadCSV()" id="btn-csv" class="hidden text-[10px] font-black bg-slate-900 text-white px-3 py-1.5 rounded-xl uppercase">Exportar</button>
                    </div>
                    <div id="empty-state" class="py-12 bg-white/40 rounded-3xl border-2 border-dashed border-slate-200 text-center">
                        <i data-lucide="database" class="mx-auto mb-2 text-slate-200" size="40"></i>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Aguardando dados</p>
                    </div>
                    <div id="log-list" class="space-y-3">
                        <!-- Itens inseridos aqui -->
                    </div>
                </section>
            </div>
        </main>

        <!-- Rodapé -->
        <footer class="bg-white border-t border-slate-200 p-4 flex-none shadow-[0_-4px_20px_rgba(0,0,0,0.05)] relative z-50">
            <div class="max-w-md mx-auto grid grid-cols-5 gap-4 items-center">
                <div class="col-span-1 flex flex-col items-center justify-center opacity-30 text-slate-600">
                    <i data-lucide="map-pin" size="20"></i>
                    <span id="gps-label" class="text-[8px] font-black mt-1 uppercase">OFF</span>
                </div>
                
                <button id="main-btn" class="col-span-4 bg-blue-600 active:bg-blue-800 active:scale-95 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-200 transition-all flex items-center justify-center gap-2 text-sm uppercase tracking-widest">
                    <i data-lucide="play" size="20"></i> Iniciar Fiscalização
                </button>
                
                <button id="stop-btn" class="hidden col-span-4 bg-red-600 active:bg-red-800 active:scale-95 text-white font-black py-4 rounded-2xl shadow-xl shadow-red-200 transition-all flex items-center justify-center gap-2 text-sm uppercase tracking-widest">
                    <i data-lucide="square" size="20"></i> Parar Sensores
                </button>
            </div>
        </footer>
    </div>

    <!-- Modal Manifesto -->
    <div id="modal-manifesto" class="fixed inset-0 bg-black/60 z-[200] hidden items-end justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-6 space-y-6 animate-in slide-in-from-bottom duration-300 max-h-[80vh] overflow-y-auto no-scrollbar">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-black text-slate-800 tracking-tighter">Manifesto Florianópolis</h2>
                <button onclick="closeManifesto()" class="p-2 bg-slate-100 rounded-full"><i data-lucide="x" size="18"></i></button>
            </div>
            <div class="space-y-4 text-xs leading-relaxed text-slate-600 font-medium">
                <p class="font-black text-blue-700 uppercase tracking-widest border-b pb-1">Transporte é Direito (Lei 8.080)</p>
                <p>O transporte público é um determinante social da saúde. Ônibus barulhentos e quentes não são apenas ineficientes, são patogênicos.</p>
                <p class="font-black text-red-600 uppercase tracking-widest border-b pb-1">Seus Direitos em Campo</p>
                <ul class="space-y-2 list-disc pl-4">
                    <li>Ruído > 85dB = Agressão Física.</li>
                    <li>Calor > 30°C = Estresse Térmico.</li>
                    <li>Em caso de quebra, o reembolso ou transporte imediato é obrigatório.</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Scripts Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBwXw-f03A0mEfw3-RHc5A-1paido_ZDhM",
          authDomain: "sentinela-stp.firebaseapp.com",
          projectId: "sentinela-stp",
          storageBucket: "sentinela-stp.firebasestorage.app",
          messagingSenderId: "845865605498",
          appId: "1:845865605498:web:f4823825b7114d08dcdec3",
          measurementId: "G-6DT4QG0RVT"
        };

        const appId = 'sentinela-stp';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let user = null;
        const cloudDot = document.getElementById('cloud-dot');
        const toast = document.getElementById('toast');
        const toastMsg = document.getElementById('toast-msg');

        window.showToast = (msg) => {
            toastMsg.innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        };

        signInAnonymously(auth);
        onAuthStateChanged(auth, (u) => {
            user = u;
            cloudDot.className = user ? "status-dot bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.4)]" : "status-dot bg-red-500";
        });

        const getAuditInfo = () => ({
            deviceId: localStorage.getItem('stp_device_id') || (localStorage.setItem('stp_device_id', crypto.randomUUID()), localStorage.getItem('stp_device_id')),
            userAgent: navigator.userAgent,
            appVersion: '1.4.5-full-lines'
        });

        window.saveLogToCloud = async (rec) => {
            if (!user) return;
            try {
                const logsCol = collection(db, 'artifacts', appId, 'public', 'data', 'evidencias');
                await addDoc(logsCol, { ...rec, audit: getAuditInfo(), userId: user.uid, timestamp: serverTimestamp() });
                window.showToast("Evidência sincronizada ✓");
            } catch (err) { console.error(err); }
        };
    </script>

    <script>
        lucide.createIcons();

        let audioCtx, analyser, mic, dataArr, animId;
        let isActive = false;
        let currentZone = "Meio";
        let activeSymptoms = [];
        let logs = JSON.parse(localStorage.getItem('sentinela_logs')) || [];
        let lastLog = 0;
        let userStream = null;

        const DB_LIMIT = 85;
        const LOG_WAIT = 10000; 

        const dbDisplay = document.getElementById('db-display');
        const dbComp = document.getElementById('db-comparison');
        const dbBar = document.getElementById('db-progress');
        const mainBtn = document.getElementById('main-btn');
        const stopBtn = document.getElementById('stop-btn');
        const gpsText = document.getElementById('gps-label');
        const tempSlider = document.getElementById('temp-input');
        const tempLabel = document.getElementById('temp-val');
        const logContainer = document.getElementById('log-list');

        window.onload = () => { requestPermissions(); renderRecords(); };

        function openManifesto() { document.getElementById('modal-manifesto').classList.remove('hidden'); document.getElementById('modal-manifesto').classList.add('flex'); }
        function closeManifesto() { document.getElementById('modal-manifesto').classList.add('hidden'); document.getElementById('modal-manifesto').classList.remove('flex'); }

        async function requestPermissions() {
            try {
                userStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false } });
                document.getElementById('mic-dot').className = "status-dot bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.4)]";
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((p) => {
                        document.getElementById('geo-dot').className = "status-dot bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.4)]";
                        gpsText.innerText = `${p.coords.latitude.toFixed(4)}, ${p.coords.longitude.toFixed(4)}`;
                        gpsText.parentElement.classList.remove('opacity-30');
                    }, null, {enableHighAccuracy: true});
                }
            } catch (err) { 
                document.getElementById('mic-dot').className = "status-dot bg-red-500"; 
            }
        }

        function setZone(z) {
            currentZone = z;
            document.querySelectorAll('.zone-btn').forEach(b => b.classList.remove('active-zone'));
            document.getElementById(`zone-${z}`).classList.add('active-zone');
            if(navigator.vibrate) navigator.vibrate(15);
        }

        function toggleSymptom(el, name) {
            el.classList.toggle('active');
            if(el.classList.contains('active')) activeSymptoms.push(name);
            else activeSymptoms = activeSymptoms.filter(s => s !== name);
            if(navigator.vibrate) navigator.vibrate(10);
        }

        tempSlider.oninput = (e) => { tempLabel.innerText = `${e.target.value}°C`; };

        async function start() {
            if(!document.getElementById('bus-line').value) { alert("Identifique a linha primeiro."); return; }
            try {
                if(!userStream) userStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const AC = window.AudioContext || window.webkitAudioContext;
                if (!audioCtx) audioCtx = new AC();
                if (audioCtx.state === 'suspended') await audioCtx.resume();
                analyser = audioCtx.createAnalyser();
                mic = audioCtx.createMediaStreamSource(userStream);
                analyser.fftSize = 256;
                dataArr = new Uint8Array(analyser.frequencyBinCount);
                mic.connect(analyser);
                isActive = true;
                mainBtn.classList.add('hidden'); stopBtn.classList.remove('hidden');
                document.getElementById('status-badge').innerText = "FISCALIZANDO";
                document.getElementById('status-badge').className = "bg-red-600 text-[8px] px-2 py-1 rounded-full border border-red-400 font-black animate-pulse uppercase";
                loop();
            } catch (err) { alert("Erro ao acessar sensores."); }
        }

        function loop() {
            if(!isActive) return;
            analyser.getByteTimeDomainData(dataArr);
            const cv = document.getElementById('audio-visualizer');
            const cctx = cv.getContext('2d');
            cv.width = cv.offsetWidth; cv.height = cv.offsetHeight;
            cctx.clearRect(0,0,cv.width,cv.height);
            cctx.lineWidth = 2; cctx.strokeStyle = '#3b82f6'; cctx.beginPath();
            let slice = cv.width/dataArr.length; let x = 0;
            for(let i=0; i<dataArr.length; i++) {
                let v = dataArr[i]/128.0; let y = v * cv.height/2;
                if(i===0) cctx.moveTo(x,y); else cctx.lineTo(x,y);
                x += slice;
            }
            cctx.stroke();

            let sum = 0; let sig = false;
            for(let i=0; i<dataArr.length; i++) { if(dataArr[i] !== 128) sig = true; let n = (dataArr[i]-128)/128; sum += n*n; }
            let rms = Math.sqrt(sum/dataArr.length);
            let db = sig ? Math.round(20 * Math.log10(rms) + 105) : 30;
            
            dbDisplay.innerText = db;
            dbBar.style.width = `${Math.min(Math.max((db-30)/80*100,0),100)}%`;

            if(db < 60) dbComp.innerText = "Conversa Normal";
            else if(db < 75) dbComp.innerText = "Aspirador de Pó";
            else if(db < 85) dbComp.innerText = "Tráfego Pesado";
            else { dbComp.innerText = "⚠️ Risco à Saúde (Britadeira)"; }

            if(db >= DB_LIMIT) {
                document.getElementById('danger-overlay').style.opacity = "1";
                addRecord(db);
            } else {
                document.getElementById('danger-overlay').style.opacity = "0";
            }
            animId = requestAnimationFrame(loop);
        }

        async function addRecord(db, tipo = "Ruído Elevado") {
            const now = Date.now();
            if(now - lastLog < LOG_WAIT) return;
            lastLog = now;

            const getCurrentLocation = () => {
                return new Promise((resolve) => {
                    navigator.geolocation.getCurrentPosition(
                        (p) => resolve(`${p.coords.latitude.toFixed(5)}, ${p.coords.longitude.toFixed(5)}`),
                        () => resolve(gpsText.innerText),
                        { enableHighAccuracy: true, timeout: 5000 }
                    );
                });
            };

            const coords = await getCurrentLocation();
            const rec = {
                tipo_evento: tipo,
                ruido_db: db,
                temp_interna: tempSlider.value,
                sintomas: activeSymptoms.join(', '),
                linha: document.getElementById('bus-line').value,
                prefixo: document.getElementById('bus-number').value || "S/N",
                zona: currentZone,
                coordenadas: coords,
                hora: new Date().toLocaleTimeString('pt-BR'),
                data: new Date().toLocaleDateString('pt-BR')
            };

            logs.unshift(rec);
            if(logs.length > 50) logs.pop();
            localStorage.setItem('sentinela_logs', JSON.stringify(logs));
            renderRecords();
            if (window.saveLogToCloud) window.saveLogToCloud(rec);
            if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
        }

        async function logSpecialEvent(tipo) {
            if(!document.getElementById('bus-line').value) { alert("Identifique a linha primeiro."); return; }
            await addRecord(dbDisplay.innerText, tipo);
        }

        function renderRecords() {
            const emptyState = document.getElementById('empty-state');
            if(logs.length > 0 && emptyState) emptyState.classList.add('hidden');
            
            logContainer.innerHTML = '';
            logs.slice(0, 15).forEach(l => {
                const item = document.createElement('div');
                item.className = "bg-white p-4 rounded-2xl border-l-8 border-red-500 shadow-sm space-y-2 text-left";
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="space-y-1">
                            <p class="text-[13px] font-black text-slate-800">${l.linha}</p>
                            <div class="flex gap-1.5 flex-wrap">
                                <span class="bg-red-600 text-white text-[8px] font-black px-2 py-0.5 rounded">${l.ruido_db}dB</span>
                                <span class="bg-blue-600 text-white text-[8px] font-black px-2 py-0.5 rounded">#${l.prefixo}</span>
                                ${l.tipo_evento !== "Ruído Elevado" ? `<span class="bg-orange-500 text-white text-[8px] font-black px-2 py-0.5 rounded">${l.tipo_evento}</span>` : ''}
                            </div>
                        </div>
                        <div class="text-[9px] font-black text-slate-400 text-right">${l.hora}</div>
                    </div>
                    ${l.sintomas ? `<p class="text-[8px] font-bold text-blue-600 uppercase tracking-tighter italic">Sintomas: ${l.sintomas}</p>` : ''}
                `;
                logContainer.appendChild(item);
            });
            const btnCsv = document.getElementById('btn-csv');
            if(btnCsv) btnCsv.classList.toggle('hidden', logs.length === 0);
        }

        function downloadCSV() {
            let c = "Tipo,dB,Temp,Linha,Prefixo,Zona,Sintomas,Localizacao,Hora,Data\n";
            logs.forEach(l => c += `"${l.tipo_evento}",${l.ruido_db},${l.temp_interna},"${l.linha}","${l.prefixo}","${l.zona}","${l.sintomas}","${l.coordenadas}","${l.hora}","${l.data}"\n`);
            const b = new Blob([c], {type:'text/csv'});
            const u = window.URL.createObjectURL(b);
            const a = document.createElement('a'); a.href = u; a.download = `STP_AUDITORIA.csv`; a.click();
        }

        function stop() {
            isActive = false; cancelAnimationFrame(animId);
            if(audioCtx) audioCtx.suspend();
            stopBtn.classList.add('hidden'); mainBtn.classList.remove('hidden');
            dbDisplay.innerText = "0"; dbBar.style.width = "0%";
            document.getElementById('status-badge').innerText = "Inativo";
            document.getElementById('status-badge').className = "bg-blue-900/40 text-[8px] px-2 py-1 rounded-full border border-white/20 font-bold uppercase tracking-widest";
        }

        mainBtn.onclick = start;
        stopBtn.onclick = stop;
    </script>
</body>
</html>